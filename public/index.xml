<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>ä¸¸å­æœ‰è®°</title>
    <link>https://wnote.com/</link>
    <description>Recent content on ä¸¸å­æœ‰è®°</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>zh-cn</language>
    <lastBuildDate>Mon, 20 Aug 2018 21:38:52 +0800</lastBuildDate>
    
        <atom:link href="https://wnote.com/index.xml" rel="self" type="application/rss+xml" />
    
    
    <item>
      <title>about</title>
      <link>https://wnote.com/about/</link>
      <pubDate>Mon, 20 Aug 2018 21:38:52 +0800</pubDate>
      
      <guid>https://wnote.com/about/</guid>
      
        <description>&lt;h2 id=&#34;å…³äºæˆ‘&#34;&gt;å…³äºæˆ‘&lt;/h2&gt;
&lt;p&gt;æˆ‘çš„ç½‘å&amp;quot;ä¸¸å­è¯´&amp;rdquo;, ç›®å‰åœ¨ä¸€å®¶äººå·¥æ™ºèƒ½å…¬å¸æ‹…ä»»DevOpsï¼Œä¸šä½™æ—¶é—´å–œæ¬¢çœ‹çœ‹ä¹¦ã€å†™å†™åšå®¢, å–œæ¬¢ä»¥åšä¼šå‹ã€‚&lt;/p&gt;
&lt;h2 id=&#34;å…³äºæœ¬ç«™&#34;&gt;å…³äºæœ¬ç«™&lt;/h2&gt;
&lt;p&gt;è¿™ä¸ªç«™ç‚¹çš„åŸŸåæ˜¯ &lt;code&gt;wnote.com&lt;/code&gt; ï¼Œwå¯“æ„â€œä¸¸å­â€ï¼Œå› æ­¤wnoteå¯ä»¥ç†è§£ä¸ºä¸¸å­æœ‰è®°ï¼Œæœ‰å¿†å¯è®°.&lt;/p&gt;
&lt;h2 id=&#34;ä¸¸å­æ—¥å¸¸&#34;&gt;ä¸¸å­æ—¥å¸¸&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;ä¸»åŠ›æ“ä½œç³»ç»Ÿ&lt;/strong&gt; â€”â€” &lt;strong&gt;Mac&amp;amp;&amp;amp;Linux&lt;/strong&gt; , å–œæ¬¢Macéšæ—¶éšåœ°æ•²æ‰“å‘½ä»¤ã€å†™ä»£ç æ„Ÿè§‰ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ç¼–è¾‘å™¨&lt;/strong&gt; â€”â€” &lt;strong&gt;Vim&amp;amp;&amp;amp;VsCode&amp;amp;&amp;amp;Goland&lt;/strong&gt; ï¼Œvimæ˜¯Linuxæ–‡æœ¬ç¼–è¾‘æ ‡é…ï¼ŒVsCodeæˆ‘ä¸»è¦è¿›è¡Œå‰ç«¯å’ŒPythonè„šæœ¬è°ƒè¯•ï¼ŒGolandå¼€å‘åç«¯é¡¹ç›®&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ç¼–ç¨‹è¯­è¨€&lt;/strong&gt; â€”â€” ç†Ÿæ‚‰ç¨‹åº¦ç”±é«˜åˆ°ä½ &lt;code&gt;shell&lt;/code&gt;, &lt;code&gt;Python&lt;/code&gt;, &lt;code&gt;Golang&lt;/code&gt;, &lt;code&gt;Html/Css/Js&lt;/code&gt; ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;é”®ç›˜&lt;/strong&gt; â€”â€” Cherry G80 çº¢è½´&lt;/li&gt;
&lt;/ul&gt;
</description>
      
    </item>
    
    <item>
      <title>Argo Worflowå®è·µä¸€å®‰è£…éƒ¨ç½²</title>
      <link>https://wnote.com/post/cicd-argo-workflow-install-in-k8s/</link>
      <pubDate>Fri, 07 May 2021 16:22:42 +0800</pubDate>
      
      <guid>https://wnote.com/post/cicd-argo-workflow-install-in-k8s/</guid>
      
        <description>&lt;h2 id=&#34;ç®€ä»‹æ¶æ„&#34;&gt;ç®€ä»‹&amp;amp;æ¶æ„&lt;/h2&gt;
&lt;p&gt;Argo Workflowsæ˜¯ä¸€ä¸ªå¼€æºå®¹å™¨çº§åˆ«å·¥ä½œæµå¼•æ“ï¼Œç”¨äºåœ¨Kubernetesä¸Šåè°ƒå¹¶è¡Œä½œä¸šã€‚ Argo Workflowsé€šè¿‡æŠ½è±¡Kubernetes CRDï¼ˆè‡ªå®šä¹‰èµ„æºå®šä¹‰ï¼‰æ¥å®ç°æ•´ä¸ªæ¶æ„åŠŸèƒ½ï¼Œæ¯”å¦‚Workflow Templateã€Workflowã€Cron Workflowã€‚&lt;/p&gt;
&lt;p&gt;Argo workflowèƒ½åšä»€ä¹ˆï¼Ÿ&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å®šä¹‰å·¥ä½œæµï¼Œå·¥ä½œæµä¸­çš„æ¯ä¸ªæ­¥éª¤éƒ½æ˜¯ä¸€ä¸ªå®¹å™¨ã€‚&lt;/li&gt;
&lt;li&gt;å°†å¤šæ­¥éª¤å·¥ä½œæµå»ºæ¨¡ä¸ºä¸€ç³»åˆ—ä»»åŠ¡ï¼Œæˆ–è€…ä½¿ç”¨æœ‰å‘æ— ç¯å›¾ï¼ˆDAGï¼‰æ•è·ä»»åŠ¡ä¹‹é—´çš„ä¾å­˜å…³ç³»ã€‚&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨Kubernetesä¸Šçš„ArgoWorkflowï¼Œå¯ä»¥åœ¨çŸ­æ—¶é—´å†…è½»æ¾è¿è¡Œç”¨äºè®¡ç®—æœºå­¦ä¹ æˆ–æ•°æ®å¤„ç†çš„è®¡ç®—å¯†é›†å‹ä½œä¸šã€‚&lt;/li&gt;
&lt;li&gt;æ— éœ€é…ç½®å¤æ‚çš„è½¯ä»¶å¼€å‘äº§å“ï¼Œå³å¯åœ¨Kubernetesä¸Šæœ¬åœ°è¿è¡ŒCI / CDç®¡é“ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Argo workflowæœ‰å“ªäº›åŠŸèƒ½?&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Workflow ï¼šè°ƒç”¨å¤šä¸ªå·¥ä½œæµæ¨¡ç‰ˆè¿›è¡Œä»»åŠ¡ç¼–æ’ï¼Œé€šè¿‡ä¸åŒé¡ºåºæ¥æ‰§è¡Œï¼Œ&lt;/li&gt;
&lt;li&gt;Workflow Templateï¼šWorkflowçš„æ¨¡ç‰ˆï¼Œæ˜¯å¯¹workflowçš„ä¸€ç§å®šä¹‰ï¼Œå› æ­¤workflow templateå†…éƒ¨æˆ–è€…é›†ç¾¤å…¶ä»–workflowå’Œworkflow templateéƒ½å¯ä»¥è°ƒç”¨ã€‚&lt;/li&gt;
&lt;li&gt;Cluster Workflow Templateï¼šé›†ç¾¤çº§åˆ«Workflow Templateï¼Œé€šè¿‡clusterroleè§’è‰²æˆæƒå¯ä»¥è®¿é—®é›†ç¾¤æ‰€æœ‰namespace&lt;/li&gt;
&lt;li&gt;Cron Wrokflowï¼šä»»åŠ¡è®¡åˆ’ç±»å‹å·¥ä½œæµï¼Œç›¸å½“äºé«˜çº§ç‰ˆçš„k8s cronjobã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;å®‰è£…é…ç½®&#34;&gt;å®‰è£…é…ç½®&lt;/h2&gt;
&lt;h3 id=&#34;å®‰è£…argo-workflow&#34;&gt;å®‰è£…argo workflow&lt;/h3&gt;
&lt;p&gt;è¿™é‡Œæˆ‘ä»¬å®‰è£…çš„ç¨³å®šç‰ˆæœ¬2.12.10ï¼Œæ•´ä¸ªå®‰è£…è¿‡ç¨‹ä¼šé…ç½®service accountã€roleã€ClusterRoleã€deploymentç­‰&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl create ns argo
kubectl apply -n argo -f https://raw.githubusercontent.com/argoproj/argo/v2.12.10/manifests/install.yaml
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;è®¾ç½®ingressé›†ç¾¤å¤–éƒ¨è®¿é—®&#34;&gt;è®¾ç½®Ingressé›†ç¾¤å¤–éƒ¨è®¿é—®&lt;/h3&gt;
&lt;p&gt;ç”±äºæˆ‘ä»¬çš„é›†ç¾¤ç¯å¢ƒingress controlleré‡‡ç”¨çš„æ˜¯traefikï¼Œè€Œargo workflowé»˜è®¤å†…éƒ¨è®¿é—®çš„æ–¹å¼æ˜¯é€šè¿‡httpsè®¿é—®ï¼Œå› æ­¤æˆ‘è¿™é‡Œåªæœ‰æ·»åŠ ç›¸å…³æ³¨è§£(annotations)æ‰èƒ½è½¬å‘è¯·æ±‚åˆ°argo-server&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  annotations:
    kubernetes.io/ingress.class: traefik
    traefik.ingress.kubernetes.io/redirect-entry-point: https
  name: argo-server
  namespace: argo
spec:
  rules:
  - host: argo.test.cn
    http:
      paths:
      - backend:
          serviceName: argo-server
          servicePort: web
        path: /
status:
  loadBalancer: {}
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;é›†ç¾¤å¤–éƒ¨è®¿é—®ï¼šhttps://argo.test.cn&lt;/p&gt;
&lt;h2 id=&#34;workflowç®€å•æµ‹è¯•&#34;&gt;workflowç®€å•æµ‹è¯•&lt;/h2&gt;
&lt;p&gt;è¿™é‡Œæˆ‘ä»¬ä»¥hello worldä¸ºä¾‹å­æµ‹è¯•ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# argo submit -n argo --watch https://raw.githubusercontent.com/argoproj/argo-workflows/master/examples/hello-world.yaml
Name:                hello-world-4mffd
Namespace:           argo
ServiceAccount:      default
Status:              Pending
Created:             Fri May 07 16:11:25 +0800 (now)
Name:                hello-world-4mffd
Namespace:           argo
ServiceAccount:      default
Status:              Pending
Created:             Fri May 07 16:11:25 +0800 (now)
Name:                hello-world-4mffd
Namespace:           argo
ServiceAccount:      default
Status:              Running
Created:             Fri May 07 16:11:25 +0800 (now)
Started:             Fri May 07 16:11:25 +0800 (now)
Duration:            0 seconds

STEP                  TEMPLATE  PODNAME            DURATION  MESSAGE
 â—· hello-world-4mffd  whalesay  hello-world-4mffd  0s
Name:                hello-world-4mffd
Namespace:           argo
ServiceAccount:      default
Status:              Running
Created:             Fri May 07 16:11:25 +0800 (10 seconds ago)
Started:             Fri May 07 16:11:25 +0800 (10 seconds ago)
Duration:            10 seconds

STEP                  TEMPLATE  PODNAME            DURATION  MESSAGE
 â—· hello-world-4mffd  whalesay  hello-world-4mffd  10s       ContainerCreating
Name:                hello-world-4mffd
Namespace:           argo
ServiceAccount:      default
Status:              Succeeded
Conditions:
 Completed           True
Created:             Fri May 07 16:11:25 +0800 (2 minutes ago)
Started:             Fri May 07 16:11:25 +0800 (2 minutes ago)
Finished:            Fri May 07 16:14:18 +0800 (now)
Duration:            2 minutes 53 seconds
ResourcesDuration:   1m18s*cpu,1m18s*memory

STEP                  TEMPLATE  PODNAME            DURATION  MESSAGE
 âœ” hello-world-4mffd  whalesay  hello-world-4mffd  2m

# argo list -n argo
NAME                STATUS      AGE   DURATION   PRIORITY
hello-world-4mffd   Succeeded   3m    2m         0

# argo logs -f hello-world-4mffd -n argo
hello-world-4mffd:  _____________
hello-world-4mffd: &amp;lt; hello world &amp;gt;
hello-world-4mffd:  -------------
hello-world-4mffd:     \
hello-world-4mffd:      \
hello-world-4mffd:       \
hello-world-4mffd:                     ##        .
hello-world-4mffd:               ## ## ##       ==
hello-world-4mffd:            ## ## ## ##      ===
hello-world-4mffd:        /&amp;quot;&amp;quot;&amp;quot;&amp;quot;&amp;quot;&amp;quot;&amp;quot;&amp;quot;&amp;quot;&amp;quot;&amp;quot;&amp;quot;&amp;quot;&amp;quot;&amp;quot;&amp;quot;___/ ===
hello-world-4mffd:   ~~~ {~~ ~~~~ ~~~ ~~~~ ~~ ~ /  ===- ~~~
hello-world-4mffd:        \______ o          __/
hello-world-4mffd:         \    \        __/
hello-world-4mffd:           \____\______/
&lt;/code&gt;&lt;/pre&gt;</description>
      
    </item>
    
    <item>
      <title>Gitlab runneré…ç½®ceph s3</title>
      <link>https://wnote.com/post/cicd-gitlab-runner-ceph-s3/</link>
      <pubDate>Fri, 26 Mar 2021 17:22:42 +0800</pubDate>
      
      <guid>https://wnote.com/post/cicd-gitlab-runner-ceph-s3/</guid>
      
        <description>&lt;blockquote&gt;
&lt;p&gt;å¯¹äºå‰ç«¯é¡¹ç›®Npmæ„å»ºçš„æ—¶å€™ï¼Œç»å¸¸æ‹‰å–å‰ç«¯åº“è€—æ—¶æ¯”è¾ƒé•¿ï¼Œå¦å¤–ä¸åŒçš„jobä¹‹é—´å¤ç”¨ä¹Ÿæ˜¯ä¸€ä¸ªé—®é¢˜ï¼Œæ— è®ºæ˜¯artifactsæˆ–è€…cacheæœ€ç»ˆæˆ‘ä»¬éœ€è¦æŒä¹…åŒ–å¤ç”¨æ–‡ä»¶ï¼Œè¿™é‡Œæˆ‘ä»¬ä»¥cacheä¸ºä¾‹&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;æ³¨æ„ï¼šè¿™é‡Œçš„Gitlab runneræ˜¯é‡‡ç”¨helm chartæ–¹å¼éƒ¨ç½²åˆ°k8sé›†ç¾¤ï¼Œrunneréƒ¨ç½²å¿½ç•¥ï¼›éœ€è¦æå‰å‡†å¤‡ceph s3çš„å¯†é’¥å¯¹ï¼Œç”¨äºé…ç½®accesskeyå’Œsecretkey&lt;/p&gt;
&lt;h2 id=&#34;åˆ›å»ºk8s-secret&#34;&gt;åˆ›å»ºk8s secret&lt;/h2&gt;
&lt;p&gt;ç»™åè¾¹Gitlab Runnerè¿æ¥ceph s3ä½¿ç”¨ã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
data:
  accesskey: N1NMT0hIRzYxddfsgxVzVssddfsdY=
  secretkey: d25Uc0NDQVdsfsdUkssCQ1VsdEwxeUsdsNwb2R4TnRzZDliTG1DTUN6cQ==
kind: Secret
metadata:
  name: gitlab-runner-s3
  namespace: gitlab-managed-apps
type: Opaque
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;helméƒ¨ç½²gitlab-runner&#34;&gt;helméƒ¨ç½²gitlab runner&lt;/h2&gt;
&lt;p&gt;å…·ä½“Gitlab helm chartå‚è€ƒï¼šhttps://gitlab.com/gitlab-org/charts/gitlab-runner.gitï¼Œä¿®æ”¹helm chartç›®å½•ä¸‹values.yamlå†…å®¹å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;cache:
  ## General settings
  cacheType: s3
  cachePath: &amp;quot;devops&amp;quot; #æŒ‡å®šceph s3ç¼“å­˜è·¯å¾„ï¼Œè¿™é‡Œæˆ‘ä»¬ä»¥éƒ¨é—¨æ¥åŒºåˆ†
  cacheShared: true
   
  ## S3 settings
  s3ServerAddress: &amp;quot;ops-rgw.test.cn&amp;quot;
  s3BucketName: &amp;quot;runners-cache&amp;quot;
  s3BucketLocation:
  s3CacheInsecure: true
  secretName: &amp;quot;gitlab-runner-s3&amp;quot;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;æ›´æ–°helmé…ç½®&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;cd gitlab-runner
helm upgrade   runner-devops -f values.yaml -n gitlab-runner .
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;æµ‹è¯•gitlab-ciä»»åŠ¡&#34;&gt;æµ‹è¯•gitlab CIä»»åŠ¡&lt;/h2&gt;
&lt;p&gt;é…ç½®gitlab Ciï¼Œä¿®æ”¹.gitlab-ci.yamlï¼Œè¿™é‡Œä»¥å‰ç«¯é¡¹ç›®æ„å»ºä¸ºä¾‹ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;stages:
  - Build
   
build-and-deploy:
  image: registry.test.cn/devops/node:latest
  stage: Build
  cache:
    key: devops-vue
    paths:
      - node_modules/
      - .yarn
  tags:
    - devopstest
  script:
    - yarn config set registry https://r.cnpmjs.org
    - yarn config set @test:registry https://npm.test.cn/
    - yarn --pure-lockfile --cache-folder .yarn --network-timeout 600000
    - yarn build
  when: always
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Gitlab CIè§¦å‘æ„å»ºä»»åŠ¡ä»¥åï¼Œæˆ‘ä»¬è§‚å¯ŸJOBæ„å»ºä»»åŠ¡å®æ—¶æƒ…å†µï¼Œè¿™æ—¶ç¼“å­˜æ–‡ä»¶å·²ç»ä¸Šä¼ åˆ°ceph s3ï¼ŒåæœŸå†æ„å»ºç¼–è¯‘å°±å¤§å¤§æé«˜äº†æ•ˆç‡ï¼&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;64 Creating cache devops-vue-4...
65 node_modules/: found 30710 matching files and directories
66 .yarn: found 34390 matching files and directories 
67 Uploading cache.zip to https://ops-rgw.test.cn/runners-cache/devops/project/4187/devops-vue-js-starter-4
68 Created cache
70Cleaning up file based variables
00:00
72 Job succeeded
&lt;/code&gt;&lt;/pre&gt;</description>
      
    </item>
    
    <item>
      <title>terraformè‡ªåŠ¨åŒ–åˆ›å»ºECS</title>
      <link>https://wnote.com/post/devops-terraform-create-aliyun-ecs/</link>
      <pubDate>Fri, 26 Feb 2021 17:22:42 +0800</pubDate>
      
      <guid>https://wnote.com/post/devops-terraform-create-aliyun-ecs/</guid>
      
        <description>&lt;h2 id=&#34;å¿«é€Ÿåˆ›å»ºä¸€å°é˜¿é‡Œäº‘ecsä¸»æœº&#34;&gt;å¿«é€Ÿåˆ›å»ºä¸€å°é˜¿é‡Œäº‘ECSä¸»æœº&lt;/h2&gt;
&lt;h3 id=&#34;æŒ‡å®šterraformç‰ˆæœ¬&#34;&gt;æŒ‡å®šterraformç‰ˆæœ¬&lt;/h3&gt;
&lt;p&gt;è¿™é‡Œæˆ‘ä»¬æŒ‡å®šäº†é˜¿é‡Œäº‘providerç‰ˆæœ¬ä¿¡æ¯ï¼Œå¹¶è®¾ç½®äº†terraformçš„ç‰ˆæœ¬è¦æ±‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# mkdir aliyun-ecs-one &amp;amp;&amp;amp; cd aliyun-ecs-one
# touch versions.tf
# vim versions.tf
 terraform {
  required_providers {
    alicloud = {
      source  = &amp;quot;aliyun/alicloud&amp;quot;
      version = &amp;quot;1.115.1&amp;quot;
    }
  }

  required_version = &amp;quot;&amp;gt;= 0.12&amp;quot;
}
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;é…ç½®å˜é‡&#34;&gt;é…ç½®å˜é‡&lt;/h3&gt;
&lt;p&gt;è¿™é‡Œä¸»è¦æŒ‡å®šå¯†é’¥å¯¹ã€äº‘regionã€ECSè´¦æˆ·å’Œé•œåƒä¿¡æ¯&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# vim variables.tf
# é˜¿é‡Œäº‘å­è´¦æˆ·access_key
variable &amp;quot;alicloud_access_key&amp;quot; {
  default     = &amp;quot;LTAI4GBXXXXXXXXXXXXXXXXXXXXXX&amp;quot;
  description = &amp;quot;The Alicloud Access Key ID to launch resources. Support to environment &#39;ALICLOUD_ACCESS_KEY&#39;.&amp;quot;
}

# é˜¿é‡Œäº‘å­è´¦æˆ·secret_key
variable &amp;quot;alicloud_secret_key&amp;quot; {
  default     = &amp;quot;4Z4gbl3dXXXXXXXXXXXXXXXXXXXXX&amp;quot;
  description = &amp;quot;The Alicloud Access Secret Key to launch resources.  Support to environment &#39;ALICLOUD_SECRET_KEY&#39;.&amp;quot;
}

# é˜¿é‡Œäº‘åŒºåŸŸï¼Œè¿™é‡Œä¸ºæ­å·åœ°åŒº
variable &amp;quot;region&amp;quot; {
  default     = &amp;quot;cn-hangzhou&amp;quot;
  description = &amp;quot;The Alicloud region resources.  Support to environment &#39;REGION&#39;.&amp;quot;
}

# è®¾ç½®é˜¿é‡Œäº‘æ­å·åŒºåŸŸå¯ç”¨æœºæˆ¿ï¼Œè¿™é‡Œè®¾ç½®ä¸ºcn-hangzhou-i
variable &amp;quot;availability_zone&amp;quot; {
  description = &amp;quot;The available zone to launch ecs instance and other resources.&amp;quot;
  default     = &amp;quot;cn-hangzhou-i&amp;quot;
}

# è®¾ç½®é•œåƒç‰ˆæœ¬
variable &amp;quot;image_id&amp;quot; {
  default = &amp;quot;ubuntu_18_04_64_20G_alibase_20190624.vhd&amp;quot;
}

# è®¾ç½®ECSå®ä¾‹ç±»å‹ï¼Œå¯¹äº
variable &amp;quot;ecs_type&amp;quot; {
  default = &amp;quot;ecs.s6-c1m2.small&amp;quot;
}

# æŒ‡å®šECSå®ä¾‹å¯†ç 
variable &amp;quot;ecs_password&amp;quot; {
  default = &amp;quot;Test12345&amp;quot;
}

# æŒ‡å®šECSå®ä¾‹ç£ç›˜ç±»å‹ï¼Œè¿™é‡Œä¸ºæ™®é€šäº‘ç›˜
variable &amp;quot;disk_category&amp;quot; {
  default = &amp;quot;cloud_efficiency&amp;quot;
}

# è®¾ç½®ç£ç›˜å¤§å°
variable &amp;quot;disk_size&amp;quot; {
  default = &amp;quot;40&amp;quot;
}

# è®¾ç½®ä¸Šç½‘æ‰£è´¹æ³ªè¡Œï¼Œé»˜è®¤ä¸ºPayByTrafficï¼ˆæŒ‰æµé‡è®¡è´¹ï¼‰
variable &amp;quot;internet_charge_type&amp;quot; {
  default = &amp;quot;PayByTraffic&amp;quot;
}

# å…¬å…±ç½‘ç»œæœ€å¤§ä¼ å‡ºå¸¦å®½ï¼Œä»1.7ç‰ˆæœ¬ï¼Œé»˜è®¤è®¾ç½®å¤§äº0ä¼šè‡ªåŠ¨ç”³è¯·ç‹¬äº«å…¬ç½‘IPåœ°å€
variable &amp;quot;internet_max_bandwidth_out&amp;quot; {
  default = 5
}
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;é…ç½®å®ä¾‹ç›¸å…³èµ„æº&#34;&gt;é…ç½®å®ä¾‹ç›¸å…³èµ„æº&lt;/h3&gt;
&lt;p&gt;è¿™é‡Œç”±äºæ˜¯æµ‹è¯•ï¼Œåˆ›å»ºå®ä¾‹éœ€è¦æå‰åˆ›å»ºvpcï¼Œvswitchï¼Œå®‰å…¨ç»„ï¼Œå®‰å…¨ç»„è§„åˆ™&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# vim main.tf
provider &amp;quot;alicloud&amp;quot; {
  region     = var.region
  access_key = var.alicloud_access_key
  secret_key = var.alicloud_secret_key
}

resource &amp;quot;alicloud_vpc&amp;quot; &amp;quot;vpc&amp;quot; {
  name       = &amp;quot;tf_test_foo&amp;quot;
  cidr_block = &amp;quot;10.100.0.0/16&amp;quot;
}

resource &amp;quot;alicloud_vswitch&amp;quot; &amp;quot;vsw&amp;quot; {
  vpc_id            = alicloud_vpc.vpc.id
  cidr_block        = &amp;quot;10.100.0.0/24&amp;quot;
  availability_zone = var.availability_zone
}

resource &amp;quot;alicloud_security_group&amp;quot; &amp;quot;default&amp;quot; {
  name   = &amp;quot;default&amp;quot;
  vpc_id = alicloud_vpc.vpc.id
}

resource &amp;quot;alicloud_security_group_rule&amp;quot; &amp;quot;allow_all_tcp&amp;quot; {
  type              = &amp;quot;ingress&amp;quot;
  ip_protocol       = &amp;quot;tcp&amp;quot;
  nic_type          = &amp;quot;intranet&amp;quot;
  policy            = &amp;quot;accept&amp;quot;
  port_range        = &amp;quot;1/65535&amp;quot;
  priority          = 1
  security_group_id = alicloud_security_group.default.id
  cidr_ip           = &amp;quot;0.0.0.0/0&amp;quot;
}

resource &amp;quot;alicloud_instance&amp;quot; &amp;quot;wanzi_test&amp;quot; {
  # cn-hangzhou
  availability_zone = var.availability_zone
  security_groups   = alicloud_security_group.default.*.id

  instance_type        = var.ecs_type
  system_disk_category = var.disk_category
  image_id             = var.image_id
  instance_name        = &amp;quot;wanzi_tf001&amp;quot;
  vswitch_id           = alicloud_vswitch.vsw.id
  password             = var.ecs_password
}
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;æ‰§è¡Œplanï¼Œæ¨¡æ‹Ÿæ‰§è¡Œæ•ˆæœ&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# terraform  plan

An execution plan has been generated and is shown below.
Resource actions are indicated with the following symbols:
  + create

Terraform will perform the following actions:

  # alicloud_instance.wanzi_test will be created
  + resource &amp;quot;alicloud_instance&amp;quot; &amp;quot;wanzi_test&amp;quot; {
      + availability_zone             = &amp;quot;cn-hangzhou-i&amp;quot;
      + credit_specification          = (known after apply)
      + deletion_protection           = false
      + dry_run                       = false
      + host_name                     = (known after apply)
      + id                            = (known after apply)
      + image_id                      = &amp;quot;ubuntu_18_04_64_20G_alibase_20190624.vhd&amp;quot;
      + instance_charge_type          = &amp;quot;PostPaid&amp;quot;
      + instance_name                 = &amp;quot;wanzi_tf001&amp;quot;
      + instance_type                 = &amp;quot;ecs.s6-c1m2.small&amp;quot;
      + internet_max_bandwidth_in     = (known after apply)
      + internet_max_bandwidth_out    = 0
      + key_name                      = (known after apply)
      + password                      = (sensitive value)
      + private_ip                    = (known after apply)
      + public_ip                     = (known after apply)
      + role_name                     = (known after apply)
      + security_groups               = (known after apply)
      + spot_strategy                 = &amp;quot;NoSpot&amp;quot;
      + status                        = &amp;quot;Running&amp;quot;
      + subnet_id                     = (known after apply)
      + system_disk_category          = &amp;quot;cloud_efficiency&amp;quot;
      + system_disk_performance_level = (known after apply)
      + system_disk_size              = 40
      + volume_tags                   = (known after apply)
      + vswitch_id                    = (known after apply)
    } 

&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;åˆ›å»ºäº‘ä¸»æœº, è¿™ä¸ªè¿‡ç¨‹ä¼šè¯·æ±‚é˜¿é‡Œäº‘APIå¹¶åœ¨æœ¬åœ°ç”Ÿæˆterraform stateæ–‡ä»¶&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# terraform apply
An execution plan has been generated and is shown below.
Resource actions are indicated with the following symbols:
  + create

Terraform will perform the following actions:

  # alicloud_instance.wanzi_test will be created
  + resource &amp;quot;alicloud_instance&amp;quot; &amp;quot;wanzi_test&amp;quot; {
      + availability_zone             = &amp;quot;cn-hangzhou-i&amp;quot;
      + credit_specification          = (known after apply)
      + deletion_protection           = false
      + dry_run                       = false
      + host_name                     = (known after apply)
      + id                            = (known after apply)
      + image_id                      = &amp;quot;ubuntu_18_04_64_20G_alibase_20190624.vhd&amp;quot;
      + instance_charge_type          = &amp;quot;PostPaid&amp;quot;
      + instance_name                 = &amp;quot;wanzi_tf001&amp;quot;
      + instance_type                 = &amp;quot;ecs.s6-c1m2.small&amp;quot;
      + internet_max_bandwidth_in     = (known after apply)
      + internet_max_bandwidth_out    = 0
      + key_name                      = (known after apply)
      + password                      = (sensitive value)
      + private_ip                    = (known after apply)
      + public_ip                     = (known after apply)
      + role_name                     = (known after apply)
      + security_groups               = (known after apply)
      + spot_strategy                 = &amp;quot;NoSpot&amp;quot;
      + status                        = &amp;quot;Running&amp;quot;
      + subnet_id                     = (known after apply)
      + system_disk_category          = &amp;quot;cloud_efficiency&amp;quot;
      + system_disk_performance_level = (known after apply)
      + system_disk_size              = 40
      + volume_tags                   = (known after apply)
      + vswitch_id                    = (known after apply)
    }

  # alicloud_security_group.default will be created
  + resource &amp;quot;alicloud_security_group&amp;quot; &amp;quot;default&amp;quot; {
      + id                  = (known after apply)
      + inner_access        = (known after apply)
      + inner_access_policy = (known after apply)
      + name                = &amp;quot;default&amp;quot;
      + security_group_type = &amp;quot;normal&amp;quot;
      + vpc_id              = (known after apply)
    }
......
......
Plan: 5 to add, 0 to change, 0 to destroy.

Do you want to perform these actions?
  Terraform will perform the actions described above.
  Only &#39;yes&#39; will be accepted to approve.

  Enter a value: yes

alicloud_vpc.vpc: Creating...
alicloud_vpc.vpc: Creation complete after 9s [id=vpc-bp1kulcyygsi727aay4hd]
alicloud_security_group.default: Creating...
alicloud_vswitch.vsw: Creating...
alicloud_security_group.default: Creation complete after 1s [id=sg-bp11s5pka9pxtj6pn4xq]
alicloud_security_group_rule.allow_all_tcp: Creating...
alicloud_security_group_rule.allow_all_tcp: Creation complete after 1s [id=sg-bp11s5pka9pxtj6pn4xq:ingress:tcp:1/65535:intranet:0.0.0.0/0ğŸ‰‘1]
alicloud_vswitch.vsw: Creation complete after 4s [id=vsw-bp1wgpgz9z8y2lfsl2beo]
alicloud_instance.wanzi_test: Creating...
alicloud_instance.wanzi_test: Still creating... [10s elapsed]
alicloud_instance.wanzi_test: Still creating... [20s elapsed]
alicloud_instance.wanzi_test: Creation complete after 22s [id=i-bp1gt9mb9asadff9r2zr]

Apply complete! Resources: 5 added, 0 changed, 0 destroyed.    
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;é€šè¿‡ä»¥ä¸Šæ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºå·²ç»å®Œæˆèµ„æºçš„åˆ›å»ºï¼Œè¿™ä¸ªè¿‡ç¨‹å½“å‰ç›®å½•ä¹Ÿä¼šç”Ÿæˆå¯¹åº”tfstateæ–‡ä»¶ï¼Œè¿™ä¸ªæ•°æ®éå¸¸é‡è¦ï¼Œåƒä¸‡ä¸è¦åˆ é™¤ã€‚
å¦å¤–ï¼Œåç»­å¯ä»¥é€šè¿‡terraform showæŸ¥çœ‹æˆ‘ä»¬åˆ›å»ºèµ„æºæ•°æ®ä¿¡æ¯ã€‚&lt;/p&gt;
&lt;h2 id=&#34;æ‰¹é‡åˆ›å»ºå¤šå°ecsäº‘ä¸»æœº&#34;&gt;æ‰¹é‡åˆ›å»ºå¤šå°ECSäº‘ä¸»æœº&lt;/h2&gt;
&lt;h3 id=&#34;é…ç½®module&#34;&gt;é…ç½®Module&lt;/h3&gt;
&lt;p&gt;ç”±äºhttps://registry.terraform.io/ä¸Šå·²ç»æœ‰å¾ˆå¤šä¼˜ç§€çš„æ¨¡å—ï¼Œæˆ‘ä»¬è¿™é‡Œç›´æ¥æ‹¿æ¥alibaba/ecs-instance/alicloudè¿™ä¸ªmoduleè¿›è¡Œæ“ä½œå³å¯ã€‚&lt;/p&gt;
&lt;p&gt;æ›´å¤šå…³äºå®˜æ–¹ECS moduleå‚è€ƒè¿™é‡Œï¼šhttps://github.com/terraform-alicloud-modules/terraform-alicloud-ecs-instance&lt;/p&gt;
&lt;p&gt;è¿™é‡Œvariables.tfå’Œversions.tfé…ç½®è¿˜æ˜¯åŸºäºç¬¬ä¸€æ­¥é…ç½®ï¼›è¿™é‡Œæˆ‘ä»¬åœ¨main.tfå¢åŠ moduleèµ„æºæ‰¹é‡åˆ›å»ºECSé…ç½®ï¼Œå¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;module &amp;quot;tf-instances&amp;quot; {
 source                      = &amp;quot;alibaba/ecs-instance/alicloud&amp;quot;
 region                      = &amp;quot;cn-hangzhou&amp;quot;
 number_of_instances         = &amp;quot;3&amp;quot;
 vswitch_id                  = alicloud_vswitch.vsw.id
 group_ids                   = [alicloud_security_group.default.id]
 private_ips                 = [&amp;quot;10.100.0.10&amp;quot;, &amp;quot;10.100.0.11&amp;quot;, &amp;quot;10.100.0.12&amp;quot;]
 image_ids                   = [&amp;quot;ubuntu_18_04_64_20G_alibase_20190624.vhd&amp;quot;]
 instance_type               = var.ecs_type
 internet_max_bandwidth_out  = 10
 associate_public_ip_address = true
 instance_name               = &amp;quot;my_module_instances_&amp;quot;
 host_name                   = &amp;quot;wanzi-cluster&amp;quot;
 internet_charge_type        = &amp;quot;PayByTraffic&amp;quot;
 password                    = var.ecs_password
 system_disk_category        = &amp;quot;cloud_ssd&amp;quot;
 data_disks = [
  {
    disk_category = &amp;quot;cloud_ssd&amp;quot;
    disk_name     = &amp;quot;my_module_disk&amp;quot;
    disk_size     = &amp;quot;50&amp;quot;
  }
 ]
}
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;è¿™é‡Œéœ€è¦æ³¨æ„é»˜è®¤æƒ…å†µä¸‹ï¼Œinternet_max_bandwidth_outé…ç½®ä»¥åï¼Œä¼šè‡ªåŠ¨ç”³è¯·ä¸€ä¸ªç‹¬äº«å…¬ç½‘IPåœ°å€ï¼Œå¯¹äºæ²¡æœ‰è¿™ä¸ªéœ€æ±‚çš„ï¼Œå¯ä»¥ä¸ç”¨é…ç½®ã€‚&lt;/p&gt;
&lt;h3 id=&#34;æ‰¹é‡åˆ›å»ºèµ„æº&#34;&gt;æ‰¹é‡åˆ›å»ºèµ„æº&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;âœ terraform apply
alicloud_vpc.vpc: Refreshing state... [id=vpc-bp1kulcyygsi727aay4hd]
alicloud_vswitch.vsw: Refreshing state... [id=vsw-bp1wgpgz9z8y2lfsl2beo]
alicloud_security_group.default: Refreshing state... [id=sg-bp11s5pka9pxtj6pn4xq]
alicloud_security_group_rule.allow_all_tcp: Refreshing state... [id=sg-bp11s5pka9pxtj6pn4xq:ingress:tcp:1/65535:intranet:0.0.0.0/0ğŸ‰‘1]
alicloud_instance.wanzi_test: Refreshing state... [id=i-bp1gt9mb9asadff9r2zr]

An execution plan has been generated and is shown below.
Resource actions are indicated with the following symbols:
  + create

Terraform will perform the following actions:

  # module.tf-instances.alicloud_instance.this[0] will be created
  + resource &amp;quot;alicloud_instance&amp;quot; &amp;quot;this&amp;quot; {
      + availability_zone             = (known after apply)
      + credit_specification          = (known after apply)
      + deletion_protection           = false
      + description                   = &amp;quot;An ECS instance came from terraform-alicloud-modules/ecs-instance&amp;quot;
      + dry_run                       = false
      + host_name                     = &amp;quot;wanzi-cluster001&amp;quot;
      + id                            = (known after apply)
      + image_id                      = &amp;quot;ubuntu_18_04_64_20G_alibase_20190624.vhd&amp;quot;
      + instance_charge_type          = &amp;quot;PostPaid&amp;quot;
      + instance_name                 = &amp;quot;my_module_instances_001&amp;quot;
      + instance_type                 = &amp;quot;ecs.s6-c1m2.small&amp;quot;
      + internet_charge_type          = &amp;quot;PayByTraffic&amp;quot;
      + internet_max_bandwidth_in     = (known after apply)
      + internet_max_bandwidth_out    = 10
      + key_name                      = (known after apply)
      + password                      = (sensitive value)
      + private_ip                    = &amp;quot;10.100.0.10&amp;quot;
      + public_ip                     = (known after apply)
      + role_name                     = (known after apply)
      + security_enhancement_strategy = &amp;quot;Active&amp;quot;
      + security_groups               = [
          + &amp;quot;sg-bp11s5pka9pxtj6pn4xq&amp;quot;,
        ]
      + spot_strategy                 = &amp;quot;NoSpot&amp;quot;
      + status                        = &amp;quot;Running&amp;quot;
      + subnet_id                     = (known after apply)
      + system_disk_category          = &amp;quot;cloud_ssd&amp;quot;
      + system_disk_performance_level = (known after apply)
      + system_disk_size              = 40
      + tags                          = {
          + &amp;quot;Name&amp;quot; = &amp;quot;my_module_instances_001&amp;quot;
        }
      + volume_tags                   = {
          + &amp;quot;Name&amp;quot; = &amp;quot;my_module_instances_001&amp;quot;
        }
      + vswitch_id                    = &amp;quot;vsw-bp1wgpgz9z8y2lfsl2beo&amp;quot;

      + data_disks {
          + category             = &amp;quot;cloud_efficiency&amp;quot;
          + delete_with_instance = true
          + encrypted            = false
          + name                 = &amp;quot;TF_ECS_Disk&amp;quot;
          + performance_level    = (known after apply)
          + size                 = 40
        }
    }

  # module.tf-instances.alicloud_instance.this[1] will be created
  + resource &amp;quot;alicloud_instance&amp;quot; &amp;quot;this&amp;quot; {
      + availability_zone             = (known after apply)
      + credit_specification          = (known after apply)
      + deletion_protection           = false
      + description                   = &amp;quot;An ECS instance came from terraform-alicloud-modules/ecs-instance&amp;quot;
      + dry_run                       = false
      + host_name                     = &amp;quot;wanzi-cluster002&amp;quot;
      + id                            = (known after apply)
      + image_id                      = &amp;quot;ubuntu_18_04_64_20G_alibase_20190624.vhd&amp;quot;
      + instance_charge_type          = &amp;quot;PostPaid&amp;quot;
      + instance_name                 = &amp;quot;my_module_instances_002&amp;quot;
      + instance_type                 = &amp;quot;ecs.s6-c1m2.small&amp;quot;
      + internet_charge_type          = &amp;quot;PayByTraffic&amp;quot;
      + internet_max_bandwidth_in     = (known after apply)
      + internet_max_bandwidth_out    = 10
      + key_name                      = (known after apply)
      + password                      = (sensitive value)
      + private_ip                    = &amp;quot;10.100.0.11&amp;quot;
      + public_ip                     = (known after apply)
      + role_name                     = (known after apply)
      + security_enhancement_strategy = &amp;quot;Active&amp;quot;
      + security_groups               = [
          + &amp;quot;sg-bp11s5pka9pxtj6pn4xq&amp;quot;,
        ]
      + spot_strategy                 = &amp;quot;NoSpot&amp;quot;
      + status                        = &amp;quot;Running&amp;quot;
      + subnet_id                     = (known after apply)
      + system_disk_category          = &amp;quot;cloud_ssd&amp;quot;
      + system_disk_performance_level = (known after apply)
      + system_disk_size              = 40
      + tags                          = {
          + &amp;quot;Name&amp;quot; = &amp;quot;my_module_instances_002&amp;quot;
        }
      + volume_tags                   = {
          + &amp;quot;Name&amp;quot; = &amp;quot;my_module_instances_002&amp;quot;
        }
      + vswitch_id                    = &amp;quot;vsw-bp1wgpgz9z8y2lfsl2beo&amp;quot;

      + data_disks {
          + category             = &amp;quot;cloud_efficiency&amp;quot;
          + delete_with_instance = true
          + encrypted            = false
          + name                 = &amp;quot;TF_ECS_Disk&amp;quot;
          + performance_level    = (known after apply)
          + size                 = 40
        }
    }

  # module.tf-instances.alicloud_instance.this[2] will be created
  + resource &amp;quot;alicloud_instance&amp;quot; &amp;quot;this&amp;quot; {
      + availability_zone             = (known after apply)
      + credit_specification          = (known after apply)
      + deletion_protection           = false
      + description                   = &amp;quot;An ECS instance came from terraform-alicloud-modules/ecs-instance&amp;quot;
      + dry_run                       = false
      + host_name                     = &amp;quot;wanzi-cluster003&amp;quot;
      + id                            = (known after apply)
      + image_id                      = &amp;quot;ubuntu_18_04_64_20G_alibase_20190624.vhd&amp;quot;
      + instance_charge_type          = &amp;quot;PostPaid&amp;quot;
      + instance_name                 = &amp;quot;my_module_instances_003&amp;quot;
      + instance_type                 = &amp;quot;ecs.s6-c1m2.small&amp;quot;
      + internet_charge_type          = &amp;quot;PayByTraffic&amp;quot;
      + internet_max_bandwidth_in     = (known after apply)
      + internet_max_bandwidth_out    = 10
      + key_name                      = (known after apply)
      + password                      = (sensitive value)
      + private_ip                    = &amp;quot;10.100.0.12&amp;quot;
      + public_ip                     = (known after apply)
      + role_name                     = (known after apply)
      + security_enhancement_strategy = &amp;quot;Active&amp;quot;
      + security_groups               = [
          + &amp;quot;sg-bp11s5pka9pxtj6pn4xq&amp;quot;,
        ]
      + spot_strategy                 = &amp;quot;NoSpot&amp;quot;
      + status                        = &amp;quot;Running&amp;quot;
      + subnet_id                     = (known after apply)
      + system_disk_category          = &amp;quot;cloud_ssd&amp;quot;
      + system_disk_performance_level = (known after apply)
      + system_disk_size              = 40
      + tags                          = {
          + &amp;quot;Name&amp;quot; = &amp;quot;my_module_instances_003&amp;quot;
        }
      + volume_tags                   = {
          + &amp;quot;Name&amp;quot; = &amp;quot;my_module_instances_003&amp;quot;
        }
      + vswitch_id                    = &amp;quot;vsw-bp1wgpgz9z8y2lfsl2beo&amp;quot;

      + data_disks {
          + category             = &amp;quot;cloud_efficiency&amp;quot;
          + delete_with_instance = true
          + encrypted            = false
          + name                 = &amp;quot;TF_ECS_Disk&amp;quot;
          + performance_level    = (known after apply)
          + size                 = 40
        }
    }

Plan: 3 to add, 0 to change, 0 to destroy.

Do you want to perform these actions?
  Terraform will perform the actions described above.
  Only &#39;yes&#39; will be accepted to approve.

  Enter a value: yes

module.tf-instances.alicloud_instance.this[2]: Creating...
module.tf-instances.alicloud_instance.this[1]: Creating...
module.tf-instances.alicloud_instance.this[0]: Creating...
module.tf-instances.alicloud_instance.this[1]: Still creating... [10s elapsed]
module.tf-instances.alicloud_instance.this[2]: Still creating... [10s elapsed]
module.tf-instances.alicloud_instance.this[0]: Still creating... [10s elapsed]
module.tf-instances.alicloud_instance.this[1]: Still creating... [20s elapsed]
module.tf-instances.alicloud_instance.this[0]: Still creating... [20s elapsed]
module.tf-instances.alicloud_instance.this[2]: Still creating... [20s elapsed]
module.tf-instances.alicloud_instance.this[0]: Creation complete after 21s [id=i-bp1hwbo4htk8sbwxtk6o]
module.tf-instances.alicloud_instance.this[1]: Creation complete after 21s [id=i-bp17lh41gywyih0xg6we]
module.tf-instances.alicloud_instance.this[2]: Creation complete after 22s [id=i-bp11zlrl6vxeaerz4ad0]

Apply complete! Resources: 3 added, 0 changed, 0 destroyed.
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;è‡³æ­¤ï¼Œæ•´ä¸ªåˆ›å»ºå¤šECSå®ä¾‹çš„æ“ä½œå·²ç»å®Œæˆï¼Œåç»­å¦‚æœå¯¹å½“å‰å·²ç»éƒ¨ç½²ecsèµ„æºæœ‰è°ƒæ•´ï¼Œè¿›è¡ŒåŸºæœ¬write/plan/applyæ“ä½œå³å¯ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šé‡å¯é˜¿é‡Œäº‘å®ä¾‹ã€‚&lt;/p&gt;
</description>
      
    </item>
    
    <item>
      <title>terraformå®‰è£…ä¸å‘½ä»¤è¯¦è§£</title>
      <link>https://wnote.com/post/devops-terraform-command-detail/</link>
      <pubDate>Thu, 25 Feb 2021 17:22:42 +0800</pubDate>
      
      <guid>https://wnote.com/post/devops-terraform-command-detail/</guid>
      
        <description>&lt;h2 id=&#34;å®‰è£…terraform&#34;&gt;å®‰è£…Terraform&lt;/h2&gt;
&lt;h3 id=&#34;macç³»ç»Ÿå®‰è£…&#34;&gt;Macç³»ç»Ÿå®‰è£…&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;brew tap hashicorp/tap
brew install hashicorp/tap/terraform
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;linuxç³»ç»Ÿå®‰è£…&#34;&gt;Linuxç³»ç»Ÿå®‰è£…&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;ubuntuå®‰è£…&lt;/li&gt;
&lt;/ol&gt;
&lt;pre&gt;&lt;code&gt;curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
sudo apt-add-repository &amp;quot;deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main&amp;quot;
sudo apt-get update &amp;amp;&amp;amp; sudo apt-get install terraform
&lt;/code&gt;&lt;/pre&gt;&lt;ol start=&#34;2&#34;&gt;
&lt;li&gt;centosç³»ç»Ÿ&lt;/li&gt;
&lt;/ol&gt;
&lt;pre&gt;&lt;code&gt;sudo yum install -y yum-utils
sudo yum-config-manager --add-repo https://rpm.releases.hashicorp.com/RHEL/hashicorp.repo
sudo yum -y install terraform
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;éªŒè¯å®‰è£…&#34;&gt;éªŒè¯å®‰è£…&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;# terraform -v
Terraform v0.14.3

Your version of Terraform is out of date! The latest version
is 0.14.7. You can update by downloading from https://www.terraform.io/downloads.html
# terraform
Usage: terraform [global options] &amp;lt;subcommand&amp;gt; [args]

The available commands for execution are listed below.
The primary workflow commands are given first, followed by
less common or more advanced commands.

Main commands:
  init          Prepare your working directory for other commands
  validate      Check whether the configuration is valid
  plan          Show changes required by the current configuration
  apply         Create or update infrastructure
  destroy       Destroy previously-created infrastructure

All other commands:
  console       Try Terraform expressions at an interactive command prompt
  fmt           Reformat your configuration in the standard style
  force-unlock  Release a stuck lock on the current workspace
  get           Install or upgrade remote Terraform modules
  graph         Generate a Graphviz graph of the steps in an operation
  import        Associate existing infrastructure with a Terraform resource
  login         Obtain and save credentials for a remote host
  logout        Remove locally-stored credentials for a remote host
  output        Show output values from your root module
  providers     Show the providers required for this configuration
  refresh       Update the state to match remote systems
  show          Show the current state or a saved plan
  state         Advanced state management
  taint         Mark a resource instance as not fully functional
  untaint       Remove the &#39;tainted&#39; state from a resource instance
  version       Show the current Terraform version
  workspace     Workspace management

Global options (use these before the subcommand, if any):
  -chdir=DIR    Switch to a different working directory before executing the
                given subcommand.
  -help         Show this help output, or the help for a specified subcommand.
  -version      An alias for the &amp;quot;version&amp;quot; subcommand.
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;terraformå‘½ä»¤ä¹‹èµ„æºç®¡ç†&#34;&gt;terraformå‘½ä»¤ä¹‹èµ„æºç®¡ç†&lt;/h2&gt;
&lt;h3 id=&#34;èµ„æºåˆå§‹åŒ–&#34;&gt;èµ„æºåˆå§‹åŒ–&lt;/h3&gt;
&lt;p&gt;å¯¹äºä¸€ä¸ªterraformèµ„æºé¡¹ç›®ï¼Œæˆ‘è¿™é‡Œåˆ›å»ºäº†3ä¸ªåŸºæœ¬æ–‡ä»¶ï¼Œåˆ†åˆ«ä¸ºï¼šmain.tfï¼ˆå…¥å£æ–‡ä»¶ï¼‰ï¼Œvariables.tfï¼ˆå˜é‡ä¿¡æ¯ï¼‰ï¼Œversions.tfï¼ˆç‰ˆæœ¬ä¿¡æ¯ï¼‰&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# ls 
main.tf     variables.tf      versions.tf
# terraform init

Initializing the backend...

Initializing provider plugins...
- Reusing previous version of aliyun/alicloud from the dependency lock file
- Using aliyun/alicloud v1.115.1 from the shared cache directory

Terraform has been successfully initialized!
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;æ ¼å¼åŒ–terraformæ–‡ä»¶&#34;&gt;æ ¼å¼åŒ–terraformæ–‡ä»¶&lt;/h3&gt;
&lt;p&gt;fmté»˜è®¤ä¼šå›æ ¼å¼åŒ–å¤„ç†å½“å‰ç›®å½•ä¸‹.tfæ–‡ä»¶ï¼Œå¹¶æ ¼å¼ä¸ºæ ‡å‡†çš„tfæ ¼å¼ã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# terraform fmt 
main.tf
variables.tf
versions.tf
# terraform fmt -diff  #æ ¼å¼åŒ–å¤„ç†
main.tf
--- old/main.tf
+++ new/main.tf
@@ -1,7 +1,7 @@
 provider &amp;quot;alicloud&amp;quot; {
   region     = var.region
   access_key = var.alicloud_access_key
-  secret_key =  var.alicloud_secret_key
+  secret_key = var.alicloud_secret_key
 }

 resource &amp;quot;alicloud_vpc&amp;quot; &amp;quot;vpc&amp;quot; {
@@ -12,7 +12,7 @@
 resource &amp;quot;alicloud_vswitch&amp;quot; &amp;quot;vsw&amp;quot; {
   vpc_id            = alicloud_vpc.vpc.id
   cidr_block        = &amp;quot;10.100.0.0/24&amp;quot;
-  availability_zone =  var.availability_zone
+  availability_zone = var.availability_zone
 }

 resource &amp;quot;alicloud_security_group&amp;quot; &amp;quot;default&amp;quot; {
variables.tf
--- old/variables.tf
+++ new/variables.tf
@@ -4,7 +4,7 @@
 }

 variable &amp;quot;alicloud_secret_key&amp;quot; {
-  default                     = &amp;quot;4Z4gbl3d9TGz9jWobv9MPwInvyH2Kf&amp;quot;
+  default     = &amp;quot;4Z4gbl3d9TGz9jWobv9MPwInvyH2Kf&amp;quot;
   description = &amp;quot;The Alicloud Access Secret Key to launch resources.  Support to environment &#39;ALICLOUD_SECRET_KEY&#39;.&amp;quot;
 }
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;åˆ›å»ºèµ„æºè®¡åˆ’&#34;&gt;åˆ›å»ºèµ„æºè®¡åˆ’&lt;/h3&gt;
&lt;p&gt;terraform plan ä¼šæ£€æŸ¥ä¸€ç»„æ›´æ”¹çš„æ‰§è¡Œè®¡åˆ’æ˜¯å¦ç¬¦åˆæ‚¨çš„æœŸæœ›ï¼Œè€Œä¸ä¼šæ›´æ”¹å®é™…èµ„æºæˆ–çŠ¶æ€ã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# terraform  plan

An execution plan has been generated and is shown below.
Resource actions are indicated with the following symbols:
  + create

Terraform will perform the following actions:

  # alicloud_instance.wanzi_test will be created
  + resource &amp;quot;alicloud_instance&amp;quot; &amp;quot;wanzi_test&amp;quot; {
      + availability_zone             = &amp;quot;cn-hangzhou-i&amp;quot;
      + credit_specification          = (known after apply)
      + deletion_protection           = false
      + dry_run                       = false
      + host_name                     = (known after apply)
      + id                            = (known after apply)
      + image_id                      = &amp;quot;ubuntu_18_04_64_20G_alibase_20190624.vhd&amp;quot;
      + instance_charge_type          = &amp;quot;PostPaid&amp;quot;
      + instance_name                 = &amp;quot;wanzi_tf001&amp;quot;
      + instance_type                 = &amp;quot;ecs.s6-c1m2.small&amp;quot;
      + internet_max_bandwidth_in     = (known after apply)
      + internet_max_bandwidth_out    = 0
      + key_name                      = (known after apply)
      + password                      = (sensitive value)
      + private_ip                    = (known after apply)
      + public_ip                     = (known after apply)
      + role_name                     = (known after apply)
      + security_groups               = (known after apply)
      + spot_strategy                 = &amp;quot;NoSpot&amp;quot;
      + status                        = &amp;quot;Running&amp;quot;
      + subnet_id                     = (known after apply)
      + system_disk_category          = &amp;quot;cloud_efficiency&amp;quot;
      + system_disk_performance_level = (known after apply)
      + system_disk_size              = 40
      + volume_tags                   = (known after apply)
      + vswitch_id                    = (known after apply)
    }
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;åˆ›å»ºäº‘èµ„æº&#34;&gt;åˆ›å»ºäº‘èµ„æº&lt;/h3&gt;
&lt;p&gt;terraform apply ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªèµ„æºåˆ›å»ºè®¡åˆ’ï¼Œå¹¶æ‰¹å‡†æ‰§è¡Œè¯¥è®¡åˆ’ï¼ŒåŒæ—¶åœ¨å½“å‰ç›®å½•ä¸‹ä¼šç”Ÿæˆtfstateæ–‡ä»¶&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# terraform apply
An execution plan has been generated and is shown below.
Resource actions are indicated with the following symbols:
  + create

Terraform will perform the following actions:

  # alicloud_instance.wanzi_test will be created
  + resource &amp;quot;alicloud_instance&amp;quot; &amp;quot;wanzi_test&amp;quot; {
      + availability_zone             = &amp;quot;cn-hangzhou-i&amp;quot;
      + credit_specification          = (known after apply)
      + deletion_protection           = false
      + dry_run                       = false
      + host_name                     = (known after apply)
      + id                            = (known after apply)
      + image_id                      = &amp;quot;ubuntu_18_04_64_20G_alibase_20190624.vhd&amp;quot;
      + instance_charge_type          = &amp;quot;PostPaid&amp;quot;
      + instance_name                 = &amp;quot;wanzi_tf001&amp;quot;
      + instance_type                 = &amp;quot;ecs.s6-c1m2.small&amp;quot;
      + internet_max_bandwidth_in     = (known after apply)
      + internet_max_bandwidth_out    = 0
      + key_name                      = (known after apply)
      + password                      = (sensitive value)
      + private_ip                    = (known after apply)
      + public_ip                     = (known after apply)
      + role_name                     = (known after apply)
      + security_groups               = (known after apply)
      + spot_strategy                 = &amp;quot;NoSpot&amp;quot;
      + status                        = &amp;quot;Running&amp;quot;
      + subnet_id                     = (known after apply)
      + system_disk_category          = &amp;quot;cloud_efficiency&amp;quot;
      + system_disk_performance_level = (known after apply)
      + system_disk_size              = 40
      + volume_tags                   = (known after apply)
      + vswitch_id                    = (known after apply)
    }

  # alicloud_security_group.default will be created
  + resource &amp;quot;alicloud_security_group&amp;quot; &amp;quot;default&amp;quot; {
      + id                  = (known after apply)
      + inner_access        = (known after apply)
      + inner_access_policy = (known after apply)
      + name                = &amp;quot;default&amp;quot;
      + security_group_type = &amp;quot;normal&amp;quot;
      + vpc_id              = (known after apply)
    }
......
......
Plan: 5 to add, 0 to change, 0 to destroy.

Do you want to perform these actions?
  Terraform will perform the actions described above.
  Only &#39;yes&#39; will be accepted to approve.

  Enter a value: yes

alicloud_vpc.vpc: Creating...
alicloud_vpc.vpc: Creation complete after 9s [id=vpc-bp1kulcyygsi727aay4hd]
alicloud_security_group.default: Creating...
alicloud_vswitch.vsw: Creating...
alicloud_security_group.default: Creation complete after 1s [id=sg-bp11s5pka9pxtj6pn4xq]
alicloud_security_group_rule.allow_all_tcp: Creating...
alicloud_security_group_rule.allow_all_tcp: Creation complete after 1s [id=sg-bp11s5pka9pxtj6pn4xq:ingress:tcp:1/65535:intranet:0.0.0.0/0ğŸ‰‘1]
alicloud_vswitch.vsw: Creation complete after 4s [id=vsw-bp1wgpgz9z8y2lfsl2beo]
alicloud_instance.wanzi_test: Creating...
alicloud_instance.wanzi_test: Still creating... [10s elapsed]
alicloud_instance.wanzi_test: Still creating... [20s elapsed]
alicloud_instance.wanzi_test: Creation complete after 22s [id=i-bp1gt9mb9asadff9r2zr]

Apply complete! Resources: 5 added, 0 changed, 0 destroyed.
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;æŸ¥çœ‹åˆ›å»ºçš„èµ„æºä¿¡æ¯&#34;&gt;æŸ¥çœ‹åˆ›å»ºçš„èµ„æºä¿¡æ¯&lt;/h3&gt;
&lt;p&gt;terraform show ä¼šæŸ¥çœ‹å½“å‰é¡¹ç›®åˆ›å»ºäº†å“ªäº›èµ„æºæ•°æ®ï¼Œ&lt;/p&gt;
&lt;p&gt;terraform show -json  ä»¥jsonå½¢å¼æŸ¥çœ‹æ•°æ®&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# terraform show
# alicloud_instance.wanzi_test:
resource &amp;quot;alicloud_instance&amp;quot; &amp;quot;wanzi_test&amp;quot; {
    availability_zone          = &amp;quot;cn-hangzhou-i&amp;quot;
    deletion_protection        = false
    dry_run                    = false
    host_name                  = &amp;quot;iZbp1gt9mb9asadff9r2zrZ&amp;quot;
    id                         = &amp;quot;i-bp1gt9mb9asadff9r2zr&amp;quot;
    image_id                   = &amp;quot;ubuntu_18_04_64_20G_alibase_20190624.vhd&amp;quot;
    instance_charge_type       = &amp;quot;PostPaid&amp;quot;
    instance_name              = &amp;quot;wanzi_tf001&amp;quot;
    instance_type              = &amp;quot;ecs.s6-c1m2.small&amp;quot;
    internet_charge_type       = &amp;quot;PayByTraffic&amp;quot;
    internet_max_bandwidth_in  = -1
    internet_max_bandwidth_out = 0
    password                   = (sensitive value)
    private_ip                 = &amp;quot;10.100.0.234&amp;quot;
    security_groups            = [
        &amp;quot;sg-bp11s5pka9pxtj6pn4xq&amp;quot;,
    ]
    spot_price_limit           = 0
    spot_strategy              = &amp;quot;NoSpot&amp;quot;
    status                     = &amp;quot;Running&amp;quot;
    subnet_id                  = &amp;quot;vsw-bp1wgpgz9z8y2lfsl2beo&amp;quot;
    system_disk_category       = &amp;quot;cloud_efficiency&amp;quot;
    system_disk_size           = 40
    volume_tags                = {}
    vswitch_id                 = &amp;quot;vsw-bp1wgpgz9z8y2lfsl2beo&amp;quot;
}

# alicloud_security_group.default:
resource &amp;quot;alicloud_security_group&amp;quot; &amp;quot;default&amp;quot; {
    id                  = &amp;quot;sg-bp11s5pka9pxtj6pn4xq&amp;quot;
    inner_access        = true
    inner_access_policy = &amp;quot;Accept&amp;quot;
    name                = &amp;quot;default&amp;quot;
    security_group_type = &amp;quot;normal&amp;quot;
    vpc_id              = &amp;quot;vpc-bp1kulcyygsi727aay4hd&amp;quot;
}

# alicloud_security_group_rule.allow_all_tcp:
resource &amp;quot;alicloud_security_group_rule&amp;quot; &amp;quot;allow_all_tcp&amp;quot; {
    cidr_ip           = &amp;quot;0.0.0.0/0&amp;quot;
    id                = &amp;quot;sg-bp11s5pka9pxtj6pn4xq:ingress:tcp:1/65535:intranet:0.0.0.0/0ğŸ‰‘1&amp;quot;
    ip_protocol       = &amp;quot;tcp&amp;quot;
    nic_type          = &amp;quot;intranet&amp;quot;
    policy            = &amp;quot;accept&amp;quot;
    port_range        = &amp;quot;1/65535&amp;quot;
    priority          = 1
    security_group_id = &amp;quot;sg-bp11s5pka9pxtj6pn4xq&amp;quot;
    type              = &amp;quot;ingress&amp;quot;
}

# alicloud_vpc.vpc:
resource &amp;quot;alicloud_vpc&amp;quot; &amp;quot;vpc&amp;quot; {
    cidr_block        = &amp;quot;10.100.0.0/16&amp;quot;
    id                = &amp;quot;vpc-bp1kulcyygsi727aay4hd&amp;quot;
    name              = &amp;quot;tf_test_foo&amp;quot;
    resource_group_id = &amp;quot;rg-acfm2ogp24u3rcy&amp;quot;
    route_table_id    = &amp;quot;vtb-bp1wy8srerq12rta02r03&amp;quot;
    router_id         = &amp;quot;vrt-bp1apvobefvhshksnnwvm&amp;quot;
    router_table_id   = &amp;quot;vtb-bp1wy8srerq12rta02r03&amp;quot;
}

# alicloud_vswitch.vsw:
resource &amp;quot;alicloud_vswitch&amp;quot; &amp;quot;vsw&amp;quot; {
    availability_zone = &amp;quot;cn-hangzhou-i&amp;quot;
    cidr_block        = &amp;quot;10.100.0.0/24&amp;quot;
    id                = &amp;quot;vsw-bp1wgpgz9z8y2lfsl2beo&amp;quot;
    vpc_id            = &amp;quot;vpc-bp1kulcyygsi727aay4hd&amp;quot;
}
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;æ ‡è®°æ±¡ç‚¹&#34;&gt;æ ‡è®°æ±¡ç‚¹&lt;/h3&gt;
&lt;p&gt;terrraform taint å‘½ä»¤ç”¨äºæŠŠæŸä¸ªèµ„æºæ ‡è®°ä¸ºâ€œè¢«æ±¡æŸ“â€çŠ¶æ€ï¼Œå½“å†æ¬¡æ‰§è¡Œ apply å‘½ä»¤æ—¶ï¼Œè¿™ä¸ªè¢«æ±¡æŸ“çš„èµ„æºå°†ä¼šè¢«å…ˆé‡Šæ”¾ï¼Œç„¶åå†åˆ›å»ºä¸€ä¸ªæ–°çš„ï¼Œç›¸å½“äºå¯¹è¿™ä¸ªç‰¹å®šèµ„æºåšäº†å…ˆåˆ é™¤åæ–°å»ºçš„æ“ä½œã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# terraform taint alicloud_instance.wanzi_test
Resource instance alicloud_instance.wanzi_test has been marked as tainted.
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;è€Œterrraform untaintæ­£å¥½ç›¸åï¼Œç”¨äºå–æ¶ˆâ€œè¢«æ±¡æŸ“â€æ ‡è®°ï¼Œä½¿å…¶æ¢å¤åˆ°æ­£å¸¸çš„çŠ¶æ€ã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# terraform untaint alicloud_instance.wanzi_test
Resource instance alicloud_instance.wanzi_test has been successfully untainted.
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;é”€æ¯äº‘èµ„æºæ•°æ®&#34;&gt;é”€æ¯äº‘èµ„æºæ•°æ®&lt;/h3&gt;
&lt;p&gt;terraform destory å°†æ ¹æ®å½“å‰èµ„æºé…ç½®ï¼Œé”€æ¯äº‘ç«¯èµ„æºæ•°æ®&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;#terraform destroy

Plan: 0 to add, 0 to change, 5 to destroy.

Do you really want to destroy all resources?
  Terraform will destroy all your managed infrastructure, as shown above.
  There is no undo. Only &#39;yes&#39; will be accepted to confirm.

  Enter a value: yes

alicloud_security_group_rule.allow_all_tcp: Destroying... [id=sg-bp10tup89oothxz8tny1:ingress:tcp:1/65535:intranet:0.0.0.0/0ğŸ‰‘1]
alicloud_instance.wanzi_test: Destroying... [id=i-bp10ukz4nlr894mhebgl]
alicloud_security_group_rule.allow_all_tcp: Destruction complete after 0s
alicloud_instance.wanzi_test: Still destroying... [id=i-bp10ukz4nlr894mhebgl, 10s elapsed]
alicloud_instance.wanzi_test: Still destroying... [id=i-bp10ukz4nlr894mhebgl, 20s elapsed]
alicloud_instance.wanzi_test: Destruction complete after 28s
alicloud_security_group.default: Destroying... [id=sg-bp10tup89oothxz8tny1]
alicloud_vswitch.vsw: Destroying... [id=vsw-bp1ap7ccst3fjxnw4pnza]
alicloud_security_group.default: Destruction complete after 9s
alicloud_vswitch.vsw: Still destroying... [id=vsw-bp1ap7ccst3fjxnw4pnza, 10s elapsed]
alicloud_vswitch.vsw: Destruction complete after 20s
alicloud_vpc.vpc: Destroying... [id=vpc-bp1obwt5ded2i0zlbu052]
alicloud_vpc.vpc: Destruction complete after 3s

Destroy complete! Resources: 5 destroyed.
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;å°†äº‘ç«¯æ•°æ®å¯¼å…¥åˆ°æœ¬åœ°é¡¹ç›®&#34;&gt;å°†äº‘ç«¯æ•°æ®å¯¼å…¥åˆ°æœ¬åœ°é¡¹ç›®&lt;/h3&gt;
&lt;p&gt;terraform import é€šè¿‡äº‘ç«¯å®ä¾‹IDæ¥ç”Ÿæˆæœ¬åœ°èµ„æºæ•°æ®ï¼Œæœ¬åœ°ç›®å½•ä¼šç”Ÿæˆterraform.tfstateæ–‡ä»¶ï¼Œå¯¹äºæœ¬åœ°é¡¹ç›®å·²å­˜åœ¨æ•°æ®çš„å¯¼å…¥å‰è¯·å…ˆå¤‡ä»½tfstateæ–‡ä»¶å’Œ.terraformç›®å½•ï¼›å¯¹äºå·²ç»å¯¼å…¥åˆ°æœ¬åœ°çš„æ•°æ®ï¼Œå¯ä»¥é€šè¿‡terraform showå±•ç¤ºå‡ºterrafromæ–‡ä»¶æ ¼å¼ï¼Œcopyå‡ºæ¥å¹¶è¿›ä¸€æ­¥å¤„ç†ï¼Œå³å¯å¾—åˆ°tfèµ„æºæ–‡ä»¶å†…å®¹ã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# cat yunduan.tf
resource &amp;quot;alicloud_instance&amp;quot; &amp;quot;test999&amp;quot; {
  # (resource arguments)
}
#
# terraform import alicloud_instance.test999 i-bp1etiv4002h9q27lb97
alicloud_instance.test999: Importing from ID &amp;quot;i-bp1etiv4002h9q27lb97&amp;quot;...
alicloud_instance.test999: Import prepared!
  Prepared alicloud_instance for import
alicloud_instance.test999: Refreshing state... [id=i-bp1etiv4002h9q27lb97]

Import successful!

The resources that were imported are shown above. These resources are now in
your Terraform state and will henceforth be managed by Terraform.
# cat  terraform.tfstate
{
  &amp;quot;version&amp;quot;: 4,
  &amp;quot;terraform_version&amp;quot;: &amp;quot;0.14.3&amp;quot;,
  &amp;quot;serial&amp;quot;: 1,
  &amp;quot;lineage&amp;quot;: &amp;quot;779fad5e-b076-8cfd-6041-f6eef8c88b8a&amp;quot;,
  &amp;quot;outputs&amp;quot;: {},
  &amp;quot;resources&amp;quot;: [
    {
      &amp;quot;mode&amp;quot;: &amp;quot;managed&amp;quot;,
      &amp;quot;type&amp;quot;: &amp;quot;alicloud_instance&amp;quot;,
      &amp;quot;name&amp;quot;: &amp;quot;test999&amp;quot;,
      &amp;quot;provider&amp;quot;: &amp;quot;provider[\&amp;quot;registry.terraform.io/aliyun/alicloud\&amp;quot;]&amp;quot;,
      &amp;quot;instances&amp;quot;: [
        {
          &amp;quot;schema_version&amp;quot;: 0,
          &amp;quot;attributes&amp;quot;: {
            &amp;quot;allocate_public_ip&amp;quot;: null,
            &amp;quot;auto_release_time&amp;quot;: &amp;quot;&amp;quot;,
            &amp;quot;auto_renew_period&amp;quot;: null,
            &amp;quot;availability_zone&amp;quot;: &amp;quot;cn-hangzhou-i&amp;quot;,
            &amp;quot;credit_specification&amp;quot;: &amp;quot;&amp;quot;,
            &amp;quot;data_disks&amp;quot;: [],
            &amp;quot;deletion_protection&amp;quot;: false,
            &amp;quot;description&amp;quot;: &amp;quot;&amp;quot;,
            &amp;quot;dry_run&amp;quot;: null,
            &amp;quot;force_delete&amp;quot;: null,
            &amp;quot;host_name&amp;quot;: &amp;quot;iZbp1etiv4002h9q27lb97Z&amp;quot;,
            &amp;quot;id&amp;quot;: &amp;quot;i-bp1etiv4002h9q27lb97&amp;quot;,
            &amp;quot;image_id&amp;quot;: &amp;quot;ubuntu_18_04_64_20G_alibase_20190624.vhd&amp;quot;,
            &amp;quot;include_data_disks&amp;quot;: null,
            &amp;quot;instance_charge_type&amp;quot;: &amp;quot;PostPaid&amp;quot;,
            &amp;quot;instance_name&amp;quot;: &amp;quot;wanzi_tf001&amp;quot;,
            &amp;quot;instance_type&amp;quot;: &amp;quot;ecs.s6-c1m2.small&amp;quot;,
            &amp;quot;internet_charge_type&amp;quot;: &amp;quot;PayByTraffic&amp;quot;,
            &amp;quot;internet_max_bandwidth_in&amp;quot;: -1,
            &amp;quot;internet_max_bandwidth_out&amp;quot;: 0,
            &amp;quot;io_optimized&amp;quot;: null,
            &amp;quot;is_outdated&amp;quot;: null,
            &amp;quot;key_name&amp;quot;: &amp;quot;&amp;quot;,
            &amp;quot;kms_encrypted_password&amp;quot;: null,
            &amp;quot;kms_encryption_context&amp;quot;: null,
            &amp;quot;password&amp;quot;: &amp;quot;&amp;quot;,
            &amp;quot;period&amp;quot;: null,
            &amp;quot;period_unit&amp;quot;: null,
            &amp;quot;private_ip&amp;quot;: &amp;quot;10.100.0.169&amp;quot;,
            &amp;quot;public_ip&amp;quot;: &amp;quot;&amp;quot;,
            &amp;quot;renewal_status&amp;quot;: null,
            &amp;quot;resource_group_id&amp;quot;: &amp;quot;&amp;quot;,
            &amp;quot;role_name&amp;quot;: &amp;quot;&amp;quot;,
            &amp;quot;security_enhancement_strategy&amp;quot;: null,
            &amp;quot;security_groups&amp;quot;: [
              &amp;quot;sg-bp14pij6g7sjmn9bz92a&amp;quot;
            ],
            &amp;quot;spot_price_limit&amp;quot;: 0,
            &amp;quot;spot_strategy&amp;quot;: &amp;quot;NoSpot&amp;quot;,
            &amp;quot;status&amp;quot;: &amp;quot;Running&amp;quot;,
            &amp;quot;subnet_id&amp;quot;: &amp;quot;vsw-bp1c966jdtiw1qwh2tng8&amp;quot;,
            &amp;quot;system_disk_auto_snapshot_policy_id&amp;quot;: &amp;quot;&amp;quot;,
            &amp;quot;system_disk_category&amp;quot;: &amp;quot;cloud_efficiency&amp;quot;,
            &amp;quot;system_disk_description&amp;quot;: null,
            &amp;quot;system_disk_name&amp;quot;: null,
            &amp;quot;system_disk_performance_level&amp;quot;: &amp;quot;&amp;quot;,
            &amp;quot;system_disk_size&amp;quot;: 40,
            &amp;quot;tags&amp;quot;: {},
            &amp;quot;timeouts&amp;quot;: {
              &amp;quot;create&amp;quot;: null,
              &amp;quot;delete&amp;quot;: null,
              &amp;quot;update&amp;quot;: null
            },
            &amp;quot;user_data&amp;quot;: &amp;quot;&amp;quot;,
            &amp;quot;volume_tags&amp;quot;: {},
            &amp;quot;vswitch_id&amp;quot;: &amp;quot;vsw-bp1c966jdtiw1qwh2tng8&amp;quot;
          },
          &amp;quot;sensitive_attributes&amp;quot;: [],
          &amp;quot;private&amp;quot;: &amp;quot;eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjo2MDAwMDAwMDAwMDAsImRlbGV0ZSI6MTIwMDAwMDAwMDAwMCwidXBkYXRlIjo2MDAwMDAwMDAwMDB9LCJzY2hlbWFfdmVyc2lvbiI6IjAifQ==&amp;quot;
        }
      ]
    }
  ]
}
# terraform show
# alicloud_instance.test999:
resource &amp;quot;alicloud_instance&amp;quot; &amp;quot;test999&amp;quot; {
    availability_zone          = &amp;quot;cn-hangzhou-i&amp;quot;
    deletion_protection        = false
    host_name                  = &amp;quot;iZbp1etiv4002h9q27lb97Z&amp;quot;
    id                         = &amp;quot;i-bp1etiv4002h9q27lb97&amp;quot;
    image_id                   = &amp;quot;ubuntu_18_04_64_20G_alibase_20190624.vhd&amp;quot;
    instance_charge_type       = &amp;quot;PostPaid&amp;quot;
    instance_name              = &amp;quot;wanzi_tf001&amp;quot;
    instance_type              = &amp;quot;ecs.s6-c1m2.small&amp;quot;
    internet_charge_type       = &amp;quot;PayByTraffic&amp;quot;
    internet_max_bandwidth_in  = -1
    internet_max_bandwidth_out = 0
    private_ip                 = &amp;quot;10.100.0.169&amp;quot;
    security_groups            = [
        &amp;quot;sg-bp14pij6g7sjmn9bz92a&amp;quot;,
    ]
    spot_price_limit           = 0
    spot_strategy              = &amp;quot;NoSpot&amp;quot;
    status                     = &amp;quot;Running&amp;quot;
    subnet_id                  = &amp;quot;vsw-bp1c966jdtiw1qwh2tng8&amp;quot;
    system_disk_category       = &amp;quot;cloud_efficiency&amp;quot;
    system_disk_size           = 40
    tags                       = {}
    volume_tags                = {}
    vswitch_id                 = &amp;quot;vsw-bp1c966jdtiw1qwh2tng8&amp;quot;

    timeouts {}
}
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;terraformèµ„æºå…³ç³»ç»˜å›¾&#34;&gt;terraformèµ„æºå…³ç³»ç»˜å›¾&lt;/h3&gt;
&lt;p&gt;æ¯ä¸ªæ¨¡æ¿å®šä¹‰çš„èµ„æºä¹‹é—´éƒ½å­˜åœ¨ä¸åŒç¨‹åº¦çš„å…³ç³»ï¼Œterraform graphå¯ä»¥ç»˜åˆ¶èµ„æºå…³ç³»å¤§å›¾ï¼Œå¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# terraform graph
digraph {
        compound = &amp;quot;true&amp;quot;
        newrank = &amp;quot;true&amp;quot;
        subgraph &amp;quot;root&amp;quot; {
                &amp;quot;[root] alicloud_instance.wanzi_test (expand)&amp;quot; [label = &amp;quot;alicloud_instance.wanzi_test&amp;quot;, shape = &amp;quot;box&amp;quot;]
                &amp;quot;[root] alicloud_security_group.default (expand)&amp;quot; [label = &amp;quot;alicloud_security_group.default&amp;quot;, shape = &amp;quot;box&amp;quot;]
                &amp;quot;[root] alicloud_security_group_rule.allow_all_tcp (expand)&amp;quot; [label = &amp;quot;alicloud_security_group_rule.allow_all_tcp&amp;quot;, shape = &amp;quot;box&amp;quot;]
                &amp;quot;[root] alicloud_vpc.vpc (expand)&amp;quot; [label = &amp;quot;alicloud_vpc.vpc&amp;quot;, shape = &amp;quot;box&amp;quot;]
                &amp;quot;[root] alicloud_vswitch.vsw (expand)&amp;quot; [label = &amp;quot;alicloud_vswitch.vsw&amp;quot;, shape = &amp;quot;box&amp;quot;]
                &amp;quot;[root] provider[\&amp;quot;registry.terraform.io/aliyun/alicloud\&amp;quot;]&amp;quot; [label = &amp;quot;provider[\&amp;quot;registry.terraform.io/aliyun/alicloud\&amp;quot;]&amp;quot;, shape = &amp;quot;diamond&amp;quot;]
                &amp;quot;[root] var.alicloud_access_key&amp;quot; [label = &amp;quot;var.alicloud_access_key&amp;quot;, shape = &amp;quot;note&amp;quot;]
                &amp;quot;[root] var.alicloud_secret_key&amp;quot; [label = &amp;quot;var.alicloud_secret_key&amp;quot;, shape = &amp;quot;note&amp;quot;]
                &amp;quot;[root] var.availability_zone&amp;quot; [label = &amp;quot;var.availability_zone&amp;quot;, shape = &amp;quot;note&amp;quot;]
                &amp;quot;[root] var.disk_category&amp;quot; [label = &amp;quot;var.disk_category&amp;quot;, shape = &amp;quot;note&amp;quot;]
                &amp;quot;[root] var.disk_size&amp;quot; [label = &amp;quot;var.disk_size&amp;quot;, shape = &amp;quot;note&amp;quot;]
                &amp;quot;[root] var.ecs_password&amp;quot; [label = &amp;quot;var.ecs_password&amp;quot;, shape = &amp;quot;note&amp;quot;]
                &amp;quot;[root] var.ecs_type&amp;quot; [label = &amp;quot;var.ecs_type&amp;quot;, shape = &amp;quot;note&amp;quot;]
                &amp;quot;[root] var.image_id&amp;quot; [label = &amp;quot;var.image_id&amp;quot;, shape = &amp;quot;note&amp;quot;]
                &amp;quot;[root] var.internet_charge_type&amp;quot; [label = &amp;quot;var.internet_charge_type&amp;quot;, shape = &amp;quot;note&amp;quot;]
                &amp;quot;[root] var.internet_max_bandwidth_out&amp;quot; [label = &amp;quot;var.internet_max_bandwidth_out&amp;quot;, shape = &amp;quot;note&amp;quot;]
                &amp;quot;[root] var.region&amp;quot; [label = &amp;quot;var.region&amp;quot;, shape = &amp;quot;note&amp;quot;]
                &amp;quot;[root] alicloud_instance.wanzi_test (expand)&amp;quot; -&amp;gt; &amp;quot;[root] alicloud_security_group.default (expand)&amp;quot;
                &amp;quot;[root] alicloud_instance.wanzi_test (expand)&amp;quot; -&amp;gt; &amp;quot;[root] alicloud_vswitch.vsw (expand)&amp;quot;
                &amp;quot;[root] alicloud_instance.wanzi_test (expand)&amp;quot; -&amp;gt; &amp;quot;[root] var.disk_category&amp;quot;
                &amp;quot;[root] alicloud_instance.wanzi_test (expand)&amp;quot; -&amp;gt; &amp;quot;[root] var.ecs_password&amp;quot;
                &amp;quot;[root] alicloud_instance.wanzi_test (expand)&amp;quot; -&amp;gt; &amp;quot;[root] var.ecs_type&amp;quot;
                &amp;quot;[root] alicloud_instance.wanzi_test (expand)&amp;quot; -&amp;gt; &amp;quot;[root] var.image_id&amp;quot;
                &amp;quot;[root] alicloud_security_group.default (expand)&amp;quot; -&amp;gt; &amp;quot;[root] alicloud_vpc.vpc (expand)&amp;quot;
                &amp;quot;[root] alicloud_security_group_rule.allow_all_tcp (expand)&amp;quot; -&amp;gt; &amp;quot;[root] alicloud_security_group.default (expand)&amp;quot;
                &amp;quot;[root] alicloud_vpc.vpc (expand)&amp;quot; -&amp;gt; &amp;quot;[root] provider[\&amp;quot;registry.terraform.io/aliyun/alicloud\&amp;quot;]&amp;quot;
                &amp;quot;[root] alicloud_vswitch.vsw (expand)&amp;quot; -&amp;gt; &amp;quot;[root] alicloud_vpc.vpc (expand)&amp;quot;
                &amp;quot;[root] alicloud_vswitch.vsw (expand)&amp;quot; -&amp;gt; &amp;quot;[root] var.availability_zone&amp;quot;
                &amp;quot;[root] meta.count-boundary (EachMode fixup)&amp;quot; -&amp;gt; &amp;quot;[root] alicloud_instance.wanzi_test (expand)&amp;quot;
                &amp;quot;[root] meta.count-boundary (EachMode fixup)&amp;quot; -&amp;gt; &amp;quot;[root] alicloud_security_group_rule.allow_all_tcp (expand)&amp;quot;
                &amp;quot;[root] meta.count-boundary (EachMode fixup)&amp;quot; -&amp;gt; &amp;quot;[root] var.disk_size&amp;quot;
                &amp;quot;[root] meta.count-boundary (EachMode fixup)&amp;quot; -&amp;gt; &amp;quot;[root] var.internet_charge_type&amp;quot;
                &amp;quot;[root] meta.count-boundary (EachMode fixup)&amp;quot; -&amp;gt; &amp;quot;[root] var.internet_max_bandwidth_out&amp;quot;
                &amp;quot;[root] provider[\&amp;quot;registry.terraform.io/aliyun/alicloud\&amp;quot;] (close)&amp;quot; -&amp;gt; &amp;quot;[root] alicloud_instance.wanzi_test (expand)&amp;quot;
                &amp;quot;[root] provider[\&amp;quot;registry.terraform.io/aliyun/alicloud\&amp;quot;] (close)&amp;quot; -&amp;gt; &amp;quot;[root] alicloud_security_group_rule.allow_all_tcp (expand)&amp;quot;
                &amp;quot;[root] provider[\&amp;quot;registry.terraform.io/aliyun/alicloud\&amp;quot;]&amp;quot; -&amp;gt; &amp;quot;[root] var.alicloud_access_key&amp;quot;
                &amp;quot;[root] provider[\&amp;quot;registry.terraform.io/aliyun/alicloud\&amp;quot;]&amp;quot; -&amp;gt; &amp;quot;[root] var.alicloud_secret_key&amp;quot;
                &amp;quot;[root] provider[\&amp;quot;registry.terraform.io/aliyun/alicloud\&amp;quot;]&amp;quot; -&amp;gt; &amp;quot;[root] var.region&amp;quot;
                &amp;quot;[root] root&amp;quot; -&amp;gt; &amp;quot;[root] meta.count-boundary (EachMode fixup)&amp;quot;
                &amp;quot;[root] root&amp;quot; -&amp;gt; &amp;quot;[root] provider[\&amp;quot;registry.terraform.io/aliyun/alicloud\&amp;quot;] (close)&amp;quot;
        }
}

&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;è¯¥å‘½ä»¤çš„ç»“æœè¿˜å¯ä»¥é€šè¿‡å‘½ä»¤ terraform graph | dot -Tsvg &amp;gt; graph.svg ç›´æ¥å¯¼å‡ºä¸ºä¸€å¼ å›¾ç‰‡ï¼ˆéœ€è¦æå‰å®‰è£…graphvizï¼š brew install graphviz ï¼‰&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;terraform graph | dot -Tsvg &amp;gt; ~/Downloads/graph.svg
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;æŸ¥çœ‹graph.svgå¯ä»¥çœ‹åˆ°å„ä¸ªèµ„æºä¹‹é—´å…³ç³»å›¾è°±ï¼š&lt;/p&gt;
&lt;h2 id=&#34;terraformå‘½ä»¤ä¹‹stateç®¡ç†&#34;&gt;terraformå‘½ä»¤ä¹‹Stateç®¡ç†&lt;/h2&gt;
&lt;h3 id=&#34;æŸ¥çœ‹å½“å‰stateé‡Œå­˜æ”¾æ‰€æœ‰èµ„æº&#34;&gt;æŸ¥çœ‹å½“å‰stateé‡Œå­˜æ”¾æ‰€æœ‰èµ„æº&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;# terraform state list
alicloud_instance.wanzi_test
alicloud_security_group.default
alicloud_security_group_rule.allow_all_tcp
alicloud_vpc.vpc
alicloud_vswitch.vsw
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;æŸ¥çœ‹æŸä¸€ä¸ªresourceå…·ä½“æ•°æ®&#34;&gt;æŸ¥çœ‹æŸä¸€ä¸ªresourceå…·ä½“æ•°æ®&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;# terraform state show alicloud_vswitch.vsw
# alicloud_vswitch.vsw:
resource &amp;quot;alicloud_vswitch&amp;quot; &amp;quot;vsw&amp;quot; {
    availability_zone = &amp;quot;cn-hangzhou-i&amp;quot;
    cidr_block        = &amp;quot;10.100.0.0/24&amp;quot;
    id                = &amp;quot;vsw-bp1wgpgz9z8y2lfsl2beo&amp;quot;
    vpc_id            = &amp;quot;vpc-bp1kulcyygsi727aay4hd&amp;quot;
}
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;ç§»é™¤ç‰¹å®šèµ„æº&#34;&gt;ç§»é™¤ç‰¹å®šèµ„æº&lt;/h3&gt;
&lt;p&gt;terraform state rm &amp;lt;èµ„æºç±»å‹&amp;gt;.&amp;lt;èµ„æºåç§°&amp;gt;
state rm å‘½ä»¤ç”¨äºå°†stateä¸­çš„æŸä¸ªèµ„æºç§»é™¤ï¼Œä½†æ˜¯å®é™…ä¸Šå¹¶ä¸ä¼šçœŸæ­£åˆ é™¤è¿™ä¸ªèµ„æºï¼Œå¦å¤–ä¹Ÿå¯ä»¥é€šè¿‡importæ“ä½œä»äº‘ç«¯æ¢å¤åˆ°æœ¬åœ°ã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# terraform state rm  alicloud_security_group.default
Removed alicloud_security_group.default
Successfully removed 1 resource instance(s).
# terraform state list
alicloud_instance.wanzi_test
alicloud_vpc.vpc
alicloud_vswitch.vsw
# terraform import alicloud_security_group.default sg-bp11s5pka9pxtj6pn4xq
alicloud_security_group.default: Importing from ID &amp;quot;sg-bp11s5pka9pxtj6pn4xq&amp;quot;...
alicloud_security_group.default: Import prepared!
  Prepared alicloud_security_group for import
alicloud_security_group.default: Refreshing state... [id=sg-bp11s5pka9pxtj6pn4xq]

Import successful!

The resources that were imported are shown above. These resources are now in
your Terraform state and will henceforth be managed by Terraform.
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;åˆ·æ–°èµ„æº&#34;&gt;åˆ·æ–°èµ„æº&lt;/h3&gt;
&lt;p&gt;terraform refreshåˆ·æ–°å½“å‰stateå†…å®¹ï¼Œè°ƒç”¨äº‘APIæ‹‰å–æœ€æ–°æ•°æ®å†™å…¥stateæ–‡ä»¶&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# terraform refresh
alicloud_vpc.vpc: Refreshing state... [id=vpc-bp1kulcyygsi727aay4hd]
alicloud_vswitch.vsw: Refreshing state... [id=vsw-bp1wgpgz9z8y2lfsl2beo]
alicloud_security_group.default: Refreshing state... [id=sg-bp11s5pka9pxtj6pn4xq]
alicloud_instance.wanzi_test: Refreshing state... [id=i-bp1gt9mb9asadff9r2zr]
&lt;/code&gt;&lt;/pre&gt;</description>
      
    </item>
    
    <item>
      <title>è‡ªåŠ¨åŒ–ç¼–æ’å·¥å…·Terraformä»‹ç»</title>
      <link>https://wnote.com/post/devops-terraform-about/</link>
      <pubDate>Wed, 24 Feb 2021 17:22:42 +0800</pubDate>
      
      <guid>https://wnote.com/post/devops-terraform-about/</guid>
      
        <description>&lt;h2 id=&#34;terraformæ˜¯ä»€ä¹ˆ&#34;&gt;Terraformæ˜¯ä»€ä¹ˆï¼Ÿï¼š&lt;/h2&gt;
&lt;p&gt;Terraformæ˜¯ç”±HashiCorpå…¬å¸åœ¨2014å¹´å·¦å³æ¨å‡ºçš„å¼€æºèµ„æºç¼–æ’å·¥å…·, ç›®å‰å‡ ä¹æ‰€æœ‰çš„ä¸»æµäº‘æœåŠ¡å•†éƒ½æ”¯æŒTerraformï¼ŒåŒ…æ‹¬é˜¿é‡Œäº‘ã€è…¾è®¯äº‘ã€åä¸ºäº‘ã€AWSã€Azureã€ç™¾åº¦äº‘ç­‰ç­‰ã€‚ç›®å‰å¾ˆå¤šå…¬å¸éƒ½åŸºäºterraformæ„å»ºè‡ªå·±çš„åŸºç¡€æ¶æ„ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;è¯ç”ŸèƒŒæ™¯ï¼š
ä¼ ç»Ÿè¿ç»´æ¨¡å¼ä¸‹ï¼Œä¸šåŠ¡ä¸Šçº¿éœ€ç»è¿‡è®¾å¤‡é‡‡è´­ï¼Œæœºå™¨ä¸Šæ¶ï¼Œç½‘ç»œç¯å¢ƒæ­å»ºå’Œç³»ç»Ÿå®‰è£…ç­‰å‡†å¤‡é˜¶æ®µã€‚éšç€äº‘è®¡ç®—çš„å…´èµ·ï¼Œå„å¤§å…¬æœ‰äº‘å‚å•†å‡æä¾›äº†éå¸¸å‹å¥½çš„äº¤äº’ç•Œé¢ï¼Œç”¨æˆ·å€ŸåŠ©ä¸€ä¸ªæµè§ˆå™¨å°±å¯ä»¥æŒ‰éœ€é‡‡è´­å„ç§äº‘èµ„æºï¼Œå¿«é€Ÿå®ç°ä¸šåŠ¡æ¶æ„çš„æ­å»ºã€‚ç„¶è€Œï¼Œéšç€ä¸šåŠ¡æ¶æ„çš„ä¸æ–­æ‰©å±•ï¼Œäº‘èµ„æºé‡‡è´­çš„è§„æ¨¡å’Œç§ç±»ä¹Ÿåœ¨æŒç»­å¢åŠ ã€‚å½“ç”¨æˆ·éœ€è¦å¿«é€Ÿé‡‡è´­å¤§é‡ä¸åŒç±»å‹çš„äº‘èµ„æºæ—¶ï¼Œäº‘ç®¡ç†é¡µé¢é—´å¤§é‡çš„äº¤äº’æ“ä½œåè€Œé™ä½äº†äº‘èµ„æºçš„é‡‡è´­æ•ˆç‡ã€‚åœ¨é˜¿é‡Œäº‘æ§åˆ¶å°ä¸Šåˆå§‹åŒ–ä¸€ä¸ªç»å…¸çš„VPCç½‘ç»œæ¶æ„ï¼Œä»åˆ›å»ºVPCã€äº¤æ¢æœºVSwitchåˆ°åˆ›å»ºNatç½‘å…³ã€å¼¹æ€§IPå†åˆ°é…ç½®è·¯ç”±ç­‰å·¥ä½œï¼Œå¤§æ¦‚è¦èŠ±è´¹20åˆ†é’Ÿç”šè‡³æ›´ä¹…ã€‚åŒæ—¶ï¼Œå·¥ä½œæˆæœçš„ä¸å¯å¤åˆ¶æ€§ï¼Œå¸¦æ¥çš„æ˜¯è·¨Regionå’Œè·¨äº‘å¹³å°åœºæ™¯ä¸‹çš„é‡å¤åŠ³åŠ¨ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;äº‹å®ä¸Šï¼Œå¯¹ä¸šåŠ¡è¿ç»´äººå‘˜è€Œè¨€ï¼Œåªå…³å¿ƒå¯¹èµ„æºçš„é…ç½®ï¼Œæ— éœ€å…³å¿ƒè¿™äº›èµ„æºçš„åˆ›å»ºæ­¥éª¤ã€‚å¦‚åŒå–å’–å•¡ï¼Œåªéœ€è¦å‘Šè¯‰æœåŠ¡å‘˜å–ä»€ä¹ˆï¼ŒåŠ ä¸åŠ å†°ç­‰å°±å¤Ÿäº†ã€‚å¦‚æœæœ‰ä¸€ä»½å®Œæ•´çš„äº‘èµ„æºé‡‡è´­æ¸…å•ï¼Œè¿™å¼ æ¸…å•æ¸…æ¥šçš„è®°å½•äº†æ‰€éœ€è¦è´­ä¹°çš„äº‘èµ„æºçš„ç§ç±»ï¼Œè§„æ ¼ï¼Œæ•°é‡ä»¥åŠå„äº‘èµ„æºä¹‹é—´çš„å…³ç³»ï¼Œç„¶åä¸€é”®å®Œæˆè´­ä¹°ï¼Œå¹¶ä¸”å½“ä¸šåŠ¡éœ€æ±‚å‘ç”Ÿå˜åŒ–æ—¶ï¼Œåªéœ€è¦å˜æ›´æ¸…å•å°±å¯ä»¥å®ç°å¯¹äº‘èµ„æºçš„å¿«é€Ÿå˜æ›´ï¼Œé‚£ä¹ˆæ•ˆç‡å°±ä¼šæé«˜å¾ˆå¤šã€‚åœ¨äº‘è®¡ç®—ä¸­è¿™è¢«ç§°ä½œèµ„æºç¼–æ’ï¼Œç›®å‰å¾ˆå¤šäº‘å¹³å°ä¹Ÿæä¾›äº†èµ„æºç¼–æ’çš„èƒ½åŠ›ï¼Œå¦‚é˜¿é‡Œäº‘çš„ROSï¼ŒAWSçš„CloudFormationç­‰ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;å°†äº‘èµ„æºã€æœåŠ¡æˆ–è€…æ“ä½œæ­¥éª¤ä»¥ä»£ç çš„å½¢å¼å®šä¹‰åœ¨æ¨¡æ¿ä¸­ï¼Œå€ŸåŠ©ç¼–æ’å¼•æ“ï¼Œå®ç°èµ„æºçš„è‡ªåŠ¨åŒ–ç®¡ç†ï¼Œè¿™å°±æ˜¯åŸºç¡€è®¾æ–½å³ä»£ç ï¼ˆInfrastructure as Codeï¼Œç®€ç§°IaCï¼‰ï¼Œä¹Ÿæ˜¯èµ„æºç¼–æ’æœ€é«˜æ•ˆçš„å®ç°æ¨¡å¼ã€‚ç„¶è€Œï¼Œå¤šç§äº‘ç¼–æ’æœåŠ¡å¸¦æ¥çš„æ˜¯é«˜æ˜‚çš„å­¦ä¹ æˆæœ¬ã€ä½æ•ˆçš„ä»£ç å¤ç”¨ç‡å’Œå¤æ‚çš„å¤šäº‘ååŒå·¥ä½œæµç¨‹ã€‚æ¯ä¸€ç§æœåŠ¡ä»…é™äºç®¡ç†è‡ªå®¶çš„å•ä¸€äº‘å¹³å°ä¸Šï¼Œæ— æ³•æ»¡è¶³å¯¹å¤šä¸ªäº‘å¹³å°ï¼Œå¤šç§å±‚çº§ï¼ˆå¦‚IaaSï¼ŒPaaSï¼‰èµ„æºçš„ç»Ÿä¸€ç®¡ç†ã€‚å¦‚ä½•è§£å†³å¦‚ä¸Šé—®é¢˜ï¼Œæ˜¯å¦å¯ä»¥ä½¿ç”¨ç»Ÿä¸€çš„ç¼–æ’å·¥å…·ï¼Œå…±ç”¨ä¸€å¥—è¯­æ³•å®ç°å¯¹åŒ…æ‹¬é˜¿é‡Œäº‘åœ¨å†…çš„å¤šäº‘çš„ç»Ÿä¸€ç®¡ç†å‘¢ï¼Ÿæ‰€ä»¥è¿™ä¸ªæ—¶å€™å°±è¯ç”ŸTerraformï¼Œæ¥è§£å†³è¿™äº›é—®é¢˜ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&#34;terrafromåŠŸèƒ½å’Œä½œç”¨&#34;&gt;TerrafromåŠŸèƒ½å’Œä½œç”¨ï¼š&lt;/h2&gt;
&lt;h3 id=&#34;åŠŸèƒ½ç‚¹&#34;&gt;åŠŸèƒ½ç‚¹&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;IaCï¼šinfrastructure as codeï¼Œç”¨ä»£ç ç®¡ç†åŸºç¡€è®¾æ–½&lt;/li&gt;
&lt;li&gt;æ‰§è¡Œè®¡åˆ’ï¼šæ˜¾ç¤ºterraform applyæ—¶æ‰§è¡Œçš„æ“ä½œ&lt;/li&gt;
&lt;li&gt;èµ„æºå›¾ï¼šæ„å»ºæ‰€æœ‰èµ„æºçš„å›¾å½¢&lt;/li&gt;
&lt;li&gt;å˜æ›´è‡ªåŠ¨åŒ–ï¼šåŸºäºæ‰§è¡Œè®¡åˆ’å’Œèµ„æºå›¾ï¼Œå¯ä»¥æ¸…æ™°çŸ¥é“è¦å˜æ›´çš„å†…å®¹å’Œé¡ºåº
æ€»ç»“ï¼šterraformç”¨äºå„ç±»åŸºç¡€è®¾æ–½èµ„æºåˆå§‹åŒ–ï¼Œæ”¯æŒå¤šç§äº‘å¹³å°ï¼Œæ”¯æŒç¬¬ä¸‰æ–¹æœåŠ¡å¯¹æ¥&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;ä½œç”¨&#34;&gt;ä½œç”¨&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;ä½¿ç”¨ä¸åŒproviderçš„APIï¼ŒåŒ…è£…æŠ½è±¡æˆTerraformçš„æ ‡å‡†ä»£ç ç»“æ„&lt;/li&gt;
&lt;li&gt;ç”¨æˆ·ä¸éœ€è¦äº†è§£æ¯ä¸ªäº‘è®¡ç®—å‚å•†çš„APIç»†èŠ‚ï¼Œé™ä½äº†éƒ¨ç½²éš¾åº¦&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;terraformæ¶æ„&#34;&gt;Terraformæ¶æ„&lt;/h2&gt;
&lt;p&gt;Terraformæœ¬èº«æ˜¯åŸºäºæ’ä»¶çš„æ¶æ„ï¼Œå¯æ‰©å±•æ€§å¾ˆå¼ºï¼Œå¯ä»¥æ–¹ä¾¿ç¨‹åºå‘˜å¯¹Terraformè¿›è¡Œæ‰©å±•ã€‚Terraformä»é€»è¾‘ä¸Šå¯ä»¥åˆ†ä¸ºä¸¤å±‚ï¼Œæ ¸å¿ƒå±‚ï¼ˆTerraform Coreï¼‰å’Œæ’ä»¶å±‚ï¼ˆTerraform Providerï¼‰ã€‚&lt;/p&gt;
&lt;h3 id=&#34;æ ¸å¿ƒå±‚&#34;&gt;æ ¸å¿ƒå±‚&lt;/h3&gt;
&lt;p&gt;æ ¸å¿ƒå±‚å…¶å®å°±æ˜¯terraformçš„å‘½ä»¤è¡Œå·¥å…·ï¼Œå®ƒæ˜¯ç”¨goè¯­è¨€å¼€å‘çš„ï¼Œå®ƒè´Ÿè´£ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;è¯»å–.tfé…ç½®ï¼Œè¿›è¡Œå˜é‡æ›¿æ¢&lt;/li&gt;
&lt;li&gt;èµ„æºçŠ¶æ€æ–‡ä»¶ç®¡ç†&lt;/li&gt;
&lt;li&gt;åˆ†æèµ„æºå…³ç³»ï¼Œç»˜åˆ¶å›¾è°±&lt;/li&gt;
&lt;li&gt;ä¾èµ–å…³ç³»å›¾è°±ï¼Œåˆ›å»ºèµ„æº
æ ¹æ®ä¾èµ–å…³ç³»ï¼Œåˆ›å»ºèµ„æºï¼›å¯¹äºæ²¡æœ‰ä¾èµ–å…³ç³»çš„èµ„æºï¼Œä¼šå¹¶è¡Œè¿›è¡Œåˆ›å»º(ç¼ºçœ10ä¸ªå¹¶è¡Œè¿›ç¨‹ï¼‰ï¼Œè¿™ä¹Ÿæ˜¯Terraformèƒ½å¤Ÿé«˜æ•ˆå¿«é€Ÿç®¡ç†äº‘èµ„æºçš„åŸå› ã€‚&lt;/li&gt;
&lt;li&gt;ç”¨RPCè°ƒç”¨æ’ä»¶å±‚&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;æ’ä»¶å±‚&#34;&gt;æ’ä»¶å±‚&lt;/h3&gt;
&lt;p&gt;æ’ä»¶å±‚ä¹Ÿæ˜¯ç”±goè¯­è¨€å¼€å‘çš„ï¼ŒTerraformæœ‰è¶…è¿‡250ä¸ªä¸åŒçš„æ’ä»¶ï¼Œå®ƒä»¬è´Ÿè´£ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ¥å—æ ¸å¿ƒå±‚çš„RPCè°ƒç”¨&lt;/li&gt;
&lt;li&gt;å…·ä½“æä¾›æŸä¸€é¡¹æœåŠ¡çš„æ‰§è¡Œ&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;æ’ä»¶å±‚åˆæœ‰ä¸¤ç§ï¼š&lt;/p&gt;
&lt;h4 id=&#34;provider&#34;&gt;Provider&lt;/h4&gt;
&lt;p&gt;Providerï¼Œè´Ÿè´£ä¸å¤–ç•ŒAPIçš„é›†æˆï¼Œæ¯”å¦‚é˜¿é‡Œäº‘Providerå°±æä¾›äº†åœ¨é˜¿é‡Œäº‘åˆ›å»ºã€ä¿®æ”¹ã€åˆ é™¤äº‘èµ„æºçš„åŠŸèƒ½ã€‚è¿™ä¸ªæ’ä»¶è´Ÿè´£å’Œé˜¿é‡Œäº‘äº‘APIçš„æ¥å£äº¤äº’ï¼Œå¹¶æä¾›ä¸€å±‚æŠ½è±¡ï¼Œè¿™æ ·ç¨‹åºå‘˜å¯ä»¥åœ¨ä¸äº†è§£APIç»†èŠ‚çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡terraformæ¥ç¼–æ’èµ„æºã€‚å®ƒè´Ÿè´£ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å§‹åŒ–ä»¥åŠå¤–ç•ŒAPIé€šä¿¡&lt;/li&gt;
&lt;li&gt;å¤–ç•ŒAPIçš„è®¤è¯&lt;/li&gt;
&lt;li&gt;å®šä¹‰äº‘èµ„æºä¸å¤–ç•ŒæœåŠ¡çš„å…³ç³»&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;æ¯”å¦‚å¸¸è§provider:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;é˜¿é‡Œäº‘ï¼š https://github.com/aliyun/terraform-provider-alicloud
ç™¾åº¦äº‘ï¼šhttps://github.com/baidubce/terraform-provider-baiducloud
è…¾è®¯äº‘ï¼šhttps://github.com/tencentcloudstack/terraform-provider-tencentcloud
åä¸ºäº‘ï¼šhttps://github.com/huaweicloud/terraform-provider-huaweicloud
ucloudï¼šhttps://github.com/ucloud/terraform-provider-ucloud
qingcloudï¼šhttps://github.com/yunify/terraform-provider-qingcloud
AWSï¼šhttps://github.com/hashicorp/terraform-provider-aws
Azureï¼šhttps://github.com/terraform-providers/terraform-provider-azurerm
GoogleCloudï¼šhttps://github.com/hashicorp/terraform-provider-google
&lt;/code&gt;&lt;/pre&gt;&lt;h4 id=&#34;provisioner&#34;&gt;Provisioner&lt;/h4&gt;
&lt;p&gt;Provisionerï¼Œè´Ÿè´£åœ¨èµ„æºåˆ›å»ºæˆ–è€…åˆ é™¤å®Œæˆåï¼Œæ‰§è¡Œä¸€äº›è„šæœ¬ã€‚æ¯”å¦‚Puppet Provisionerå°±å¯ä»¥åœ¨äº‘è™šæ‹Ÿæœºèµ„æºåˆ›å»ºå®Œæˆåï¼Œåœ¨è¯¥èµ„æºä¸Šä¸‹è½½ã€å®‰è£…ã€é…ç½®Puppet agentã€‚&lt;/p&gt;
&lt;p&gt;ä¸ºäº†æ–¹ä¾¿ç†è§£,ç½‘ç»œä¸Šæ‰¾äº†ä¸€ä¸ªç»„ä»¶æ¶æ„å›¾ï¼Œç®€å•è¯´æ˜å„ä¸ªç»„ä»¶ä½ç½®ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://wnote.com/images/2021/terraform-about.png&#34; alt=&#34;terraformæ¶æ„å›¾&#34;&gt;&lt;/p&gt;
&lt;p&gt;å¯¹äºterraformæ—¥å¸¸æ“ä½œï¼Œæˆ‘ç”»äº†ä¸€ä¸ªåŸºæœ¬workflowæµç¨‹å›¾å¦‚ä¸‹ï¼š
&lt;img src=&#34;https://wnote.com/images/2021/terraform-workflow.png&#34; alt=&#34;terraformæ“ä½œæµç¨‹å›¾&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;terraformå…³é”®å­—è§£é‡Š&#34;&gt;terraformå…³é”®å­—è§£é‡Šï¼š&lt;/h2&gt;
&lt;h3 id=&#34;å£°æ˜å¼è¯­è¨€hcl&#34;&gt;å£°æ˜å¼è¯­è¨€ï¼ˆHCLï¼‰ï¼š&lt;/h3&gt;
&lt;p&gt;Terraformæ˜¯é€šè¿‡HashiCorp Configuration Languageæ¥ç¼–å†™ä»£ç çš„ï¼ŒHCLæ˜¯å£°æ˜å¼çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç¨‹åºå‘˜ç”¨HCLæ¥æè¿°æ•´ä¸ªåŸºç¡€æ¶æ„åº”è¯¥æ˜¯ä»€ä¹ˆæ ·çš„ï¼Œç„¶åæŠŠå…·ä½“çš„å®æ–½å·¥ä½œäº¤ç»™Terraformå°±å¯ä»¥äº†ï¼Œç¨‹åºå‘˜ä¸éœ€è¦äº†è§£å®æ–½çš„å…·ä½“æ­¥éª¤å’Œç»†èŠ‚ï¼Œä¸éœ€è¦äº†è§£terraformå¦‚ä½•ä¸äº‘æœåŠ¡å•†çš„APIè¿›è¡Œå¯¹æ¥ã€‚Terraformä¼šæ ¹æ®ä»£ç ï¼Œè‡ªåŠ¨ä¸‹è½½ç›¸åº”çš„Providerå’ŒProvisioneræ¥è´Ÿè´£å…·ä½“æ­¥éª¤å’Œç»†èŠ‚ã€‚äºå£°æ˜å¼å¯¹åº”çš„æ˜¯å‘½ä»¤å¼ã€‚å‘½ä»¤å¼è¯­è¨€æ˜¯æŒ‰ç…§æ­¥éª¤æ‰§è¡Œçš„ï¼Œå…ˆåé¡ºåºå¾ˆé‡è¦ï¼Œå¯¹å›ºå®šè¾“å…¥æ‰§è¡Œå‘½ä»¤å¼è¯­è¨€ä¼šå¾—åˆ°å›ºå®šçš„è¾“å‡ºã€‚å£°æ˜å¼å’Œå‘½ä»¤å¼å¹¶æ— é«˜ä¸‹ä¹‹åˆ†ï¼Œåªæ˜¯åœ¨äº‘èµ„æºç¼–æ’è¿™ä¸€é¢†åŸŸï¼Œå£°æ˜å¼ä¼šæ¯”è¾ƒæ–¹ä¾¿å®ç°ã€‚æˆ‘ä»¬æ—¥å¸¸è§åˆ°çš„äº‘èµ„æºç¼–æ’å·¥å…·éƒ½æ˜¯å£°æ˜å¼çš„ï¼ŒåŒ…æ‹¬AWS CloudFormationã€Azure Resource Templateã€Google Cloud Deoplyment Managerã€‚å¤§å®¶å¦‚æœé€šè¿‡è°ƒç”¨è…¾è®¯äº‘APIæ¥åœ¨è…¾è®¯äº‘ä¸Šå®æ–½èµ„æºç¼–æ’ï¼Œé‚£é€šå¸¸å°±æ˜¯å‘½ä»¤å¼çš„ã€‚&lt;/p&gt;
&lt;h3 id=&#34;èµ„æºçŠ¶æ€æ–‡ä»¶state&#34;&gt;èµ„æºçŠ¶æ€æ–‡ä»¶(state)&lt;/h3&gt;
&lt;p&gt;Terraformåˆå§‹åŒ–ä»¥åï¼Œä¼šç”Ÿæˆä¸€ä¸ªçŠ¶æ€æ–‡ä»¶ï¼Œè¯¥çŠ¶æ€æ–‡ä»¶è®°å½•äº†æœ€è¿‘ä¸€æ¬¡æ“ä½œçš„æ—¶é—´ã€å„èµ„æºçš„ç›¸å…³å±æ€§ã€å„å˜é‡çš„å½“å‰å€¼ã€çŠ¶æ€æ–‡ä»¶çš„ç‰ˆæœ¬ã€ç­‰ç­‰ã€‚&lt;/p&gt;
&lt;p&gt;ä¸‹ä¸€æ¬¡å†æ“ä½œçš„æ—¶å€™ï¼Œterraformé¦–å…ˆä¼šæŠŠå½“å‰çŠ¶æ€æ–‡ä»¶ä¸äº‘æœåŠ¡å•†ä¸Šçš„çŠ¶æ€è¿›è¡Œä¸€æ¬¡æ›´æ–°ï¼Œæ‰¾å‡ºæ˜¯å¦åæœ‰è¢«åˆ é™¤æˆ–è€…æ›´æ”¹äº†çš„èµ„æºï¼Œç„¶åå†æ ¹æ®.tfæ–‡ä»¶ï¼Œå†³å®šé‚£äº›èµ„æºéœ€è¦åˆ é™¤ã€æ›´æ–°ã€åˆ›å»ºã€‚æ“ä½œå®Œæˆåï¼Œä¼šé‡æ–°ç”Ÿæˆä¸€ä¸ªçŠ¶æ€æ–‡ä»¶ã€‚&lt;/p&gt;
&lt;h3 id=&#34;terraformåå°backend&#34;&gt;Terraformåå°(backend)&lt;/h3&gt;
&lt;p&gt;èµ„æºçŠ¶æ€æ–‡ä»¶çš„å®Œæ•´æ€§æ¯”è¾ƒé‡è¦ï¼Œå¯¹äºè¿™äº›æ–‡ä»¶æˆ‘ä»¬è‡³å°‘éœ€è¦åšåˆ°åœ¨æ“ä½œå¼€å§‹æ—¶è‡ªåŠ¨åŠ é”ï¼Œç›´åˆ°æ“ä½œç»“æŸï¼Œè¿™æ ·åˆ«äººæ— æ³•æ›´æ”¹ï¼›å¦å¤–è¿˜éœ€è¦å¯¹èµ„æºç‰ˆæœ¬å˜æ›´è¿›è¡Œè·Ÿè¸ªï¼›å¯¹èµ„æºæ–‡ä»¶é‡Œæ•æ„Ÿä¿¡æ¯è¿›è¡Œè®¿é—®æ§åˆ¶ã€‚&lt;/p&gt;
&lt;p&gt;å› æ­¤backendè·Ÿèµ„æºçŠ¶æ€æ–‡ä»¶å¦‚ä½•è¯»å–ã€å­˜å‚¨ã€é”å®šï¼Œä»¥åŠterraform applyå¦‚ä½•æ‰§è¡Œä¸¥å¯†ç›¸å…³ã€‚&lt;/p&gt;
&lt;p&gt;terraformç¼ºçœä½¿ç”¨æœ¬åœ°åå°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒçŠ¶æ€æ–‡ä»¶ä¼šå­˜æ”¾åœ¨å½“å‰ç›®å½•ä¸‹ï¼Œterraformä»£ç çš„æ‰§è¡Œä¹Ÿåœ¨æœ¬åœ°è™šæ‹Ÿæœºè¿è¡Œã€‚è¿™å¯¹ä¸€ä¸ªäººç®¡ç†çš„äº‘èµ„æºæ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†å½“å›¢é˜Ÿäººå‘˜æ•°ç›®åŠ å¤šä»¥åï¼Œå¤§å®¶å¯èƒ½éƒ½æœ‰è‡ªå·±çš„å·¥ä½œå°ï¼Œä½†æ˜¯éœ€è¦ä¸€ä¸ªå…±æœ‰çš„åœ°æ–¹æ¥å­˜å‚¨èµ„æºçŠ¶æ€æ–‡ä»¶ã€‚è¿™æ˜¯åå°±å¯ä»¥ç”¨åˆ°è¿œç¨‹å­˜å‚¨ã€‚ç›®å‰terraformæ”¯æŒå¤šç§è¿œç¨‹å­˜å‚¨åå°ï¼ŒåŒ…æ‹¬AWS s3,Hashicorp Consul,etcdï¼ŒTerraformäº‘ï¼Œä»¥åŠterraformä¼ä¸šç‰ˆç­‰ç­‰ï¼Œè¿™äº›è¿œç¨‹åå°éƒ½æä¾›åœ¨è¿œç¨‹å­˜å‚¨ã€é”å®šçŠ¶æ€æ–‡ä»¶ã€‚å…¶ä¸­terraformä¼ä¸šç‰ˆæä¾›è¿œç¨‹è¿è¡Œterraformï¼Œä»¥åŠå…¶ä»–ä¸€äº›ä¼ä¸šçº§ç‰¹æ€§ã€‚&lt;/p&gt;
&lt;h3 id=&#34;terraformæ¨¡å—module&#34;&gt;Terraformæ¨¡å—(module)&lt;/h3&gt;
&lt;p&gt;Terraformæ¨¡å—å°±æ˜¯æŠŠä¸€äº›é«˜åº¦å¯é‡ç”¨çš„ä»£ç å†™æˆæ¨¡å—ï¼Œæ–¹ä¾¿å…¶ä»–äººä½¿ç”¨ã€‚æ¨¡å—ç”±è¾“å…¥å‚æ•°ã€è¾“å‡ºå‚æ•°ä»¥åŠä¸»é€»è¾‘ç»„æˆã€‚è¿™å°±è·Ÿä¼ ç»Ÿç¼–ç¨‹è¯­è¨€é‡Œçš„å‡½æ•°å¾ˆåƒã€‚Terraformæä¾›äº†å…¬å¼€çš„æ¨¡å—æ³¨å†Œå™¨ï¼Œæ¨¡å—ç¼–å†™å®Œæˆä»¥åï¼Œåªè¦ç¬¦åˆè§„èŒƒï¼Œå°±å¯ä»¥å‘å¸ƒåˆ°æ¨¡å—æ³¨å†Œå™¨ä¸­è®©å¤§å®¶ä½¿ç”¨ã€‚https://registry.terraform.io/&lt;/p&gt;
</description>
      
    </item>
    
    <item>
      <title>ArgoCDé…åˆJenkins Pipelineè‡ªåŠ¨åŒ–éƒ¨ç½²åº”ç”¨</title>
      <link>https://wnote.com/post/cicd-argocd-jenkins-pipeline/</link>
      <pubDate>Wed, 29 Jul 2020 15:22:42 +0800</pubDate>
      
      <guid>https://wnote.com/post/cicd-argocd-jenkins-pipeline/</guid>
      
        <description>&lt;h2 id=&#34;åˆ›å»ºhelmä»“åº“&#34;&gt;åˆ›å»ºhelmä»“åº“&lt;/h2&gt;
&lt;p&gt;é¦–å…ˆï¼Œåˆ›å»ºåŸºç¡€Helmæ¨¡ç‰ˆä»“åº“ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;helm create template .
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;å¯¹äºå®é™…çš„éƒ¨ç½²ä¸­ï¼Œéœ€è¦æ ¹æ®è‡ªå·±çš„ä¸šåŠ¡å®šåˆ¶è‡ªå·±çš„helmæ¨¡ç‰ˆï¼Œæˆ‘è¿™é‡Œç›´æ¥ä½¿ç”¨æˆ‘ä»¬å†…éƒ¨è‡ªå®šä¹‰çš„é€šç”¨æ¨¡ç‰ˆï¼Œæ–¹ä¾¿å¿«é€Ÿéƒ¨ç½²;å¦å¤–ä¹Ÿå¯ä»¥å‚è€ƒbitnamiå®¶ç»´æŠ¤çš„helm chart(&lt;a href=&#34;https://github.com/bitnami/charts/tree/master/bitnami&#34;&gt;https://github.com/bitnami/charts/tree/master/bitnami&lt;/a&gt;)&lt;/p&gt;
&lt;h2 id=&#34;jenkinså‡­è¯é…ç½®argocd-tokenä¿¡æ¯&#34;&gt;jenkinså‡­è¯é…ç½®argocd tokenä¿¡æ¯&lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;https://wnote.com/images/2020/argocd-jenkins-001.png&#34; alt=&#34;argocd and jenkins&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;é…ç½®jenkins-pipelineç¼–å†™&#34;&gt;é…ç½®jenkins pipelineç¼–å†™&lt;/h2&gt;
&lt;p&gt;è¿™é‡Œæˆ‘ä»¬ä»¥gotesté¡¹ç›®(&lt;a href=&#34;https://code.test.cn/hqliang/gotest&#34;&gt;https://code.test.cn/hqliang/gotest&lt;/a&gt;)ä¸ºä¾‹&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;pipeline {
    environment {
    GOPROXY = &amp;quot;http://repo.test.cn/repository/goproxy/&amp;quot;
    HUB_URL = &amp;quot;registry.test.cn&amp;quot;
        ARGOCD_SERVER=&amp;quot;qacd.test.cn&amp;quot;
    ARGOCD_PROJ=&amp;quot;test-project&amp;quot;
        ARGOCD_APP=&amp;quot;gotest&amp;quot;
    ARGOCD_REPO=&amp;quot;https://code.test.cn/devops/cicd/qa.git&amp;quot;
    ARGOCD_PATH=&amp;quot;devops/gotest&amp;quot;
    ARGOCD_CLUSTER=&amp;quot;https://172.16.19.250:8443&amp;quot;
        ARGOCD_NS=&amp;quot;default&amp;quot;
    }
 
    agent {
        node {
            label &#39;aiops&#39;
        }
    }
 
    stages {      
        stage (&#39;Docker_Build&#39;) {
            steps {
        withCredentials([[$class: &#39;UsernamePasswordMultiBinding&#39;,
                credentialsId: &#39;12ff2942-972c-4df3-8d2d-2cfcb25e00de&#39;,
                usernameVariable: &#39;DOCKER_HUB_USER&#39;,
                passwordVariable: &#39;DOCKER_HUB_PASSWORD&#39;]]) {
                sh &#39;&#39;&#39;
                TAG=$(git describe --tags  `git rev-list --tags --max-count=1`)
                            docker login registry.test.cn -u ${DOCKER_HUB_USER} -p ${DOCKER_HUB_PASSWORD}
                            make docker-all VERSION=$TAG
                    &#39;&#39;&#39;
            }
            }
        }
 
        stage (&#39;Deploy_K8S&#39;) {
             steps {
                     withCredentials([string(credentialsId: &amp;quot;qa-argocd&amp;quot;, variable: &#39;ARGOCD_AUTH_TOKEN&#39;)]) {
                        sh &#39;&#39;&#39;
            TAG=$(git describe --tags  `git rev-list --tags --max-count=1`)
            # create app
            ARGOCD_SERVER=$ARGOCD_SERVER argocd --grpc-web app create $ARGOCD_APP --project $ARGOCD_PROJ --repo $ARGOCD_REPO --path $ARGOCD_PATH --dest-namespace  $ARGOCD_NS --dest-server $ARGOCD_CLUSTER --upsert --insecure
                        # deploy app
                        ARGOCD_SERVER=$ARGOCD_SERVER argocd --grpc-web app set $ARGOCD_APP -p containers.tag=$TAG  --insecure
                        # Deploy to ArgoCD
                        ARGOCD_SERVER=$ARGOCD_SERVER argocd --grpc-web app sync $ARGOCD_APP  --force --insecure
                        ARGOCD_SERVER=$ARGOCD_SERVER argocd --grpc-web app wait $ARGOCD_APP  --timeout 600 --insecure
                        &#39;&#39;&#39;
               }
            }
        }
    }
}
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;é…ç½®gitlab-webhookè§¦å‘jenkins&#34;&gt;é…ç½®gitlab webhookè§¦å‘Jenkins&lt;/h2&gt;
&lt;h3 id=&#34;jenkinsé…ç½®è§¦å‘æ„å»º&#34;&gt;jenkinsé…ç½®è§¦å‘æ„å»º&lt;/h3&gt;
&lt;p&gt;&lt;img src=&#34;https://wnote.com/images/2020/argocd-jenkins-002.png&#34; alt=&#34;argocd and jenkins&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;gitlabé…ç½®webhook&#34;&gt;gitlabé…ç½®webhook&lt;/h3&gt;
&lt;p&gt;&lt;img src=&#34;https://wnote.com/images/2020/argocd-jenkins-003.png&#34; alt=&#34;argocd and jenkins&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;æ¨é€tagåˆ°è¿œç«¯åˆ†æ”¯&#34;&gt;æ¨é€tagåˆ°è¿œç«¯åˆ†æ”¯&lt;/h3&gt;
&lt;p&gt;&lt;img src=&#34;https://wnote.com/images/2020/argocd-jenkins-004.png&#34; alt=&#34;argocd and jenkins&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;jenkins-pipelineæ„å»º&#34;&gt;jenkins pipelineæ„å»º&lt;/h3&gt;
&lt;p&gt;åˆ°jenkinsæŸ¥çœ‹pipelineæ„å»ºç»“æœå¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;p&gt;dockerè‡ªåŠ¨æ‰“åŒ…å¹¶æ¨é€åˆ°harborä¸Š
&lt;img src=&#34;https://wnote.com/images/2020/argocd-jenkins-005.png&#34; alt=&#34;argocd and jenkins&#34;&gt;&lt;/p&gt;
&lt;p&gt;åˆ›å»ºArgoåº”ç”¨å¹¶åŒæ­¥éƒ¨ç½²åˆ°k8sé›†ç¾¤
&lt;img src=&#34;https://wnote.com/images/2020/argocd-jenkins-006.png&#34; alt=&#34;argocd and jenkins&#34;&gt;&lt;/p&gt;
&lt;p&gt;æœ€åæŸ¥çœ‹åŒæ­¥çŠ¶æ€ï¼Œé€”ä¸­è¯´æ˜å·²ç»æ­£å¸¸å‘å¸ƒåˆ°k8sé›†ç¾¤ï¼š
&lt;img src=&#34;https://wnote.com/images/2020/argocd-jenkins-007.png&#34; alt=&#34;argocd and jenkins&#34;&gt;&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬åˆ°argocdçš„dashboardçœ‹ä¸€ä¸‹åº”ç”¨æµç¨‹å›¾ï¼Œåº”ç”¨å„ä¸ªç»„ä»¶å·²ç»æ­£å¸¸è¿è¡Œã€‚
&lt;img src=&#34;https://wnote.com/images/2020/argocd-jenkins-008.png&#34; alt=&#34;argocd and jenkins&#34;&gt;&lt;/p&gt;
&lt;p&gt;é€šè¿‡kubectlè·å–å·²ç»åˆ›å»ºå¥½çš„èµ„æºï¼š
&lt;img src=&#34;https://wnote.com/images/2020/argocd-jenkins-009.png&#34; alt=&#34;argocd and jenkins&#34;&gt;&lt;/p&gt;
&lt;p&gt;æœ€åéªŒè¯ä¸€ä¸‹ä¸šåŠ¡æ˜¯å¦å¯ä»¥è®¿é—®å‘¢ï¼Œè®¿é—®http://gotest.test.cn/df å³å¯æŸ¥çœ‹å®¹å™¨ç£ç›˜ç©ºé—´&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://wnote.com/images/2020/argocd-jenkins-010.png&#34; alt=&#34;argocd and jenkins&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;æ€»ç»“ä¼˜åŒ–&#34;&gt;æ€»ç»“&amp;amp;ä¼˜åŒ–&lt;/h2&gt;
&lt;p&gt;æ— è®ºé€šè¿‡jenkinsçš„pipelineè¿˜æ˜¯é€šè¿‡gitlab CIæˆ‘ä»¬éƒ½å¯ä»¥æ›´å¥½çš„æ•´åˆargocd,æœ€ç»ˆå®ç°ä¸€é”®éƒ¨ç½²ä¸šåŠ¡åº”ç”¨.&lt;/p&gt;
</description>
      
    </item>
    
    <item>
      <title>argocdéƒ¨ç½²deploymentå‡ºç°: no space left on device</title>
      <link>https://wnote.com/post/kubernetes-error-no-space-left-on-device/</link>
      <pubDate>Mon, 18 May 2020 10:22:42 +0800</pubDate>
      
      <guid>https://wnote.com/post/kubernetes-error-no-space-left-on-device/</guid>
      
        <description>&lt;h1 id=&#34;æ•…éšœç°è±¡&#34;&gt;æ•…éšœç°è±¡&lt;/h1&gt;
&lt;p&gt;ä¸Šåˆé€šè¿‡argocdéƒ¨ç½²å‡ ä¸ªä¸šåŠ¡åº”ç”¨ï¼Œéƒ¨ç½²äº†2ä¸ªä»¥åï¼Œç¬¬ä¸‰æ–¹æ­»æ´»éƒ¨ç½²ä¸æˆåŠŸï¼Œç›¸åŒçš„é…ç½®ï¼ŒçŸ¥è¯†é›†ç¾¤ä¸ä¸€æ ·ï¼Œæ€ä¹ˆä¼šå‡ºç°è¿™æ ·çš„é—®é¢˜å‘¢ï¼Ÿ&lt;/p&gt;
&lt;p&gt;äºæ˜¯æŸ¥çœ‹äº†ä¸‹æ—¥å¿—,å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;  Warning  Failed     1m                kubelet, 172.16.25.13  Error: Error response from daemon: error creating overlay mount to /var/lib/docker/overlay2/ba37165607862efb350093e5e287207e2547759fd81dc4e5e356a86ac5e28324-init/merged: no space left on device
  Warning  Failed     1m                kubelet, 172.16.25.13  Error: Error response from daemon: error creating overlay mount to /var/lib/docker/overlay2/f69b62f360fc2a94487aca041b08d0929810beab0602e0ec8b90c94b2e893337-init/merged: no space left on device
  Warning  Failed     48s               kubelet, 172.16.25.13  Error: Error response from daemon: error creating overlay mount to /var/lib/docker/overlay2/a8d20a44183b39ae989eee8a442960124ff23844482f726ea7ab39a292aecbb3-init/merged: no space left on device
&lt;/code&gt;&lt;/pre&gt;&lt;h1 id=&#34;è§£å†³æ–¹æ³•&#34;&gt;è§£å†³æ–¹æ³•&lt;/h1&gt;
&lt;ol&gt;
&lt;li&gt;æ’æŸ¥ç£ç›˜ç©ºé—´,å‘ç°æ²¡æœ‰æ»¡&lt;/li&gt;
&lt;/ol&gt;
&lt;pre&gt;&lt;code&gt;root@gpu613:~# df -Th /
Filesystem     Type  Size  Used Avail Use% Mounted on
/dev/sda2      ext4  1.8T  359G  1.3T  22% /
&lt;/code&gt;&lt;/pre&gt;&lt;ol start=&#34;2&#34;&gt;
&lt;li&gt;ç»è¿‡è°·æ­Œï¼Œå‘ç°å¯èƒ½æ˜¯inotify watch è€—å°½å¯¼è‡´&lt;/li&gt;
&lt;/ol&gt;
&lt;pre&gt;&lt;code&gt;#cat /proc/sys/fs/inotify/max_user_watches
8192
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;å°è¯•ä¿®æ”¹fd watchçš„ç›®å½•æ•°é‡&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;echo &amp;quot;fs.inotify.max_user_watches=100000&amp;quot; &amp;gt;&amp;gt; /etc/sysctl.conf
sysctl -p
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;é‡æ–°å‘é€argocd syncåŒæ­¥åº”ç”¨ï¼Œå‘ç°è¿™æ¬¡æˆåŠŸåˆ›å»ºäº†deployment,æœçœŸæ˜¯è¿™è´§çš„åŸå› .&lt;/p&gt;
</description>
      
    </item>
    
    <item>
      <title>ArgoCDæ·»åŠ å¤šé›†ç¾¤</title>
      <link>https://wnote.com/post/cicd-argocd-add-clusters/</link>
      <pubDate>Tue, 05 May 2020 15:22:42 +0800</pubDate>
      
      <guid>https://wnote.com/post/cicd-argocd-add-clusters/</guid>
      
        <description>&lt;h2 id=&#34;ç”Ÿæˆargocdç®¡ç†ç”¨æˆ·token&#34;&gt;ç”Ÿæˆargocdç®¡ç†ç”¨æˆ·token&lt;/h2&gt;
&lt;p&gt;ç™»é™†dashboardï¼Œsettings&amp;ndash;&amp;gt;Accounts&amp;ndash;&amp;gt;admin&amp;ndash;&amp;gt;Generate New
ç”Ÿæˆåï¼Œè¯·è®°å½•ä¸‹tokenä¿¡æ¯ï¼Œç±»ä¼¼å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;fyJhbGciOiJ3UzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI2OWI0M2M0Mi01MmZiLTRlZmItODIxOC0yOWU3NGM5MWI0NDIiLCJpYXQiOjE1OTUzMTEx3zQsImlzcyI6ImFyZ29jZCIsIm5iZiI6MTU5NTMxMTE3NCwic3ViIjoib3duZXIifQ.9u4XzArEeaz7G2Q2TWusnTkakEmq9BYDAUHr3dC6wG5
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;é…ç½®argocd-config&#34;&gt;é…ç½®argocd config&lt;/h2&gt;
&lt;p&gt;å¯¹äºå¼€å¯äº†httpsè®¤è¯çš„argocdåœ¨æ·»åŠ é›†ç¾¤çš„æ—¶å€™æ¯”è¾ƒé¸¡è‚‹ï¼Œéœ€è¦ç™»é™†åˆ°serverç«¯PODé‡Œè¿›è¡Œé…ç½®ï¼Œå…·ä½“å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# cat ~/.argocd/config
contexts:
- name: argocd-server.argocd
  server: qacd.test.cn
  user: argocd-server.argocd
current-context: argocd-server.argocd
servers:
- grpc-web-root-path: &amp;quot;&amp;quot;
  insecure: true
  server: qacd.test.cn
users:
- auth-token: xxxxxx #è¿™é‡Œå°±æ˜¯ç¬¬ä¸€æ­¥ç”Ÿæˆtokenä¿¡æ¯
  name: argocd-server.argocd
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;é…ç½®kubeconfig&#34;&gt;é…ç½®kubeconfig&lt;/h2&gt;
&lt;p&gt;å…·ä½“é…ç½®è¿™é‡Œå¿½ç•¥ï¼Œè¯·å‚è€ƒä»¥å¾€æ–‡æ¡£ï¼Œå‰æè¦èƒ½è®¿é—®é›†ç¾¤å¹¶ä¸”æ˜¯é›†ç¾¤ç®¡ç†å‘˜ï¼Œè¿™é‡Œé…ç½®CONTEXTä¸ºidc-bj-k8s&lt;/p&gt;
&lt;h2 id=&#34;æ·»åŠ é›†ç¾¤&#34;&gt;æ·»åŠ é›†ç¾¤&lt;/h2&gt;
&lt;pre&gt;&lt;code&gt;#argocd  --grpc-web cluster  add  idc-bj-k8s  --kubeconfig ~/.kube/config
INFO[0000] ServiceAccount &amp;quot;argocd-manager&amp;quot; already exists in namespace &amp;quot;kube-system&amp;quot;
INFO[0000] ClusterRole &amp;quot;argocd-manager-role&amp;quot; updated
INFO[0000] ClusterRoleBinding &amp;quot;argocd-manager-role-binding&amp;quot; updated
Cluster &#39;https://172.16.16.250:8443&#39; added
#argocd --grpc-web cluster list
SERVER                          NAME        VERSION  STATUS      MESSAGE
https://172.16.16.250:8443      idc-bj-k8s  1.14     Successful
https://kubernetes.default.svc              1.14     Successful
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;ç›®å‰çœ‹åŒ—äº¬idcé›†ç¾¤å·²ç»æ·»åŠ åˆ°argocdé‡Œ,åè¾¹å°±å¯ä»¥å¾€é›†ç¾¤é‡Œéƒ¨ç½²åº”ç”¨å•¦å•¦&lt;/p&gt;
&lt;h2 id=&#34;åˆ é™¤é›†ç¾¤&#34;&gt;åˆ é™¤é›†ç¾¤&lt;/h2&gt;
&lt;pre&gt;&lt;code&gt;#argocd --grpc-web  cluster rm https://172.16.16.250:8443
#argocd --grpc-web cluster list
SERVER                          NAME        VERSION  STATUS      MESSAGE
https://kubernetes.default.svc              1.14     Successful
&lt;/code&gt;&lt;/pre&gt;</description>
      
    </item>
    
    <item>
      <title>ArgoCDå®‰éƒ¨éƒ¨ç½²</title>
      <link>https://wnote.com/post/cicd-argocd-install-in-k8s/</link>
      <pubDate>Fri, 01 May 2020 15:22:42 +0800</pubDate>
      
      <guid>https://wnote.com/post/cicd-argocd-install-in-k8s/</guid>
      
        <description>&lt;h2 id=&#34;å®‰è£…éƒ¨ç½²&#34;&gt;å®‰è£…éƒ¨ç½²&lt;/h2&gt;
&lt;p&gt;ArgoCDçš„éƒ¨ç½²éå¸¸ç®€å•ï¼Œå®‰è£…å®˜æ–¹çš„éƒ¨ç½²æ–¹æ³•(HAæ¨¡å¼ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl create namespace argocd
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/v1.5.2/manifests/ha/install.yaml
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;å¯ä»¥æŒ‰ç…§éœ€æ±‚è°ƒæ•´éƒ¨ç½²æ–‡ä»¶ï¼Œå¾…podé¡ºåˆ©å¯åŠ¨å&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# kubectl  -n argocd get pod
NAME                                             READY   STATUS    RESTARTS   AGE
argocd-application-controller-66fbf66657-ghf2c   1/1     Running   0          6d17h
argocd-application-controller-66fbf66657-gpm7d   1/1     Running   0          6d17h
argocd-application-controller-66fbf66657-tr5kd   1/1     Running   0          6d17h
argocd-dex-server-5c5f986596-c8ftv               1/1     Running   0          9d
argocd-redis-ha-haproxy-69c6df79c6-2fxd6         1/1     Running   0          9d
argocd-redis-ha-haproxy-69c6df79c6-mksg2         1/1     Running   0          9d
argocd-redis-ha-haproxy-69c6df79c6-wq57f         1/1     Running   0          9d
argocd-redis-ha-server-0                         2/2     Running   0          9d
argocd-redis-ha-server-1                         2/2     Running   0          9d
argocd-redis-ha-server-2                         2/2     Running   0          9d
argocd-repo-server-76bbb56cc7-d8fp5              1/1     Running   0          7d
argocd-repo-server-76bbb56cc7-qvl5z              1/1     Running   0          7d
argocd-repo-server-76bbb56cc7-xqrfn              1/1     Running   0          7d
argocd-server-6464c7bcd-fgktr                    1/1     Running   0          6d19h
argocd-server-6464c7bcd-jkqdb                    1/1     Running   0          6d19h
argocd-server-6464c7bcd-nfdwn                    1/1     Running   0          6d19h
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;é…ç½®ingressè®¿é—®argocd&#34;&gt;é…ç½®ingressè®¿é—®argocd&lt;/h2&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: argocd-server-ingress
  namespace: argocd
  annotations:
    kubernetes.io/ingress.class: traefik
    traefik.ingress.kubernetes.io/redirect-entry-point: https
spec:
  rules:
    - host: cd.testcn
      http:
        paths:
        - backend:
            serviceName: argocd-server
            servicePort: https
          path: /
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;é€šè¿‡https://cd.test.cn/è®¿é—®argocdï¼Œé»˜è®¤æœ¬åœ°ç”¨æˆ·åæ˜¯adminï¼Œå¯†ç æ˜¯å…¶ä¸­ä¸€ä¸ªpodçš„nameï¼Œè·å–å¯†ç ä½¿ç”¨å¦‚ä¸‹æ–¹æ³•ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# kubectl get pods -n argocd -l app.kubernetes.io/name=argocd-server -o name | cut -d&#39;/&#39; -f 2
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img src=&#34;https://wnote.com/images/2020/argocd-install-001.jpeg&#34; alt=&#34;argocd&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;ç”¨æˆ·ç®¡ç†&#34;&gt;ç”¨æˆ·ç®¡ç†&lt;/h2&gt;
&lt;p&gt;argocdé»˜è®¤ä½¿ç”¨æœ¬åœ°ç”¨æˆ·ï¼Œå¯ä»¥æ”¯æŒldapã€‚æœ¬åœ°ç”¨æˆ·ç®¡ç†ä½¿ç”¨ä¿®æ”¹argocd-cmè¿™ä¸ªconfigmapæ–¹å¼ï¼Œæ–°å¢ç”¨æˆ·å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: ConfigMap
metadata:
  annotations:
  labels:
    app.kubernetes.io/name: argocd-cm
    app.kubernetes.io/part-of: argocd
  name: argocd-cm
  namespace: argocd
data:
  accounts.chlai: apiKey,login  #å…è®¸ç”¨æˆ·loginå’Œç”Ÿæˆaipkey
  users.anonymous.enabled: &amp;quot;true&amp;quot;  #å…è®¸åŒ¿åç”¨æˆ·ç™»é™†ã€‚
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;ä¿®æ”¹å®Œä¿å­˜ç«‹å³ç”Ÿæ•ˆã€‚&lt;/p&gt;
&lt;p&gt;ç³»ç»Ÿé»˜è®¤çš„roleæœ‰readonlyå’Œadminä¸¤ä¸ªï¼Œæˆäºˆç”¨æˆ·adminçš„æƒé™æ–¹æ³•æ˜¯ä¿®æ”¹argocd-rbac-cmè¿™ä¸ªconfigmapï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: ConfigMap
metadata:
  labels:
    app.kubernetes.io/name: argocd-rbac-cm
    app.kubernetes.io/part-of: argocd
  name: argocd-rbac-cm
  namespace: argocd
data:
  policy.csv: |-
    g, chlai, role:admin
  policy.default: role:readonly  #åŒ¿åç™»é™†é»˜è®¤ä½¿ç”¨readonlyè§’è‰²ã€‚
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;ç”Ÿæˆç™»é™†å¯†ç éœ€è¦ä½¿ç”¨adminç”¨æˆ·cliæ–¹å¼login serverï¼Œé€šè¿‡argocd account update-passwordå‘½ä»¤ä¿®æ”¹ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;argocd login &amp;lt;argocd-server&amp;gt;
argocd account list
argocd account update-password \
  --account &amp;lt;name&amp;gt; \
  --current-password &amp;lt;current-admin&amp;gt; \
  --new-password &amp;lt;new-user-password&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;ä½¿ç”¨æ–°çš„ç”¨æˆ·å¯†ç ç™»é™†argocd web uiã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://wnote.com/images/2020/argocd-install-002.png&#34; alt=&#34;argocd&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;argocd-uiç•Œé¢æ¥åˆ›å»ºåº”ç”¨&#34;&gt;ArgoCD UIç•Œé¢æ¥åˆ›å»ºåº”ç”¨&lt;/h2&gt;
&lt;p&gt;ç‚¹å‡»â€œ+ NEW APPâ€æŒ‰é’®åˆ›å»ºåº”ç”¨ï¼›
&lt;img src=&#34;https://wnote.com/images/2020/argocd-install-003.png&#34; alt=&#34;argocd&#34;&gt;&lt;/p&gt;
&lt;p&gt;å¡«å†™åº”ç”¨åç§°ï¼šguestbookï¼›é¡¹ç›®ï¼šdefaultï¼›åŒæ­¥ç­–ç•¥ï¼šæ‰‹åŠ¨ï¼›&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://wnote.com/images/2020/argocd-install-004.png&#34; alt=&#34;argocd&#34;&gt;&lt;/p&gt;
&lt;p&gt;é…ç½®æ¥æºã€‚è¿™é‡Œé…ç½®çš„æ˜¯Git ï¼Œä»£ç ä»“åº“çš„URLé…ç½®ä¸º Githubä¸Šçš„é¡¹ç›®åœ°å€ä¸ºï¼šhttps://github.com/argoproj/argocd-example-apps.gitï¼›Revisioné€‰æ‹©ï¼šHEADï¼›é¡¹ç›®è·¯å¾„é€‰æ‹©ï¼šguestbookï¼›&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://wnote.com/images/2020/argocd-install-005.png&#34; alt=&#34;argocd&#34;&gt;&lt;/p&gt;
&lt;p&gt;é€‰æ‹©åº”ç”¨éƒ¨ç½²çš„ç›®æ ‡é›†ç¾¤ï¼šhttps://kubernetes.default.svc ï¼Œå› ä¸ºæ­¤æ¬¡çš„Argo CDéƒ¨ç½²åœ¨Kubernetesé›†ç¾¤å½“ä¸­ï¼Œé»˜è®¤Argo CDå·²ç»å¸®æˆ‘ä»¬æ·»åŠ å¥½å½“å‰æ‰€åœ¨çš„Kubernetesé›†ç¾¤ï¼Œç›´æ¥ä½¿ç”¨å³å¯ã€‚Namespaceé€‰æ‹©ï¼šmy-appã€‚Namespcaeå¯ä»¥åœ¨Kubernetesé›†ç¾¤ä¸Šä½¿ç”¨# kubectl create namespace my-app å‘½ä»¤æ¥åˆ›å»ºï¼›&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://wnote.com/images/2020/argocd-install-006.png&#34; alt=&#34;argocd&#34;&gt;&lt;/p&gt;
&lt;p&gt;å¡«å†™å®Œæˆåï¼Œç‚¹å‡» â€œCREATEâ€ æŒ‰é’®è¿›è¡Œåˆ›å»ºï¼›&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://wnote.com/images/2020/argocd-install-007.png&#34; alt=&#34;argocd&#34;&gt;&lt;/p&gt;
&lt;p&gt;ç”±äºå°šæœªéƒ¨ç½²åº”ç”¨ç¨‹åºï¼Œå¹¶ä¸”å°šæœªåˆ›å»ºKubernetesèµ„æºï¼Œæ‰€ä»¥Statusè¿˜æ˜¯OutOfSyncçŠ¶æ€ï¼Œå› æ­¤æˆ‘ä»¬è¿˜éœ€è¦ç‚¹å‡» â€œSYNCâ€æŒ‰é’®è¿›è¡ŒåŒæ­¥ï¼ˆéƒ¨ç½²ï¼‰ã€‚åŒæ—¶ä¹Ÿå¯ä»¥å®‰è£…argocdå®¢æˆ·ç«¯ï¼Œä½¿ç”¨Argo CD CLIè¿›è¡ŒåŒæ­¥ï¼š# argocd app sync guestbook&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://wnote.com/images/2020/argocd-install-008.png&#34; alt=&#34;argocd&#34;&gt;&lt;/p&gt;
&lt;p&gt;åº”ç”¨åˆ›å»ºå®Œæˆï¼Œå¤„äºâ€œæœªåŒæ­¥â€çŠ¶æ€ï¼Œæ‰‹åŠ¨åŒæ­¥åº”ç”¨ï¼Œå¼€å§‹éƒ¨ç½²åº”ç”¨
&lt;img src=&#34;https://wnote.com/images/2020/argocd-install-009.png&#34; alt=&#34;argocd&#34;&gt;&lt;/p&gt;
&lt;p&gt;ç­‰å¾…åº”ç”¨åˆ›å»ºå®Œæˆ
&lt;img src=&#34;https://wnote.com/images/2020/argocd-install-010.png&#34; alt=&#34;argocd&#34;&gt;&lt;/p&gt;
&lt;p&gt;åœ¨Kubernetesé›†ç¾¤ä¸­æŸ¥çœ‹åº”ç”¨&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://wnote.com/images/2020/argocd-install-011.png&#34; alt=&#34;argocd&#34;&gt;&lt;/p&gt;
</description>
      
    </item>
    
    <item>
      <title>Hugo&#43;Githubæ­å»ºä¸ªäººåšå®¢</title>
      <link>https://wnote.com/post/tools-hugo-github-blog/</link>
      <pubDate>Tue, 10 Mar 2020 16:22:42 +0800</pubDate>
      
      <guid>https://wnote.com/post/tools-hugo-github-blog/</guid>
      
        <description>&lt;h1 id=&#34;hugoä»‹ç»&#34;&gt;Hugoä»‹ç»&lt;/h1&gt;
&lt;p&gt;ä¹‹å‰åšå®¢ä¸€ç›´ä½¿ç”¨hexoæ­å»º,éšç€ç”¨golangè¶Šæ¥è¶Šå¤šï¼Œä¸€ç›´æƒ³æŠŠåšå®¢ä¹Ÿè¿ç§»åˆ°hugo,hugoå°±ä¸ç”¨å¤šè¯´äº†goè¯­è¨€ç¼–å†™çš„é™æ€ç½‘ç«™ç”Ÿæˆå™¨,ç®€å•ã€æ˜“ç”¨ã€é«˜æ•ˆã€æ˜“æ‰©å±•ã€å¿«é€Ÿéƒ¨ç½².&lt;/p&gt;
&lt;h1 id=&#34;å®‰è£…hugo&#34;&gt;å®‰è£…hugo&lt;/h1&gt;
&lt;p&gt;è¿™é‡Œä»¥macç¯å¢ƒä¸ºä¾‹:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;brew install hugo
hugo new site wanzi
cd wanzi
git clone https://github.com/xianmin/hugo-theme-jane.git --depth=1 themes/jane
cp -r themes/jane/exampleSite/content ./
cp themes/jane/exampleSite/config.toml ./
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;ä¿®æ”¹config.tomlä¿¡æ¯ä¸ºä½ è‡ªå·±åšå®¢ä¿¡æ¯&lt;/p&gt;
&lt;p&gt;æˆ‘ç½‘ç«™ç›®å½•ç»“æ„å¦‚ä¸‹:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;.
â”œâ”€â”€ LICENSE
â”œâ”€â”€ archetypes #å­˜æ”¾default.mdï¼Œå¤´æ–‡ä»¶æ ¼å¼
â”‚Â Â  â””â”€â”€ default.md
â”œâ”€â”€ config.toml
â”œâ”€â”€ content #æ•´ä¸ªç½‘ç«™é¡¹ç›®å…¨å±€é…ç½®
â”‚Â Â  â”œâ”€â”€ about.md
â”‚Â Â  â””â”€â”€ post
â”œâ”€â”€ data #å­˜æ”¾æ•°æ®æˆ–é…ç½®,å¯ä»¥æ˜¯json|toml|yaml
â”œâ”€â”€ layouts #å­˜æ”¾çš„æ˜¯ç½‘ç«™çš„æ¨¡æ¿æ–‡ä»¶
â”œâ”€â”€ public #hugoç¼–è¯‘åç”Ÿæˆçš„é™æ€æ–‡ä»¶
â”‚Â Â  â”œâ”€â”€ 404.html
â”‚Â Â  â”œâ”€â”€ about
â”‚Â Â  â”œâ”€â”€ atom.xml
â”‚Â Â  â”œâ”€â”€ categories
â”‚Â Â  â”œâ”€â”€ css
â”‚Â Â  â”œâ”€â”€ favicon.ico
â”‚Â Â  â”œâ”€â”€ fonts
â”‚Â Â  â”œâ”€â”€ icons
â”‚Â Â  â”œâ”€â”€ index.html
â”‚Â Â  â”œâ”€â”€ js
â”‚Â Â  â”œâ”€â”€ manifest.json
â”‚Â Â  â”œâ”€â”€ mark
â”‚Â Â  â”œâ”€â”€ posts
â”‚Â Â  â”œâ”€â”€ robots.txt
â”‚Â Â  â”œâ”€â”€ rss.xml
â”‚Â Â  â”œâ”€â”€ sitemap.xml
â”‚Â Â  â””â”€â”€ tags
â”œâ”€â”€ resources
â”‚Â Â  â””â”€â”€ _gen
â”œâ”€â”€ static #å­˜æ”¾å›¾ç‰‡,css,jssé™æ€èµ„æº
â””â”€â”€ themes #å­˜æ”¾ç½‘ç«™ä¸»é¢˜
    â””â”€â”€ jane
&lt;/code&gt;&lt;/pre&gt;&lt;h1 id=&#34;ç¼–å†™æ–‡ç« &#34;&gt;ç¼–å†™æ–‡ç« &lt;/h1&gt;
&lt;pre&gt;&lt;code&gt;hugo new content/posts/git-commands-base.md
&lt;/code&gt;&lt;/pre&gt;&lt;h1 id=&#34;æ¨é€åˆ°github&#34;&gt;æ¨é€åˆ°github&lt;/h1&gt;
&lt;pre&gt;&lt;code&gt;cd wanzi/public
git init 
git remote add origin https://github.com/iwz2099/wanzi
echo &amp;quot;wnote.com&amp;quot; &amp;gt; CNAME
git  add -A
git commit -m &amp;quot;initialization&amp;quot;
git push -u origin master
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;å¦‚æœä½¿ç”¨ä¸ªäººåŸŸå,åªéœ€è¦åœ¨githubä»“åº“ä¸‹åˆ›å»ºCNAMEæ–‡ä»¶å†™å…¥è‡ªå·±çš„åŸŸåå³å¯ï¼Œè¿™æ ·è®¿é—®wnote.comå°±å¯ä»¥è®¿é—®è‡ªå·±åšå®¢äº†ã€‚&lt;/p&gt;
</description>
      
    </item>
    
    <item>
      <title>kubernetesé›†ç¾¤æ·»åŠ ç”¨æˆ·</title>
      <link>https://wnote.com/post/kubernetes-add-user/</link>
      <pubDate>Tue, 31 Dec 2019 10:22:42 +0800</pubDate>
      
      <guid>https://wnote.com/post/kubernetes-add-user/</guid>
      
        <description>&lt;p&gt;ä¹‹å‰é€šè¿‡ansibleæ­å»ºäº†kubernetesé›†ç¾¤ç¯å¢ƒ,è¿™é‡Œéœ€æ±‚ä¸»è¦æ˜¯æ·»åŠ ä¸€ä¸ªç”¨æˆ·è¿›è¡Œæ—¥å¸¸ç®¡ç†ï¼Œå¹¶é™åˆ¶åˆ°æŒ‡å®šçš„namespaceï¼Œæ¥ä¸‹æ¥è¿›è¡Œæ“ä½œï¼š&lt;/p&gt;
&lt;h1 id=&#34;kubernetesä¸­ç”¨æˆ·&#34;&gt;kubernetesä¸­ç”¨æˆ·&lt;/h1&gt;
&lt;blockquote&gt;
&lt;p&gt;K8Sä¸­æœ‰ä¸¤ç§ç”¨æˆ·(User)â€”â€”æœåŠ¡è´¦å·(ServiceAccount)å’Œæ™®é€šæ„ä¹‰ä¸Šçš„ç”¨æˆ·(User), ServiceAccountæ˜¯ç”±K8Sç®¡ç†çš„ï¼Œè€ŒUseré€šå¸¸æ˜¯åœ¨å¤–éƒ¨ç®¡ç†ï¼ŒK8Sä¸å­˜å‚¨ç”¨æˆ·åˆ—è¡¨â€”â€”ä¹Ÿå°±æ˜¯è¯´ï¼Œæ·»åŠ /ç¼–è¾‘/åˆ é™¤ç”¨æˆ·éƒ½æ˜¯åœ¨å¤–éƒ¨è¿›è¡Œï¼Œæ— éœ€ä¸K8S APIäº¤äº’ï¼Œè™½ç„¶K8Så¹¶ä¸ç®¡ç†ç”¨æˆ·ï¼Œä½†æ˜¯åœ¨K8Sæ¥æ”¶APIè¯·æ±‚æ—¶ï¼Œæ˜¯å¯ä»¥è®¤çŸ¥åˆ°å‘å‡ºè¯·æ±‚çš„ç”¨æˆ·çš„ï¼Œå®é™…ä¸Šï¼Œæ‰€æœ‰å¯¹K8Sçš„APIè¯·æ±‚éƒ½éœ€è¦ç»‘å®šèº«ä»½ä¿¡æ¯(Useræˆ–è€…ServiceAccount)ï¼Œè¿™æ„å‘³ç€ï¼Œå¯ä»¥ä¸ºUseré…ç½®K8Sé›†ç¾¤ä¸­çš„è¯·æ±‚æƒé™&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;å¯¹äºkubernetesæ¥å—ç”¨æˆ·è¯·æ±‚çš„æ—¶å€™é€šå¸¸é‡‡å–å®¢æˆ·ç«¯è¯ä¹¦ã€é™æ€tokenæ–‡ä»¶ã€é™æ€å¯†ç æ–‡ä»¶ä¸‰ç§æ–¹å¼ï¼Œè¿™é‡Œæˆ‘ä»¬åªä»‹ç»è¯ä¹¦éªŒè¯ã€‚&lt;/p&gt;
&lt;h1 id=&#34;ç”Ÿæˆç”¨æˆ·è¯ä¹¦&#34;&gt;ç”Ÿæˆç”¨æˆ·è¯ä¹¦&lt;/h1&gt;
&lt;p&gt;å‡†å¤‡è¯ä¹¦ç”Ÿæˆæ–‡ä»¶csr,é€šè¿‡kubernetesçš„caç­¾å‘è¯ä¹¦,é€šå¸¸k8s api serverçš„caæ–‡ä»¶è·¯å¾„ä¸º/etc/kubernetes/pki/,è¿™é‡Œä¼šç”Ÿæˆcicd-admin-key.pem(ç§é’¥)å’Œcicd-admin.pem(è¯ä¹¦), å…·ä½“csrå¦‚ä½•ç”Ÿæˆå¯ä»¥å‚è€ƒï¼šhttps://wnote.com/post/linux-openssl-issue-private-certificate/&lt;/p&gt;
&lt;p&gt;è¿™é‡Œçš„csræ–‡ä»¶ä¼ é€’çš„ç”¨æˆ·åä¸ºcicd-admin&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# vim cicd-admin-csr.json
{
  &amp;quot;CN&amp;quot;: &amp;quot;cicd-admin&amp;quot;,
  &amp;quot;hosts&amp;quot;: [],
  &amp;quot;key&amp;quot;: {
    &amp;quot;algo&amp;quot;: &amp;quot;rsa&amp;quot;,
    &amp;quot;size&amp;quot;: 2048
  },
  &amp;quot;names&amp;quot;: [
    {
      &amp;quot;C&amp;quot;: &amp;quot;CN&amp;quot;,
      &amp;quot;ST&amp;quot;: &amp;quot;BeiJing&amp;quot;,
      &amp;quot;L&amp;quot;: &amp;quot;BeiJing&amp;quot;,
      &amp;quot;O&amp;quot;: &amp;quot;k8s&amp;quot;,
      &amp;quot;OU&amp;quot;: &amp;quot;System&amp;quot;
    }
  ]
}
# cd /etc/kubernetes/pki/ 
# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes  cicd-admin-csr.json | cfssljson -bare cicd-admin
# ls -l cicd-admin*
-rw-r--r-- 1 root root 1001 Dec 19 16:51 cicd-admin.csr
-rw-r--r-- 1 root root  224 Dec 19 16:50 cicd-admin-csr.json
-rw------- 1 root root 1675 Dec 19 16:51 cicd-admin-key.pem
-rw-r--r-- 1 root root 1387 Dec 19 16:51 cicd-admin.pem
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;ç”¨æˆ·æƒé™æ§åˆ¶rbac&#34;&gt;ç”¨æˆ·æƒé™æ§åˆ¶(RBAC)&lt;/h2&gt;
&lt;h3 id=&#34;åˆ›å»ºè§’è‰²&#34;&gt;åˆ›å»ºè§’è‰²&lt;/h3&gt;
&lt;p&gt;k8sä¸­rbacçš„è§’è‰²ä¸»è¦æœ‰ä¸¤ç§,æ™®é€šè§’è‰²(Role)å’Œé›†ç¾¤è§’è‰²(ClusterRole)ï¼ŒClusterRoleæ˜¯ç‰¹æ®Šçš„Role&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Roleå±äºæŸä¸ªå‘½åç©ºé—´; è€ŒClusterRoleå±äºæ•´ä¸ªé›†ç¾¤ï¼ŒåŒ…æ‹¬æ‰€æœ‰çš„å‘½åç©ºé—´&lt;/li&gt;
&lt;li&gt;ClusterRoleèƒ½å¤Ÿæˆäºˆé›†ç¾¤èŒƒå›´çš„æƒé™ï¼Œæ¯”å¦‚nodeèµ„æºçš„ç®¡ç†ï¼Œå¯ä»¥è¯·æ±‚å…¨å‘½åç©ºé—´çš„èµ„æº(é€šè¿‡æŒ‡å®š&amp;ndash;all-namespaces), é»˜è®¤æƒ…å†µä¸‹, K8Så†…ç½®äº†ä¸€ä¸ªåä¸ºadminçš„ClusterRoleï¼Œå®é™…ä½¿ç”¨ä¸­æ— éœ€åˆ›å»ºadmin Role&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;åœ¨cicdçš„namespaceä¸‹åˆ›å»ºä¸€ä¸ªroleä¸ºcicd-admin:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kind: Role
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  namespace: cicd
  name: cicd-admin
rules:
- apiGroups: [&amp;quot;&amp;quot;]
  resources: [&amp;quot;*&amp;quot;]
  verbs: [&amp;quot;*&amp;quot;]
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;ç»‘å®šç”¨æˆ·åˆ°æŒ‡å®šè§’è‰²&#34;&gt;ç»‘å®šç”¨æˆ·åˆ°æŒ‡å®šè§’è‰²&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;subjectsæŒ‡å®šè´¦æˆ·ç±»å‹å¯ä»¥æ˜¯Userä¹Ÿå¯ä»¥æ˜¯service accountï¼Œè¿™é‡ŒæŒ‡å®šçš„æ˜¯ç”¨æˆ·cicd-admin, roleRefæŒ‡å®šRoleBindingå¼•ç”¨è§’è‰²&lt;/p&gt;
&lt;/blockquote&gt;
&lt;pre&gt;&lt;code&gt;kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  name: cicd-admin-binding
  namespace: cicd
subjects:
- kind: User
  name: cicd-admin
  apiGroup: &amp;quot;&amp;quot;
roleRef:
  kind: Role
  name: admin
  apiGroup: &amp;quot;&amp;quot;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;æˆ–è€…é€šè¿‡kubectlè¿›è¡Œç»‘å®šä¹Ÿå¯ä»¥:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl create rolebinding cicd-admin-binding --role=admin --user=cicd-admin --namespace=cicd
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;æˆ–è€…ç»™ç”¨æˆ·ç»‘å®šåˆ°é»˜è®¤ClusterRoleçš„adminè§’è‰²,è€Œè¿™é‡Œcicd-adminå¦‚æœç»‘å®šäº†adminï¼Œå…¶æƒé™ä¹Ÿåªä¼šè¢«é™åˆ¶åœ¨cicdçš„namespace&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  name: cicd-admin-binding
  namespace: cicd
subjects:
- kind: User
  name: cicd-admin
  apiGroup: &amp;quot;&amp;quot;
roleRef:
  kind: ClusterRole
  name: admin
  apiGroup: &amp;quot;&amp;quot;
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;å®¢æˆ·ç«¯é…ç½®&#34;&gt;å®¢æˆ·ç«¯é…ç½®&lt;/h2&gt;
&lt;h3 id=&#34;è®¾ç½®é›†ç¾¤å‚æ•°&#34;&gt;è®¾ç½®é›†ç¾¤å‚æ•°&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;export KUBE_APISERVER=&amp;quot;https://cicd-k8s.test.cn:8443&amp;quot;
kubectl config set-cluster kubernetes \
--certificate-authority=/etc/kubernetes/ssl/ca.pem \
--embed-certs=true \
--server=${KUBE_APISERVER} \
--kubeconfig=cicd-admin.kubeconfig
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°&#34;&gt;è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;kubectl config set-credentials cicd-admin \
--client-certificate=/etc/kubernetes/ssl/cicd-admin.pem \
--client-key=/etc/kubernetes/ssl/cicd-admin-key.pem \
--embed-certs=true \
--kubeconfig=cicd-admin.kubeconfig
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°&#34;&gt;è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;kubectl config set-context kubernetes \
--cluster=kubernetes \
--user=cicd-admin \
--namespace=cicd \
--kubeconfig=cicd-admin.kubeconfig
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡&#34;&gt;è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;kubectl config use-context kubernetes --kubeconfig=cicd-admin.kubeconfig
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;å®¢æˆ·ç«¯ä½¿ç”¨&#34;&gt;å®¢æˆ·ç«¯ä½¿ç”¨&lt;/h3&gt;
&lt;p&gt;å°†kubeconfigæ–‡ä»¶è¦†ç›–~/.kube/config&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;cp cicd-admin.kubeconfig ~/.kube/config
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;è‡³æ­¤ï¼Œkubernetesæ·»åŠ ç”¨æˆ·å¹¶è¿›è¡Œæˆæƒè®¿é—®k8sé›†ç¾¤çš„ä»‹ç»å°±å‘Šä¸€æ®µè½ã€‚&lt;/p&gt;
</description>
      
    </item>
    
    <item>
      <title>kubernetesé›†ç¾¤éƒ¨ç½²traefik2.1</title>
      <link>https://wnote.com/post/kubernetes-traefik-v2.1-deploy/</link>
      <pubDate>Tue, 17 Dec 2019 10:22:42 +0800</pubDate>
      
      <guid>https://wnote.com/post/kubernetes-traefik-v2.1-deploy/</guid>
      
        <description>&lt;h2 id=&#34;æ¶æ„æ¦‚å¿µ&#34;&gt;æ¶æ„&amp;amp;æ¦‚å¿µ&lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;https://wnote.com/images/2019/routers.png&#34; alt=&#34;traefik v2.1 router&#34;&gt;&lt;/p&gt;
&lt;p&gt;Traefik2.xç‰ˆæœ¬ç›¸æ¯”1.7.xæ¶æ„æœ‰å¾ˆå¤§å˜åŒ–ï¼Œæ­£å¦‚ä¸Šè¾¹è¿™å¼ æ¶æ„å›¾ï¼Œæœ€ä¸»è¦çš„åŠŸèƒ½æ˜¯æ”¯æŒäº†TCPåè®®ã€å¢åŠ äº†Routeræ¦‚å¿µã€‚&lt;/p&gt;
&lt;p&gt;è¿™é‡Œæˆ‘ä»¬é‡‡ç”¨åœ¨kubernetesé›†ç¾¤éƒ¨ç½²Traefik2.1ï¼Œä¸šåŠ¡è®¿é—®é€šè¿‡haproxyè¯·æ±‚åˆ°traefik Ingressï¼Œä¸‹è¾¹æ˜¯æ­å»ºè¿‡ç¨‹æ¶‰åŠåˆ°ä¸€äº›æ¦‚å¿µï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;EntryPointsï¼šTraefikçš„ç½‘ç»œå…¥å£ï¼Œå®šä¹‰è¯·æ±‚æ¥å—çš„ç«¯å£(ä¸åˆ†httpæˆ–tcp)&lt;/li&gt;
&lt;li&gt;CRDï¼šKubernetes APIçš„æ‰©å±•&lt;/li&gt;
&lt;li&gt;IngressRouterï¼šå°†ä¼ å…¥è¯·æ±‚è½¬å‘åˆ°å¯ä»¥å¤„ç†è¯·æ±‚çš„æœåŠ¡ï¼Œå¦å¤–è½¬å‘è¯·æ±‚ä¹‹å‰å¯ä»¥é€šè¿‡MiddlewaresåŠ¨æ€æ›´æ–°è¯·æ±‚&lt;/li&gt;
&lt;li&gt;Middlewaresï¼šè¯·æ±‚åˆ°è¾¾æœåŠ¡ä¹‹å‰è¿›è¡ŒåŠ¨æ€å¤„ç†è¯·æ±‚å‚æ•°ï¼Œæ¯”å¦‚headeræˆ–è½¬å‘è§„åˆ™ç­‰ç­‰ã€‚&lt;/li&gt;
&lt;li&gt;TraefikServiceï¼šå¦‚æœæœCRDå®šä¹‰äº†äº†è¿™ç§ç±»å‹ï¼ŒIngressRouterå¯ä»¥ç›´æ¥å¼•ç”¨ï¼Œå¤„åœ¨IngressRouterå’ŒæœåŠ¡ä¹‹é—´,ç±»ä¼¼äºMaeshæ¶æ„ï¼Œæ›´é€‚åˆè¾ƒä¸ºå¤æ‚åœºæ™¯,ä¸€èˆ¬æƒ…å†µå¯ä»¥ä¸ä½¿ç”¨ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;kubernetesé…ç½®&#34;&gt;kubernetesé…ç½®&lt;/h2&gt;
&lt;h3 id=&#34;é…ç½®sslè¯ä¹¦&#34;&gt;é…ç½®SSLè¯ä¹¦&lt;/h3&gt;
&lt;p&gt;å› ä¸ºä¸šåŠ¡æœåŠ¡ä½¿ç”¨https,è¿™é‡Œå…ˆé…ç½®ä¸‹SSLè¯ä¹¦:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl -n cattle-system create secret tls tls-rancher-ingress --cert=test.cn.pem  --key=test.cn.key
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;é…ç½®é›†ç¾¤è®¿é—®æ§åˆ¶rbac&#34;&gt;é…ç½®é›†ç¾¤è®¿é—®æ§åˆ¶(RBAC)&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: ServiceAccount
metadata:
  name: traefik-ingress-controller
  namespace: kube-system
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  name: traefik-ingress-controller

rules:
  - apiGroups:
      - &amp;quot;&amp;quot;
    resources:
      - services
      - endpoints
      - secrets
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - extensions
    resources:
      - ingresses
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - extensions
    resources:
      - ingresses/status
    verbs:
      - update
  - apiGroups:
      - traefik.containo.us
    resources:
      - middlewares
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - traefik.containo.us
    resources:
      - ingressroutes
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - traefik.containo.us
    resources:
      - ingressroutetcps
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - traefik.containo.us
    resources:
      - tlsoptions
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - traefik.containo.us
    resources:
      - traefikservices
    verbs:
      - get
      - list
      - watch

---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  name: traefik-ingress-controller

roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: traefik-ingress-controller
subjects:
  - kind: ServiceAccount
    name: traefik-ingress-controller
    namespace: kube-system
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;tlså‚æ•°é…ç½®&#34;&gt;TLSå‚æ•°é…ç½®&lt;/h3&gt;
&lt;p&gt;é»˜è®¤é…ç½®TLS1.2,å½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨TLS1.3&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: traefik.containo.us/v1alpha1
kind: TLSOption
metadata:
  name: mytlsoption
  namespace: kube-system

spec:
  minversion: VersionTLS12
  snistrict: true
  ciphersuites:
    - TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
    - TLS_RSA_WITH_AES_256_GCM_SHA384
    - TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305
    - TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305
    - TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256
    - TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;crdé…ç½®&#34;&gt;CRDé…ç½®&lt;/h2&gt;
&lt;p&gt;è¿™é‡Œå®šä¹‰äº†IngressRouteã€Middlewareã€TLSOptionã€IngressRouteTCPã€TraefikService,å…¶ä¸­TraefikServiceæ˜¯åœ¨2.1ç‰ˆæœ¬æ–°å¢åŠ çš„CRD&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: ingressroutes.traefik.containo.us

spec:
  group: traefik.containo.us
  version: v1alpha1
  names:
    kind: IngressRoute
    plural: ingressroutes
    singular: ingressroute
  scope: Namespaced

---
apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: middlewares.traefik.containo.us
spec:
  group: traefik.containo.us
  version: v1alpha1
  names:
    kind: Middleware
    plural: middlewares
    singular: middleware
  scope: Namespaced

---
apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: tlsoptions.traefik.containo.us

spec:
  group: traefik.containo.us
  version: v1alpha1
  names:
    kind: TLSOption
    plural: tlsoptions
    singular: tlsoption
  scope: Namespaced

---
apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: ingressroutetcps.traefik.containo.us

spec:
  group: traefik.containo.us
  version: v1alpha1
  names:
    kind: IngressRouteTCP
    plural: ingressroutetcps
    singular: ingressroutetcp
  scope: Namespaced

---
apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: traefikservices.traefik.containo.us

spec:
  group: traefik.containo.us
  version: v1alpha1
  names:
    kind: TraefikService
    plural: traefikservices
    singular: traefikservice
  scope: Namespaced
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;traefikserviceé…ç½®&#34;&gt;TraefikServiceé…ç½®&lt;/h2&gt;
&lt;p&gt;TraefikServiceæœ‰ç‚¹ç±»ä¼¼Maeshè§£å†³æœåŠ¡ä¹‹é—´çš„è°ƒç”¨é€»è¾‘ï¼Œåªæ˜¯Maeshä¾èµ–corednsï¼›å¦å¤–traefik serviceè¿˜å¯ä»¥è®¾ç½®åç«¯æœåŠ¡æƒé‡ï¼Œé…ç½®æœåŠ¡çš„æµé‡é•œåƒã€‚&lt;/p&gt;
&lt;p&gt;è¿™é‡Œæˆ‘ä»¬é…ç½®traefik dashboardå’Œrancherçš„traefikserviceç±»å‹æœåŠ¡ï¼Œå…¶ä»–æœåŠ¡é…ç½®å¯ä»¥å‚è€ƒè¿™é‡Œrancherçš„traefik service, traefik serviceä¼šè½¬å‘è¯·æ±‚åˆ°kubernetes çš„æœåŠ¡ç±»å‹(ä¸Šä¸€ç« èŠ‚æˆ‘ä»¬å·²ç»é€šè¿‡helm3åˆ›å»ºäº†rancheræœåŠ¡)ï¼Œè¿™é‡Œåªæ˜¯ä¸¾ä¾‹è¯´æ˜ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: traefik.containo.us/v1alpha1
kind: TraefikService
metadata:
  name: traefik-webui-traefikservice
  namespace: kube-system

spec:
  weighted:
    services:
      - name: traefik-ingress-service
        weight: 1
        port: 8080

---
apiVersion: traefik.containo.us/v1alpha1
kind: TraefikService
metadata:t
  name: rancher-traefikservice
  namespace: cattle-system

spec:
  weighted:
    services:
      - name: rancher
        weight: 1
        port: 80
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;deploymenté…ç½®&#34;&gt;Deploymenté…ç½®&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;é…ç½®k8sæ ‡å‡†serviceæœåŠ¡&lt;/li&gt;
&lt;li&gt;åˆ›å»ºtraefik configmap,å¹¶é…ç½®entrypointså’Œé»˜è®¤SSLè¯ä¹¦&lt;/li&gt;
&lt;li&gt;Deploymentæ–¹å¼éƒ¨ç½²traefik ingress controller&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code&gt;kind: Service
apiVersion: v1
metadata:
  name: traefik-ingress-service
  namespace: kube-system
spec:
  selector:
    k8s-app: traefik-ingress-lb
  ports:
    - protocol: TCP
      port: 80
      nodePort: 23456
      name: http
    - protocol: TCP
      port: 443
      nodePort: 23457
      name: https
  type: NodePort

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: traefik-conf
  namespace: kube-system
data:
  traefik.toml: |
    [global]
      checkNewVersion = false
      sendAnonymousUsage = false
    [log]
      level = &amp;quot;DEBUG&amp;quot;
    [api]
      dashboard = true
    [metrics.prometheus]
      buckets = [0.1,0.3,1.2,5.0]
      entryPoint = &amp;quot;metrics&amp;quot;
    [entryPoints]
      [entryPoints.http]
        address = &amp;quot;:80&amp;quot;
      [entryPoints.https]
        address = &amp;quot;:443&amp;quot;
    [tls.stores]
      [tls.stores.default]
        [tls.stores.default.defaultCertificate]
          certFile = &amp;quot;/config/tls/test.cn.crt&amp;quot;
          keyFile  = &amp;quot;/config/tls/test.cn.key&amp;quot;
---
kind: Deployment
apiVersion: apps/v1
metadata:
  name: traefik
  namespace: kube-system
  labels:
    k8s-app: traefik-ingress-lb
spec:
  replicas: 1
  selector:
    matchLabels:
      k8s-app: traefik-ingress-lb
  template:
    metadata:
      labels:
        k8s-app: traefik-ingress-lb
        name: traefik-ingress-lb
    spec:
      serviceAccountName: traefik-ingress-controller
      terminationGracePeriodSeconds: 60
      nodeSelector:
        node-role.kubernetes.io/traefik: &amp;quot;true&amp;quot;
      volumes:
      - name: ssl
        secret:
          secretName: traefik-cert
      - name: config
        configMap:
          name: traefik-conf
      containers:
      - image: traefik:v2.1.1
        name: traefik-ingress-lb
        volumeMounts:
        - mountPath: &amp;quot;/config&amp;quot;
          name: &amp;quot;config&amp;quot;
        - mountPath: &amp;quot;/config/tls&amp;quot;
          name: &amp;quot;ssl&amp;quot;
        resources:
          limits:
            cpu: 1000m
            memory: 800Mi
          requests:
            cpu: 500m
            memory: 600Mi
        ports:
        - name: http
          containerPort: 80
          hostPort: 80
        - name: https
          containerPort: 443
          hostPort: 443
        args:
        - --entrypoints.http.Address=:80
        - --entrypoints.https.Address=:443
        - --api
        - --accesslog
        - --providers.file.directory=/config/
        - --providers.file.watch=true
        - --ping=true
        - --providers.kubernetescrd
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;ingressrouteré…ç½®&#34;&gt;IngressRouteré…ç½®&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;å®šä¹‰middlewareç»™rancheræœåŠ¡é…ç½®X-Forwarded-Protoçš„å¤´ä¿¡æ¯&lt;/li&gt;
&lt;li&gt;é…ç½®rancherçš„ingressrouteï¼Œå¹¶ä½¿ç”¨é»˜è®¤è¯ä¹¦&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: redirect-https
  namespace: kube-system
spec:
  redirectScheme:
    scheme: https

---
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: http-default-router
  namespace: kube-system
spec:
  entryPoints:
    - http
  routes:
  - match: HostRegexp(`{host:.+}`)
    kind: Rule
    services:
    - name: traefik-ingress-service
      kind: Service
      namespaces: kube-system
      port: 80
    middlewares:
    - name: redirect-https
  tls:
    options:
      name: mytlsoption
      namespaces: kube-system
    certResolver: default

---
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: traefik-webui
  namespace: kube-system
spec:
  entryPoints:
    - https
  routes:
  - match: Host(`traefik.test.cn`)
    kind: Rule
    services:
    - name: api@internal
      kind: TraefikService
      namespaces: kube-system
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;é…ç½®rancherçš„ingressroute&#34;&gt;é…ç½®Rancherçš„IngressRoute&lt;/h2&gt;
&lt;p&gt;ç”±äºæˆ‘è¿™é‡Œä½¿ç”¨rancherç®¡ç†é›†ç¾¤ï¼Œå®é™…ç¯å¢ƒå¯ä»¥æ ¹æ®ä½ è‡ªå·±éœ€æ±‚é…ç½®&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å®šä¹‰middlewareç»™rancheræœåŠ¡é…ç½®X-Forwarded-Protoçš„å¤´ä¿¡æ¯&lt;/li&gt;
&lt;li&gt;é…ç½®rancherçš„ingressrouteï¼Œå¹¶ä½¿ç”¨é»˜è®¤è¯ä¹¦&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: rancher-https-headers
  namespace: cattle-system
spec:
  headers:
    customRequestHeaders:
      X-Forwarded-Proto: &amp;quot;https&amp;quot;
---
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: rancher-tls
  namespace: cattle-system
spec:
  entryPoints:
  - https
  routes:
  - match: Host(`rancher.test.cn`)
    kind: Rule
    services:
    - name: rancher
      kind: Service
      namespaces: cattle-system
      port: 80
    middlewares:
    - name: rancher-https-headers
      namespaces: cattle-system

  tls:
    certResolver: default
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;ç»Ÿä¸€éƒ¨ç½²traefik21&#34;&gt;ç»Ÿä¸€éƒ¨ç½²traefik2.1&lt;/h2&gt;
&lt;pre&gt;&lt;code&gt;kubectl apply -f 01-crd.yaml
kubectl apply -f 02-rbac.yaml
kubectl apply -f 03-tlsoption.yaml
kubectl apply -f 04-traefikservices.yaml #éå¿…é¡»
kubectl apply -f 05-traefik.yaml
kubectl apply -f 06-ingressrouter.yaml
kubectl apply -f 06-ingressrouter-rancher.yaml
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;æ›´å¤šé…ç½®ä¿¡æ¯ï¼Œè¯·ç§»æ­¥æˆ‘çš„githubä»“åº“ï¼šhttps://github.com/iwz2099/kubecase/tree/master/traefik/v2&lt;/p&gt;
</description>
      
    </item>
    
    <item>
      <title>kubeaszéƒ¨ç½²k8sé›†ç¾¤</title>
      <link>https://wnote.com/post/kubernetes-kubeasz-deploy-automation/</link>
      <pubDate>Thu, 12 Dec 2019 10:22:42 +0800</pubDate>
      
      <guid>https://wnote.com/post/kubernetes-kubeasz-deploy-automation/</guid>
      
        <description>&lt;h2 id=&#34;ç¯å¢ƒå‡†å¤‡&#34;&gt;ç¯å¢ƒå‡†å¤‡&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;MasterèŠ‚ç‚¹&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code&gt;172.16.244.14
172.16.244.16
172.16.244.18
&lt;/code&gt;&lt;/pre&gt;&lt;ul&gt;
&lt;li&gt;NodeèŠ‚ç‚¹&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code&gt;172.16.244.25
172.16.244.27
&lt;/code&gt;&lt;/pre&gt;&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;MasterèŠ‚ç‚¹VIPåœ°å€: 172.16.243.13&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;éƒ¨ç½²å·¥å…·:Ansible/kubeasz&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;åˆå§‹åŒ–ç¯å¢ƒ&#34;&gt;åˆå§‹åŒ–ç¯å¢ƒ&lt;/h2&gt;
&lt;h3 id=&#34;å®‰è£…ansible&#34;&gt;å®‰è£…Ansible&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;apt update
apt-get install ansible expect
git clone https://github.com/easzlab/kubeasz
cd kubeasz
cp * /etc/ansible/
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;é…ç½®ansibleå…å¯†ç™»å½•&#34;&gt;é…ç½®ansibleå…å¯†ç™»å½•&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;ssh-keygen -t rsa -b 2048 #ç”Ÿæˆå¯†é’¥
./tools/yc-ssh-key-copy.sh  hosts root &#39;rootpassword&#39;
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;å‡†å¤‡äºŒè¿›åˆ¶æ–‡ä»¶&#34;&gt;å‡†å¤‡äºŒè¿›åˆ¶æ–‡ä»¶&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;cd tools
./easzup -D #é»˜è®¤æƒ…å†µéƒ½ä¼šä¸‹è½½åˆ°/etc/ansible/bin/ç›®å½•ä¸‹
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;é…ç½®hostsæ–‡ä»¶å¦‚ä¸‹&#34;&gt;é…ç½®hostsæ–‡ä»¶å¦‚ä¸‹:&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;[kube-master]
172.16.244.14
172.16.244.16
172.16.244.18

[etcd]
172.16.244.14 NODE_NAME=etcd1
172.16.244.16 NODE_NAME=etcd2
172.16.244.18 NODE_NAME=etcd3

#haproxy-keepalived
[haproxy]
172.16.244.14
172.16.244.16
172.16.244.18

[kube-node]
172.16.244.25
172.16.244.27


# [optional] loadbalance for accessing k8s from outside
[ex-lb]
172.16.244.14 LB_ROLE=backup EX_APISERVER_VIP=172.16.243.13 EX_APISERVER_PORT=8443
172.16.244.16 LB_ROLE=backup EX_APISERVER_VIP=172.16.243.13 EX_APISERVER_PORT=8443
172.16.244.18 LB_ROLE=master EX_APISERVER_VIP=172.16.243.13 EX_APISERVER_PORT=8443

# [optional] ntp server for the cluster
[chrony]
172.16.244.18

[all:vars]
# --------- Main Variables ---------------
# Cluster container-runtime supported: docker, containerd
CONTAINER_RUNTIME=&amp;quot;docker&amp;quot;

# Network plugins supported: calico, flannel, kube-router, cilium, kube-ovn
#CLUSTER_NETWORK=&amp;quot;flannel&amp;quot;
CLUSTER_NETWORK=&amp;quot;calico&amp;quot;

# Service proxy mode of kube-proxy: &#39;iptables&#39; or &#39;ipvs&#39;
PROXY_MODE=&amp;quot;ipvs&amp;quot;

# K8S Service CIDR, not overlap with node(host) networking
SERVICE_CIDR=&amp;quot;10.68.0.0/16&amp;quot;

# Cluster CIDR (Pod CIDR), not overlap with node(host) networking
CLUSTER_CIDR=&amp;quot;10.101.0.0/16&amp;quot;

# NodePort Range
NODE_PORT_RANGE=&amp;quot;20000-40000&amp;quot;

# Cluster DNS Domain
CLUSTER_DNS_DOMAIN=&amp;quot;cluster.local.&amp;quot;

# -------- Additional Variables (don&#39;t change the default value right now) ---
# Binaries Directory
bin_dir=&amp;quot;/opt/kube/bin&amp;quot;

# CA and other components cert/key Directory
ca_dir=&amp;quot;/etc/kubernetes/ssl&amp;quot;

# Deploy Directory (kubeasz workspace)
base_dir=&amp;quot;/etc/ansible&amp;quot;
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;éƒ¨ç½²k8sé›†ç¾¤&#34;&gt;éƒ¨ç½²K8Sé›†ç¾¤&lt;/h2&gt;
&lt;h3 id=&#34;åˆå§‹åŒ–é…ç½®&#34;&gt;åˆå§‹åŒ–é…ç½®&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;cd /etc/ansible
ansible-playbook 01.prepare.yml
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;è¿™ä¸ªè¿‡ç¨‹ä¸»è¦åšä¸‰ä»¶äº‹ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;chrony role: é›†ç¾¤èŠ‚ç‚¹æ—¶é—´åŒæ­¥[å¯é€‰]
deploy role: åˆ›å»ºCAè¯ä¹¦ã€kubeconfigã€kube-proxy.kubeconfig
prepare role: åˆ†å‘CAè¯ä¹¦ã€kubectlå®¢æˆ·ç«¯å®‰è£…ã€ç¯å¢ƒé…ç½®
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;å®‰è£…etcdé›†ç¾¤&#34;&gt;å®‰è£…etcdé›†ç¾¤&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;ansible-playbook 02.etcd.yml
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;å®‰è£…docker&#34;&gt;å®‰è£…docker&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;ansible-playbook 03.docker.yml
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;éƒ¨ç½²kubernetes-master&#34;&gt;éƒ¨ç½²kubernetes master&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;ansible-playbook 04.kube-master.yml
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;éƒ¨ç½²kubernetes-node&#34;&gt;éƒ¨ç½²kubernetes node&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;ansible-playbook 05.kube-node.yml
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;éƒ¨ç½²kubernetes-networkè¿™é‡Œé€‰æ‹©calico&#34;&gt;éƒ¨ç½²kubernetes network(è¿™é‡Œé€‰æ‹©calico)&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;ansible-playbook 06.network.yml
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;éƒ¨ç½²ingressk8s-dashbaordcoredns&#34;&gt;éƒ¨ç½²ingress/k8s dashbaord/coredns&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;é…ç½®ingressæ‰€ç”¨sslè¯ä¹¦, è¿™é‡Œä»“åº“é»˜è®¤ä½¿ç”¨çš„traefik1.7.12,åè¾¹æˆ‘ä»¬æ‰“ç®—å‡çº§ä¸º2.0&lt;/p&gt;
&lt;/blockquote&gt;
&lt;pre&gt;&lt;code&gt;kubectl create secret tls traefik-cert --key=test.cn.key --cert=test.cn.pem  -n kube-system
secret/traefik-cert created
&lt;/code&gt;&lt;/pre&gt;&lt;blockquote&gt;
&lt;p&gt;éƒ¨ç½²é›†ç¾¤æ‰©å±•&lt;/p&gt;
&lt;/blockquote&gt;
&lt;pre&gt;&lt;code&gt;ansible-playbook 07.cluster-addon.yml
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;masterèŠ‚ç‚¹å–æ¶ˆæ±¡ç‚¹&#34;&gt;masterèŠ‚ç‚¹å–æ¶ˆæ±¡ç‚¹&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;é»˜è®¤éƒ¨ç½²å®Œåï¼ŒmasterèŠ‚ç‚¹çŠ¶æ€æ˜¯æ‰“äº†æ±¡ç‚¹ï¼Œä¸åœ¨è°ƒåº¦ç­–ç•¥å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;/blockquote&gt;
&lt;pre&gt;&lt;code&gt;# kubectl  get node
NAME            STATUS                     ROLES    AGE   VERSION
172.16.244.14   Ready,SchedulingDisabled   master   91m   v1.16.2
172.16.244.16   Ready,SchedulingDisabled   master   91m   v1.16.2
172.16.244.18   Ready,SchedulingDisabled   master   91m   v1.16.2
172.16.244.25   Ready                      node     90m   v1.16.2
172.16.244.27   Ready                      node     90m   v1.16.2
# kubectl  describe node  172.16.244.14 |grep Taint
Taints:             node.kubernetes.io/unschedulable:NoSchedule
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;ç”±äºæœºå™¨èµ„æºæœ‰é™ï¼Œæ‰€ä»¥æŠŠmasterä¹ŸåŠ å…¥è°ƒåº¦å¯ç”¨çŠ¶æ€&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# kubectl patch node 172.16.244.14 -p &#39;{&amp;quot;spec&amp;quot;:{&amp;quot;unschedulable&amp;quot;:false}}&#39;
# kubectl  get node
NAME            STATUS   ROLES    AGE   VERSION
172.16.244.14   Ready    master   95m   v1.16.2
172.16.244.16   Ready    master   95m   v1.16.2
172.16.244.18   Ready    master   95m   v1.16.2
172.16.244.25   Ready    node     94m   v1.16.2
172.16.244.27   Ready    node     94m   v1.16.2
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;éƒ¨ç½²å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨keepalivedhaproxy&#34;&gt;éƒ¨ç½²å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨(Keepalived+Haproxy)&lt;/h2&gt;
&lt;pre&gt;&lt;code&gt;ansible-playbook   roles/ex-lb/ex-lb.yml
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;éƒ¨ç½²rancher&#34;&gt;éƒ¨ç½²Rancher&lt;/h2&gt;
&lt;h3 id=&#34;å®‰è£…helm3&#34;&gt;å®‰è£…Helm3&lt;/h3&gt;
&lt;p&gt;å‚è€ƒ &lt;a href=&#34;https://rancher.com/docs/rancher/v2.x/en/installation/ha/helm-rancher/&#34;&gt;https://rancher.com/docs/rancher/v2.x/en/installation/ha/helm-rancher/&lt;/a&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;cd /opt/soft
wget https://get.helm.sh/helm-v3.0.1-linux-amd64.tar.gz
tar xf helm-v3.0.1-linux-amd64.tar.gz
cd linux-amd64/
cp helm  /usr/local/bin/
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;åˆ›å»ºè¯ä¹¦&#34;&gt;åˆ›å»ºè¯ä¹¦&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;å› ä¸ºç”±è‡ªå·±åŸŸåè¯ä¹¦,æ‰€ä»¥è¿™é‡Œä½¿ç”¨k8sçš„secretåˆ›å»ºçš„è¯ä¹¦,å½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨cert-managerå·¥å…·ç­¾å‘rancherè‡ªå·±çš„è¯ä¹¦æˆ–è€…ä½¿ç”¨letsEncrypt&lt;/p&gt;
&lt;/blockquote&gt;
&lt;pre&gt;&lt;code&gt;kubectl -n cattle-system create secret tls tls-rancher-ingress --cert=test.cn.pem  --key=test.cn.key
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;å®‰è£…rancher&#34;&gt;å®‰è£…rancher&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;helm repo add rancher-latest https://releases.rancher.com/server-charts/latest
helm repo update
helm install rancher rancher-latest/rancher \
  --namespace cattle-system \
  --set hostname=rancher-cicd.test.cn --set ingress.tls.source=secret
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;æ£€æŸ¥ingressèµ„æºå’Œéƒ¨ç½²çŠ¶æ€&#34;&gt;æ£€æŸ¥ingressã€èµ„æºå’Œéƒ¨ç½²çŠ¶æ€&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;# kubectl  get ingress  --all-namespaces
NAMESPACE       NAME      HOSTS                   ADDRESS   PORTS     AGE
cattle-system   rancher   rancher-cicd.test.cn             80, 443   20h
# kubectl -n cattle-system rollout status deploy/rancher
Waiting for deployment &amp;quot;rancher&amp;quot; rollout to finish: 0 of 3 updated replicas are available...
Waiting for deployment &amp;quot;rancher&amp;quot; rollout to finish: 1 of 3 updated replicas are available...
Waiting for deployment &amp;quot;rancher&amp;quot; rollout to finish: 2 of 3 updated replicas are available...
deployment &amp;quot;rancher&amp;quot; successfully rolled out
# kubectl -n cattle-system get deploy rancher
NAME      READY   UP-TO-DATE   AVAILABLE   AGE
rancher   3/3     3            3           5m5s
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;è‡³æ­¤ï¼Œæ•´ä¸ªK8Sé›†ç¾¤å·²ç»æ­å»ºå®Œæ¯•ï¼Œå¦‚æœé¡ºåˆ©çš„è¯ï¼Œæ•´ä¸ªè¿‡ç¨‹åº”è¯¥åœ¨10åˆ†é’Ÿå·¦å³ï¼Œé‡è¦çš„æ˜¯æå‰è§„åˆ’å¥½é›†ç¾¤ã€‚&lt;/p&gt;
</description>
      
    </item>
    
    <item>
      <title>åŸºäºK8Séƒ¨ç½²gitlab-runner</title>
      <link>https://wnote.com/post/cicd-gitlab-k8s-gitlabrunner/</link>
      <pubDate>Thu, 14 Nov 2019 17:22:42 +0800</pubDate>
      
      <guid>https://wnote.com/post/cicd-gitlab-k8s-gitlabrunner/</guid>
      
        <description>&lt;h2 id=&#34;éƒ¨ç½²gitlab-runner&#34;&gt;éƒ¨ç½²gitlab-runner&lt;/h2&gt;
&lt;p&gt;è¿™é‡ŒåŸºäºhelméƒ¨ç½²ï¼Œå‚è€ƒï¼šhttps://gitlab.com/gitlab-org/charts/gitlab-runner.git&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;helm install --namespace gitlab-managed-apps --name k8s-gitlab-runner -f  values.yaml 
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;æ³¨æ„ï¼švalues.yamlæ–‡ä»¶éœ€è¦è®¾ç½®privileged: true&lt;/p&gt;
&lt;h2 id=&#34;æ„å»ºåŸºç¡€é•œåƒdocker-in-docker&#34;&gt;æ„å»ºåŸºç¡€é•œåƒ(docker in docker)&lt;/h2&gt;
&lt;p&gt;Dockerfileæ–‡ä»¶å†…å®¹ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;FROM docker:19.03.1-dind
WORKDIR /opt
RUN echo &amp;quot;nameserver 114.114.114.114&amp;quot; &amp;gt;&amp;gt; /etc/resolv.conf
RUN sed -i &#39;s/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g&#39; /etc/apk/repositories
RUN apk update
RUN apk upgrade
RUN apk add g++ gcc make docker docker-compose  git
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;æ„å»ºé•œåƒå¹¶æ¨é€åˆ°harbor&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;docker build -t registry.test.cn/devops/docker-tool:19.03.1  .
docker push  registry.test.cn/devops/docker-tool:19.03.1
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;gitlab-ciæµ‹è¯•&#34;&gt;Gitlab-CIæµ‹è¯•&lt;/h2&gt;
&lt;p&gt;.gitlab-ci.ymlæ–‡ä»¶å†…å®¹å¦‚ä¸‹:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;image: registry.test.cn/devops/docker-tool:19.03.1

variables:
  REPO_NAME: gitlab.test.cn/xxx/xxxx
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: &amp;quot;&amp;quot;
  
before_script:
  - mkdir -p $GOPATH/src/$(dirname $REPO_NAME)
  - ln -svf $CI_PROJECT_DIR $GOPATH/src/$REPO_NAME
  - cd $GOPATH/src/$REPO_NAME

stages:
  - deploy

deploy:
  tags:
    - k8s-gitlab-runner #æŒ‡å®šrunner
  only:
    - tags
  stage: deploy
  services:
    - registry.test.cn/devops/docker-tool:19.03.1
  script:
    - export DOCKER_HOST=&#39;tcp://localhost:2375&#39;
    - docker login -u &amp;quot;$Harbor_bce_user&amp;quot; -p &amp;quot;$Harbor_ecs_passwd&amp;quot; $Harbor_ecs_address #gitlabåå°è®¾ç½®ç»Ÿä¸€å˜é‡
    - make deploy VERSION=$CI_COMMIT_REF_NAME #æ ¹æ®git tagæ„å»ºé•œåƒ
&lt;/code&gt;&lt;/pre&gt;</description>
      
    </item>
    
    <item>
      <title>åŸºäºDocker-composeæ­å»ºjenkins</title>
      <link>https://wnote.com/post/cicd-jenkins-install/</link>
      <pubDate>Mon, 11 Nov 2019 16:22:42 +0800</pubDate>
      
      <guid>https://wnote.com/post/cicd-jenkins-install/</guid>
      
        <description>&lt;h2 id=&#34;docker-composeé…ç½®&#34;&gt;docker-composeé…ç½®&lt;/h2&gt;
&lt;pre&gt;&lt;code&gt;version: &#39;2&#39;
 
services:
  jenkins:
    image: jenkins/jenkins:latest
    restart: always
    environment:
      JAVA_OPTS: &amp;quot;-Dorg.apache.commons.jelly.tags.fmt.timeZone=Asia/Shanghai -Djava.awt.headless=true -Dmail.smtp.starttls.enable=true&amp;quot;
    ports:
      - &amp;quot;80:8080&amp;quot;
      - &amp;quot;50000:50000&amp;quot;
    volumes:
      - &#39;/ssd/jenkins:/var/jenkins_home&#39;
      - &#39;/var/run/docker.sock:/var/run/docker.sock&#39;
      - &#39;/etc/localtime:/etc/localtime:ro&#39;
    dns: 223.5.5.5
    networks:
      - extnetwork
networks:
   extnetwork:
      ipam:
         config:
         - subnet: 172.255.0.0/16
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;å¯åŠ¨æœåŠ¡&#34;&gt;å¯åŠ¨æœåŠ¡&lt;/h2&gt;
&lt;pre&gt;&lt;code&gt;docker-compose  up -d 
&lt;/code&gt;&lt;/pre&gt;</description>
      
    </item>
    
    <item>
      <title>Macç³»ç»Ÿé…ç½®ç‚«é…·ç»ˆç«¯(oh my zsh)</title>
      <link>https://wnote.com/post/tools-zsh-cool-install/</link>
      <pubDate>Sat, 10 Nov 2018 10:22:42 +0800</pubDate>
      
      <guid>https://wnote.com/post/tools-zsh-cool-install/</guid>
      
        <description>&lt;h1 id=&#34;brewå·¥å…·&#34;&gt;brewå·¥å…·&lt;/h1&gt;
&lt;p&gt;å®˜ç½‘:https://brew.sh&lt;/p&gt;
&lt;p&gt;å®‰è£…brew&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;/usr/bin/ruby -e &amp;quot;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)&amp;quot;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;ä¿®æ”¹brewæºä¸ºå›½å†…æº&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;git -C &amp;quot;$(brew --repo)&amp;quot; remote set-url origin https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/brew.git
git -C &amp;quot;$(brew --repo homebrew/core)&amp;quot; remote set-url origin https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/homebrew-core.git
git -C &amp;quot;$(brew --repo homebrew/cask)&amp;quot; remote set-url origin https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/homebrew-cask.git
export HOMEBREW_BOTTLE_DOMAIN=https://mirrors.aliyun.com/homebrew/homebrew-bottles #è¿½åŠ åˆ°~/.zshrc
brew update  #æ›´æ–°homebrew
brew upgrade #å‡çº§æ‰€æœ‰å·²ç»å®‰è£…åŒ…
brew cleanup #å‡çº§å®Œæˆåæ¸…ç†æ—§ç‰ˆæœ¬åŒ…
&lt;/code&gt;&lt;/pre&gt;&lt;h1 id=&#34;iterm2&#34;&gt;iterm2&lt;/h1&gt;
&lt;p&gt;å®‰è£…iterm2&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;brew cask install iterm2
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;é…ç½®:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Preferences&amp;ndash;&amp;gt;Appearance&amp;ndash;&amp;gt;Theme é€‰æ‹©è‡ªå·±å–œæ¬¢ä¸»é¢˜,æˆ‘è¿™é‡Œé€‰æ‹©äº†Light&lt;/li&gt;
&lt;li&gt;Preferences&amp;ndash;&amp;gt;Profiles&amp;ndash;&amp;gt;Colors é…ç½®è‡ªå·±å–œæ¬¢é¢œè‰²&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&#34;oh-my-zsh&#34;&gt;Oh my zsh&lt;/h1&gt;
&lt;p&gt;å®˜ç½‘:https://ohmyz.sh&lt;/p&gt;
&lt;p&gt;å®‰è£…oh my zsh:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;sh -c &amp;quot;$(curl -fsSL https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh)&amp;quot;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;æ‰€æœ‰å¯é€‰oh my zshä¸»é¢˜: &lt;a href=&#34;https://github.com/ohmyzsh/ohmyzsh/wiki/Themes&#34;&gt;https://github.com/ohmyzsh/ohmyzsh/wiki/Themes&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;æ‰€æœ‰oh my zshæ’ä»¶: &lt;a href=&#34;https://github.com/ohmyzsh/ohmyzsh/wiki/Plugins&#34;&gt;https://github.com/ohmyzsh/ohmyzsh/wiki/Plugins&lt;/a&gt;&lt;/p&gt;
&lt;h1 id=&#34;ç‚«é…·ä¸»é¢˜&#34;&gt;ç‚«é…·ä¸»é¢˜&lt;/h1&gt;
&lt;p&gt;æˆ‘è¿™é‡Œé€‰æ‹©äº†è‡ªå·±å–œæ¬¢çš„&lt;a href=&#34;https://github.com/denysdovhan/spaceship-prompt&#34;&gt;spaceship-prompt&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;å®‰è£…ä¸»é¢˜æ‰€éœ€å­—ä½“å¹¶è®¾ç½®FiraCode&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;git clone https://github.com/powerline/fonts
cd fonts
./install.sh
brew tap homebrew/cask-fonts
brew cask install font-fira-code
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;å­—ä½“é€‰æ‹©ï¼šfira code&lt;/p&gt;
&lt;p&gt;è‡³æ­¤,æˆ‘çš„ç‚«é…·ç»ˆç«¯å·²ç»æå®šã€‚&lt;/p&gt;
</description>
      
    </item>
    
    <item>
      <title>Gitæ—¥å¸¸å‘½ä»¤æ€»ç»“</title>
      <link>https://wnote.com/post/linux-git-commands-base/</link>
      <pubDate>Sat, 28 Jul 2018 17:22:42 +0800</pubDate>
      
      <guid>https://wnote.com/post/linux-git-commands-base/</guid>
      
        <description>&lt;h2 id=&#34;gitå…¨å±€è®¾ç½®&#34;&gt;Gitå…¨å±€è®¾ç½®ï¼š&lt;/h2&gt;
&lt;pre&gt;&lt;code&gt;git config --global user.name &amp;quot;wanzi&amp;quot;
git config --global user.email &amp;quot;iwz2099@163.com&amp;quot;
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;gitæäº¤ä»£ç &#34;&gt;Gitæäº¤ä»£ç &lt;/h2&gt;
&lt;pre&gt;&lt;code&gt;git clone git@github.com:iwz2099/test.git
cd test
touch README.md
git add README.md
git commit -m &amp;quot;add README&amp;quot;
git push -u origin master
#ä¸Šé¢å‘½ä»¤å°†æœ¬åœ°çš„masteråˆ†æ”¯æ¨é€åˆ°è¿œç¨‹originåˆ†å€¼ï¼ŒåŒæ—¶-uæŒ‡å®šå½“å‰ä»“åº“çš„é»˜è®¤è¿œç¨‹åˆ†æ”¯åä¸ºoriginï¼Œåé¢å°±å¯ä»¥ä¸åŠ ä»»ä½•å‚æ•°ä½¿ç”¨git pushäº†

#åŒ…å«æœ¬åœ°åˆ†æ”¯éƒ½æ¨é€åˆ°originä¸»æœº
git push -u origin --all  

#å¦‚æœæœ¬åœ°æ˜¯åŸºäºcase_dev_wanziåˆ†æ”¯å¼€å‘,æ¨é€åˆ°è¿œç¨‹case_devåˆ†æ”¯
git push origin case_dev_wanzi:case_dev
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;gitæŸ¥è¯¢å’Œæ¸…ç†&#34;&gt;GitæŸ¥è¯¢å’Œæ¸…ç†&lt;/h2&gt;
&lt;pre&gt;&lt;code&gt;git status   #æŸ¥è¯¢å½“å‰åˆ†æ”¯çŠ¶æ€ä¿¡æ¯
git log      #æŸ¥çœ‹å½“å‰åˆ†æ”¯commitä¿¡æ¯
git log -n3  #æŸ¥è¯¢æœ€è¿‘ä¸‰æ¬¡æäº¤commit 
git log -p  -2  #æŸ¥è¯¢æ¯æ¬¡æäº¤çš„å†…å®¹å·®å¼‚ï¼Œåªæ˜¾ç¤ºæœ€è¿‘2æ¡æäº¤è®°å½•ï¼Œ
git log --stat  #æŸ¥è¯¢æ¯æ¬¡æäº¤çš„ç®€å†ç»Ÿè®¡ä¿¡æ¯
git log --pretty=oneline #å°†æ¯æ¬¡æäº¤çš„ä¿¡æ¯ä¸€è¡Œæ˜¾ç¤º,onelineå¯ä»¥æ˜¯short,full,fuller
git log --pretty=format:&amp;quot;%h - %an, %ar : %s&amp;quot;
git log --pretty=format:&amp;quot;%h %s&amp;quot; --graph  #ASCIIå­—ç¬¦ä¸²æ¥å½¢è±¡åœ°å±•ç¤ºä½ çš„åˆ†æ”¯ã€åˆå¹¶å†å²
git reflog #æ˜¾ç¤ºæ‰€æœ‰åˆ†æ”¯æ‰€æœ‰æ“ä½œä¿¡æ¯(åŒ…æ‹¬commit,resetå’Œå·²ç»åˆ é™¤çš„commit)
git reflog #æ˜¾ç¤ºæœ€è¿‘10æ¡æ—¥å¿—
git grep -n   wanzi  #æœç´¢æäº¤å†å²å’Œå·¥ä½œç›®å½•
git grep --count   wanzi  #æœç´¢æ˜¾ç¤ºæ¬¡æ•°
git clean  #ç§»é™¤æ²¡æœ‰å¿½ç•¥çš„æœªè·Ÿè¸ªæ–‡ä»¶
git clean -d  #æ¸…ç†å·¥ä½œç›®å½•
git clean -d -n  #-næµ‹è¯•æ¸…ç†å·¥ä½œç›®å½•ï¼Œå®é™…æœªæ¸…ç†
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;gitåˆ†æ”¯æ“ä½œ&#34;&gt;Gitåˆ†æ”¯æ“ä½œï¼š&lt;/h2&gt;
&lt;pre&gt;&lt;code&gt;git branch #æŸ¥çœ‹å½“å‰åˆ†æ”¯
git branch -v #æŸ¥çœ‹æ¯ä¸ªåˆ†æ”¯çš„æœ€åä¸€æ¬¡æäº¤
#åŸºäºè¿œç¨‹masteråˆ†æ”¯åˆ›å»ºæœ¬åœ°devåˆ†æ”¯
git checkout -b dev  origin/master 

git branch --merged #æŸ¥çœ‹å“ªäº›åˆ†æ”¯åˆå¹¶åˆ°å½“å‰åˆ†æ”¯
git branch --no-merged #æŸ¥çœ‹å“ªäº›åˆ†æ”¯å°šæœªåˆå¹¶åˆ°å½“å‰åˆ†æ”¯

#æ–°å¼€å‘ä¸€ä¸ªåŠŸèƒ½ï¼Œ-båˆ›å»ºåˆ†æ”¯ï¼Œå¹¶åˆ‡æ¢åˆ°æ–°åˆ›å»ºçš„åˆ†æ”¯ä¸Š
git checkout -b dev-20180720-111111-wanzi
ç›¸å½“äºï¼š
git branch r-20180720-111111-wanzi
git checkout r-20180720-111111-wanzi

å°†å¼€å‘ååŠŸèƒ½åˆå¹¶åˆ°Masterä¸»å¹²
git checkout master
git merge  dev-20180720-111111-wanzi
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;gitåˆå¹¶æ“ä½œ&#34;&gt;Gitåˆå¹¶æ“ä½œ&lt;/h2&gt;
&lt;pre&gt;&lt;code&gt;#åŸºäºè¿œç¨‹masteræ–°å»ºåˆ†æ”¯issue54,åŸºäºè¯¥åˆ†æ”¯è¿›è¡Œå¼€å‘é¡¹ç›®
git remote add origin git@github.com:iwz2099/test.git
git  checkout -b issue54  origin/master

#åŠŸèƒ½å¼€å‘å®Œåå‘æŠŠå¼€å‘åçš„åŠŸèƒ½åˆå¹¶åˆ°è¿œç¨‹åˆ†æ”¯
git  fetch origin    #æ‹‰å»å·®å¼‚ä¿¡æ¯
git  merge origin/master  #åˆå¹¶è¿œç¨‹åˆ†æ”¯åˆ°å½“å‰é¡¹ç›®
git  push origin master  #æ¨é€ä»£ç åˆ°è¿œç¨‹åˆ†æ”¯

git  log --no-merges issue54..origin/master  #æŸ¥çœ‹masterå“ªäº›ä¿¡æ¯æ²¡æœ‰åˆå¹¶åˆ°issue54åˆ†æ”¯é‡Œã€‚
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;git-tagæ“ä½œ&#34;&gt;Git tagæ“ä½œ&lt;/h2&gt;
&lt;pre&gt;&lt;code&gt;git tag   #åˆ—å‡ºå½“å‰é¡¹ç›®tagä¿¡æ¯
git tag -l &#39;wanzi-2018*&#39;   #-lè¿˜å¯ä»¥åªåˆ—å‡ºè‡ªå·±çš„åˆ†æ”¯
git tag  v1.8-20180720   #åˆ›å»ºæ ‡ç­¾ï¼ˆä¸€èˆ¬ä¸´æ—¶ç”¨ï¼‰
git tag -a  v1.8-20180720  -m &#39;wanzi version 1.8&#39;   #-aåˆ›å»ºtagï¼Œ-må¹¶æ·»åŠ è¯´æ˜ï¼Œä¼šå­˜å‚¨tagä¿¡æ¯
git  show  v1.8-20180720  #æŸ¥çœ‹æ ‡ç­¾ä¿¡æ¯ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥å¯¹æ¯”ä¸‹git tag -aå’Œgit tagå·®åˆ«
git push origin tag_name    #æ¨é€tagåˆ°è¿œç¨‹ä»“åº“
git push origin  --tags      #ä¸€æ¬¡æ€§æ¨é€å¾ˆå¤štagåˆ°è¿œç¨‹ä»“åº“
git push origin :tag_name   #åˆ é™¤è¿œç¨‹tagä¿¡æ¯
git checkout -b   dev-20180720-111111-wanzi    v1.2.0  #åŸºäºæŸä¸ªåˆ†æ”¯æ–°å»ºä¸€ä¸ªtagç‰ˆæœ¬
git branch -D  dev-20180720-123333-wanzi   #å¼ºåˆ¶åˆ é™¤ä¸€ä¸ªæ²¡æœ‰åˆå¹¶çš„åˆ†æ”¯
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;gitå¤šäººåä½œ&#34;&gt;Gitå¤šäººåä½œï¼š&lt;/h2&gt;
&lt;pre&gt;&lt;code&gt;#Aç å†œåŸºäºè¿œç¨‹masteræ–°å»ºåˆ†æ”¯feature1
git checkout -b feature1 origin/master

#Bç å†œåŸºäºè¿œç¨‹masteræ–°å»ºåˆ†æ”¯feature11
git checkout -b feature11 origin/master

#Aç å†œå…ˆå¼€å‘å®Œï¼Œå¹¶æ¨é€ä»£ç åˆ°è¿œç¨‹æœåŠ¡çš„feature1åˆ†æ”¯,Bç å†œåå¼€å‘å®Œï¼Œæƒ³æŠŠæ”¹è¿‡ä¿¡æ¯åˆå¹¶åˆ°feature1
git fetch origin
git merge origin/feature1
git push -u origin feature11:feature1
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;gitå–æ¶ˆæš‚å­˜åŒºæ–‡ä»¶å’Œå–æ¶ˆæ–‡ä»¶ä¿®æ”¹&#34;&gt;Gitå–æ¶ˆæš‚å­˜åŒºæ–‡ä»¶å’Œå–æ¶ˆæ–‡ä»¶ä¿®æ”¹&lt;/h2&gt;
&lt;pre&gt;&lt;code&gt;#ä»£ç git addåˆ°ç¼“å­˜åŒºï¼Œå¹¶æœªcommitæäº¤ï¼Œå›æ»šä»£ç 
git reset HEAD .  æˆ–è€…
git reset HEAD a.txt
è¿™ä¸ªå‘½ä»¤ä»…æ”¹å˜æš‚å­˜åŒºï¼Œå¹¶ä¸æ”¹å˜å·¥ä½œåŒºï¼Œè¿™æ„å‘³ç€åœ¨æ— ä»»ä½•å…¶ä»–æ“ä½œçš„æƒ…å†µä¸‹ï¼Œå·¥ä½œåŒºä¸­çš„å®é™…æ–‡ä»¶åŒè¯¥å‘½ä»¤è¿è¡Œä¹‹å‰æ— ä»»ä½•å˜åŒ–

git checkout --  .    #å–æ¶ˆè·¯å¾„æ‰€æœ‰ä¿®æ”¹ï¼Œå›åˆ°ä¸Šä¸€ä¸ªcommitç‰ˆæœ¬
git checkout -- a.txt #å–æ¶ˆa.txtæ‰€æœ‰æ”¹åŠ¨ï¼Œå›åˆ°ä¸Šä¸€ä¸ªcommitç‰ˆæœ¬
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;gitå›æ»šåˆ°ä¸Šæ¬¡æäº¤ç‰ˆæœ¬&#34;&gt;Gitå›æ»šåˆ°ä¸Šæ¬¡æäº¤ç‰ˆæœ¬&lt;/h2&gt;
&lt;pre&gt;&lt;code&gt;git log
git reset --hard  &amp;lt;commit_id&amp;gt;  #å›é€€ä¸€æ¬¡æäº¤çš„commit id
git reset --hard HEAD^  #å›é€€åˆ°ä¸Šä¸€ç‰ˆæœ¬ 
git reset --hard HEAD^^ #å›é€€åˆ°å€’æ•°ç¬¬äºŒç‰ˆ
git reset --hard HEAD~4 #å›é€€åˆ°å€’æ•°ç¬¬å››ç‰ˆ

git push origin HEAD --force # å¼ºåˆ¶æäº¤ä¸€æ¬¡ï¼Œä¹‹å‰é”™è¯¯çš„æäº¤å°±ä»è¿œç¨‹ä»“åº“åˆ é™¤(æ‹¥æœ‰é¡¹ç›®ç®¡ç†æƒé™çš„æ—¶å€™ä¸€å®šè¦æ…é‡)
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;gitå›æ»šmasterä»£ç åˆ°æŸä¸ªtagç‰ˆæœ¬&#34;&gt;Gitå›æ»šmasterä»£ç åˆ°æŸä¸ªtagç‰ˆæœ¬&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;åŸºäºrelease tagæ–°å»ºå›æ»šä¸´æ—¶åˆ†æ”¯ï¼Œå¹¶å°†åˆ†æ”¯å¼ºåˆ¶æ¨é€åˆ°è¿œç¨‹master&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code&gt;git checkout -b rollback_20180720  r-20180720-111225-wanzi
&lt;/code&gt;&lt;/pre&gt;&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;gitlabçš„é¡¹ç›®settingé‡Œmasteré¡¹ç›®ç®¡ç†å‘˜å–æ¶ˆmasterä¿æŠ¤&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;å¼ºåˆ¶æ¨é€rollback_20180720åˆ†æ”¯åˆ°è¿œç¨‹masterä¸»å¹²(è¿™ä¸ªè¿‡ç¨‹ä¼šå¼ºåˆ¶å›é€€åˆ°r-20180720-111225-wanziè¿™ä¸ªç‰ˆæœ¬)&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code&gt;git push origin rollback_20180720:master -f
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;gitå…¶ä»–æ“ä½œ&#34;&gt;Gitå…¶ä»–æ“ä½œ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;æäº¤ä¿¡æ¯å†™é”™ï¼Œè¿˜æ²¡æäº¤,ä¿®æ”¹æäº¤ä¿¡æ¯&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code&gt;git commit --amend --only -m &#39;fix: ä¿®å¤ä¸€ä¸ªbug&#39;  #ä¿®æ”¹æäº¤ä¿¡æ¯
&lt;/code&gt;&lt;/pre&gt;&lt;ul&gt;
&lt;li&gt;æäº¤ç”¨æˆ·åå’Œé‚®ç®±å†™é”™äº†ï¼Œè¿˜æ²¡æäº¤,ä¿®æ”¹æäº¤ä¿¡æ¯&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code&gt;git commit --amend --author=&amp;quot;wanzi &amp;lt;iwz2099@163.com&amp;gt;&amp;quot;
&lt;/code&gt;&lt;/pre&gt;</description>
      
    </item>
    
    <item>
      <title>Dockerfileå¤šé˜¶æ®µæ„å»º</title>
      <link>https://wnote.com/post/docker-dockerfile-multi-stage/</link>
      <pubDate>Mon, 02 Jul 2018 16:22:42 +0800</pubDate>
      
      <guid>https://wnote.com/post/docker-dockerfile-multi-stage/</guid>
      
        <description>&lt;p&gt;Dockerå¤šé˜¶æ®µæ„å»ºç†è§£:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ„å»ºé•œåƒéœ€è¦æœ‰ä¸€ä¸ªåŸºç¡€é•œåƒ,åç»­æ“ä½œå°±ä¼šåŸºäºè¯¥åŸºç¡€é•œåƒæ„å»º&lt;/li&gt;
&lt;li&gt;dockeré•œåƒæ–‡ä»¶é‡Œæœ‰å±‚çº§æ¦‚å¿µ,æ¯æ‰§è¡Œä¸€æ¬¡RUNæŒ‡ä»¤,é•œåƒå°±ä¼šå¤šä¸€å±‚,æ‰€ä»¥é€šè¿‡å‡å°‘å±‚çº§æ¥å‡å°‘é•œåƒå¤§å°&lt;/li&gt;
&lt;li&gt;å¤šä¸ªfromçš„æ—¶å€™,åªæœ‰æœ€åä¸€ä¸ªfromçš„é•œåƒæ‰æ˜¯é•œåƒçš„æ ¹é•œåƒ&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;è‡ªå·±é¡¹ç›®éƒ¨ç½²ä¸­å¤šé˜¶æ®µæ„å»ºç¤ºä¾‹, è¿™é‡ŒåŸºäºgolangåŸºç¡€é•œåƒç¼–è¯‘ä»¥åçš„äºŒè¿›åˆ¶ç›´æ¥copyåˆ°åŸºäºalpineæ„å»ºçš„æœ€å°é•œåƒé‡Œ:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;FROM golang:1.12.7 as build
MAINTAINER wanzi &amp;lt;iwz2099@163.com&amp;gt;
 
# ç¼–è¯‘é…ç½®ç›¸å…³
ARG NAME=gaia
ARG FLAGS=-tags=jsoniter
ARG GOOS=linux
ARG GOARCH=amd64
ARG PORT_TO_EXPOSE=10020
 
ENV GOPROXY https://mirrors.aliyun.com/goproxy/
ENV GO111MODULE on
 
WORKDIR /opt/gaia
COPY . .
RUN GOOS=$GOOS GOARCH=$GOARCH go build -mod vendor -ldflags=&amp;quot;-s -w&amp;quot; -o $NAME $FLAGS
 
FROM alpine
WORKDIR /opt/gaia
COPY --from=build /opt/gaia/gaia .
RUN mkdir -p /opt/gaia/conf
VOLUME [&amp;quot;/opt/gaia/conf&amp;quot;]
 
CMD [&amp;quot;./gaia&amp;quot;]
EXPOSE $PORT_TO_EXPOSE
&lt;/code&gt;&lt;/pre&gt;</description>
      
    </item>
    
    <item>
      <title>Dockerfileè¯­æ³•è¯¦æƒ…</title>
      <link>https://wnote.com/post/docker-dockerfile-details/</link>
      <pubDate>Thu, 21 Jun 2018 16:22:42 +0800</pubDate>
      
      <guid>https://wnote.com/post/docker-dockerfile-details/</guid>
      
        <description>&lt;h2 id=&#34;from&#34;&gt;FROM&lt;/h2&gt;
&lt;p&gt;æŒ‡å®šæ„å»ºé•œåƒä½¿ç”¨çš„åŸºç¡€é•œåƒ,FROMå¿…é¡»æ˜¯Dockerfileä¸­éæ³¨é‡Šè¡Œçš„ç¬¬ä¸€ä¸ªæŒ‡ä»¤,å¦‚æœæœ¬åœ°æ²¡æœ‰æŒ‡å®šçš„é•œåƒï¼Œåˆ™ä¼šè‡ªåŠ¨ä»Dockerçš„å…¬å…±åº“pullé•œåƒä¸‹æ¥ã€‚
ä¾‹å­ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;FROM ubuntu:14.04  #ç»§æ‰¿ubuntu:14.04
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;maintainer&#34;&gt;MAINTAINER&lt;/h2&gt;
&lt;p&gt;æŒ‡å®šåˆ›å»ºè€…ä¿¡æ¯&lt;/p&gt;
&lt;p&gt;MAINTAINER wanzi &amp;ldquo;&lt;a href=&#34;mailto:iwz2099@163.com&#34;&gt;iwz2099@163.com&lt;/a&gt;&amp;rdquo;&lt;/p&gt;
&lt;h2 id=&#34;env&#34;&gt;ENV&lt;/h2&gt;
&lt;p&gt;è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œä¼šè¢«åç»­ RUN æŒ‡ä»¤ä½¿ç”¨ï¼Œå¹¶åœ¨å®¹å™¨è¿è¡Œæ—¶ä¿æŒã€‚
ENV &lt;key&gt; &lt;value&gt;       # åªèƒ½è®¾ç½®ä¸€ä¸ªå˜é‡
ENV &lt;key&gt;=&lt;value&gt; &amp;hellip;   # å…è®¸ä¸€æ¬¡è®¾ç½®å¤šä¸ªå˜é‡
ä¾‹å­ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;ENV LANG en_US.UTF-8
ENV LANG=en_US.UTF-8 LC_ALL=en_US.UTF-8
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;run&#34;&gt;RUN&lt;/h2&gt;
&lt;p&gt;RUN &lt;command&gt; æˆ– RUN [&amp;ldquo;executable&amp;rdquo;, &amp;ldquo;param1&amp;rdquo;, &amp;ldquo;param2&amp;rdquo;]ã€‚
ä¾‹å­ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;RUN yum -y install bind-utils
RUN [&amp;quot;/bin/bash&amp;quot;, &amp;quot;-c&amp;quot;, &amp;quot;yum -y install bind-utils&amp;quot;]
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;å‰è€…å°†åœ¨shellç»ˆç«¯ä¸­è¿è¡Œå‘½ä»¤,å³ /bin/sh -c yum -y install bind-utilsï¼›åè€…åˆ™ä½¿ç”¨execæ‰§è¡Œã€‚æŒ‡å®šä½¿ç”¨å…¶å®ƒç»ˆç«¯å¯ä»¥é€šè¿‡ç¬¬äºŒç§æ–¹å¼å®ç°ã€‚
æ¯æ¡RUNæŒ‡ä»¤å°†åœ¨å½“å‰é•œåƒåŸºç¡€ä¸Šæ‰§è¡ŒæŒ‡å®šå‘½ä»¤ï¼Œå¹¶æäº¤ä¸ºæ–°çš„é•œåƒï¼Œåç»­çš„RUNéƒ½åœ¨ä¹‹å‰RUNæäº¤åçš„é•œåƒä¸ºåŸºç¡€ï¼Œé•œåƒæ˜¯åˆ†å±‚çš„ï¼Œå¯ä»¥é€šè¿‡ä¸€ä¸ªé•œåƒçš„ä»»ä½•ä¸€ä¸ªå†å²æäº¤ç‚¹æ¥åˆ›å»ºï¼Œç±»ä¼¼æºç çš„ç‰ˆæœ¬æ§åˆ¶ã€‚å½“å‘½ä»¤è¾ƒé•¿æ—¶å¯ä»¥ä½¿ç”¨ \ æ¥æ¢è¡Œã€‚&lt;/p&gt;
&lt;h2 id=&#34;copy&#34;&gt;COPY:&lt;/h2&gt;
&lt;p&gt;COPY &lt;src&gt; &lt;dest&gt;
ä¾‹å­ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;COPY script/ /build/script/
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;å¤åˆ¶æœ¬åœ°ä¸»æœºçš„&lt;src&gt;ï¼ˆä¸ºDockerfileæ‰€åœ¨ç›®å½•çš„ç›¸å¯¹è·¯å¾„ï¼‰åˆ°å®¹å™¨ä¸­çš„ &lt;dest&gt;,å½“ä½¿ç”¨æœ¬åœ°ç›®å½•ä¸ºæºç›®å½•æ—¶ï¼Œæ¨èä½¿ç”¨ COPYã€‚&lt;/p&gt;
&lt;h2 id=&#34;add&#34;&gt;ADD&lt;/h2&gt;
&lt;p&gt;ADD &lt;src&gt; &lt;dest&gt;
ä¾‹å­ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;ADD https://www.baidu.com/index.html   /var/www/html/
ADD ubuntu-xenial-core-cloudimg-amd64-root.tar.gz /
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;è¯¥å‘½ä»¤å°†å¤åˆ¶æŒ‡å®šçš„ &lt;src&gt; åˆ°å®¹å™¨ä¸­çš„ &lt;dest&gt;ã€‚ å…¶ä¸­&lt;src&gt;å¯ä»¥æ˜¯Dockerfileæ‰€åœ¨ç›®å½•çš„ä¸€ä¸ªç›¸å¯¹è·¯å¾„ï¼›ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ª URL(è‡ªåŠ¨ä¸‹è½½åå¤åˆ¶åˆ°å®¹å™¨)ï¼›è¿˜å¯ä»¥æ˜¯ä¸€ä¸ªtaræ–‡ä»¶ï¼ˆè‡ªåŠ¨è§£å‹ä¸ºç›®å½•ï¼‰ã€‚&lt;/p&gt;
&lt;h2 id=&#34;volume&#34;&gt;VOLUME&lt;/h2&gt;
&lt;pre&gt;&lt;code&gt;VOLUME [ &amp;quot;/data&amp;quot; ]
VOLUME [ &amp;quot;/var/lib/redis&amp;quot;, &amp;quot;/var/log/redis&amp;quot; ]
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;å£°æ˜ä¸€ä¸ªæ•°æ®å·, å¯ç”¨äºæŒ‚è½½, []é‡Œé¢æ˜¯è·¯å¾„ï¼Œåˆ›å»ºä¸€ä¸ªå¯ä»¥ä»æœ¬åœ°ä¸»æœºæˆ–å…¶ä»–å®¹å™¨æŒ‚è½½çš„æŒ‚è½½ç‚¹ï¼Œä¸€èˆ¬ç”¨æ¥å­˜æ”¾æ•°æ®åº“å’Œéœ€è¦ä¿æŒçš„æ•°æ®ç­‰ã€‚&lt;/p&gt;
&lt;h2 id=&#34;user&#34;&gt;USER&lt;/h2&gt;
&lt;p&gt;USER &lt;uid&gt;
é•œåƒæ­£åœ¨è¿è¡Œæ—¶è®¾ç½®çš„ä¸€ä¸ªUID,RUNå‘½ä»¤æ‰§è¡Œæ—¶çš„ç”¨æˆ·&lt;/p&gt;
&lt;h2 id=&#34;cmd&#34;&gt;CMD&lt;/h2&gt;
&lt;p&gt;æ”¯æŒä¸‰ç§æ ¼å¼
CMD [&amp;ldquo;executable&amp;rdquo;,&amp;ldquo;param1&amp;rdquo;,&amp;ldquo;param2&amp;rdquo;] ä½¿ç”¨ exec æ‰§è¡Œï¼Œæ¨èæ–¹å¼ï¼›
CMD command param1 param2 åœ¨ /bin/sh ä¸­æ‰§è¡Œï¼Œæä¾›ç»™éœ€è¦äº¤äº’çš„åº”ç”¨ï¼›
CMD [&amp;ldquo;param1&amp;rdquo;,&amp;ldquo;param2&amp;rdquo;] æä¾›ç»™ ENTRYPOINT çš„é»˜è®¤å‚æ•°ï¼›
æŒ‡å®šå¯åŠ¨å®¹å™¨æ—¶æ‰§è¡Œçš„å‘½ä»¤ï¼Œæ¯ä¸ª Dockerfile åªèƒ½æœ‰ä¸€æ¡ CMD å‘½ä»¤ã€‚å¦‚æœæŒ‡å®šäº†å¤šæ¡å‘½ä»¤ï¼Œåªæœ‰æœ€åä¸€æ¡ä¼šè¢«æ‰§è¡Œã€‚&lt;/p&gt;
&lt;h2 id=&#34;workdir&#34;&gt;WORKDIR&lt;/h2&gt;
&lt;p&gt;æŒ‡å®šRUNã€CMDä¸ENTRYPOINTå‘½ä»¤çš„å·¥ä½œç›®å½•
ä¾‹å­:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;WORKDIR /opt/nodeapp
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;onbuild&#34;&gt;ONBUILD&lt;/h2&gt;
&lt;p&gt;ONBUILD [INSTRUCTION]
é…ç½®å½“æ‰€åˆ›å»ºçš„é•œåƒä½œä¸ºå…¶å®ƒæ–°åˆ›å»ºé•œåƒçš„åŸºç¡€é•œåƒæ—¶ï¼Œæ‰€æ‰§è¡Œçš„æ“ä½œæŒ‡ä»¤ã€‚&lt;/p&gt;
&lt;p&gt;ä¾‹å¦‚:Dockerfileä½¿ç”¨å¦‚ä¸‹çš„å†…å®¹åˆ›å»ºäº†é•œåƒimage-Aã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;ONBUILD ADD . /app/src
ONBUILD RUN /usr/local/bin/python-build --dir /app/src
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;ä¾‹å¦‚:å¦‚æœåŸºäº image-A åˆ›å»ºæ–°çš„é•œåƒæ—¶ï¼Œæ–°çš„Dockerfileä¸­ä½¿ç”¨ FROM image-AæŒ‡å®šåŸºç¡€é•œåƒæ—¶ï¼Œä¼šè‡ªåŠ¨æ‰§è¡Œ ONBUILD æŒ‡ä»¤å†…å®¹ï¼Œç­‰ä»·äºåœ¨åé¢æ·»åŠ äº†ä¸¤æ¡æŒ‡ä»¤ã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;FROM image-A
#Automatically run the following
ADD . /app/src
RUN /usr/local/bin/python-build --dir /app/src
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;ä½¿ç”¨ ONBUILD æŒ‡ä»¤çš„é•œåƒï¼Œæ¨èåœ¨æ ‡ç­¾ä¸­æ³¨æ˜ï¼Œä¾‹å¦‚ ruby:1.9-onbuildã€‚&lt;/p&gt;
&lt;h2 id=&#34;entrypoint&#34;&gt;ENTRYPOINT&lt;/h2&gt;
&lt;p&gt;é…ç½®å®¹å™¨å¯åŠ¨åæ‰§è¡Œçš„å‘½ä»¤ï¼Œå¹¶ä¸”ä¸å¯è¢«docker runæä¾›çš„å‚æ•°è¦†ç›–ï¼Œè€ŒCMDæ˜¯å¯ä»¥è¢«è¦†ç›–çš„ã€‚å¦‚æœéœ€è¦è¦†ç›–ï¼Œåˆ™å¯ä»¥ä½¿ç”¨docker run &amp;ndash;entrypointé€‰é¡¹ã€‚æ¯ä¸ªDockerfileä¸­åªèƒ½æœ‰ä¸€ä¸ªENTRYPOINTï¼Œå½“æŒ‡å®šå¤šä¸ªæ—¶ï¼Œåªæœ‰æœ€åä¸€ä¸ªç”Ÿæ•ˆã€‚
æ”¯æŒä¸¤ç§æ ¼å¼
ENTRYPOINT [ &amp;ldquo;nodejs&amp;rdquo;, &amp;ldquo;server.js&amp;rdquo; ]
ENTRYPOINT command param1 param2ï¼ˆshellä¸­æ‰§è¡Œï¼‰&lt;/p&gt;
&lt;h2 id=&#34;expose&#34;&gt;EXPOSE&lt;/h2&gt;
&lt;p&gt;EXPOSE &lt;port&gt;
å‘ŠçŸ¥æœåŠ¡å™¨å®¹å™¨åœ¨è¿è¡Œæ—¶ç›‘å¬çš„ç«¯å£,åœ¨å¯åŠ¨å®¹å™¨æ—¶éœ€è¦é€šè¿‡ -Pï¼ŒDocker ä¸»æœºä¼šè‡ªåŠ¨åˆ†é…ä¸€ä¸ªç«¯å£è½¬å‘åˆ°æŒ‡å®šçš„ç«¯å£ã€‚
ä¾‹å­ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;EXPOSE 3000
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;æ³¨æ„äº‹é¡¹&#34;&gt;æ³¨æ„äº‹é¡¹&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;å°½é‡ç²¾ç®€,ä¸å®‰è£…å¤šä½™çš„è½¯ä»¶åŒ…&lt;/li&gt;
&lt;li&gt;ç¼–å†™.dockerignore æ–‡ä»¶,æ’é™¤ä¸€äº›ç›®å½•å’Œæ–‡ä»¶,è¯­æ³•ç±»ä¼¼äº.gitignore&lt;/li&gt;
&lt;li&gt;å°½é‡é€‰æ‹© Dockerå®˜æ–¹æä¾›é•œåƒä½œä¸ºåŸºç¡€ç‰ˆæœ¬,å‡å°‘é•œåƒä½“ç§¯.&lt;/li&gt;
&lt;li&gt;Dockerfileå¼€å¤´å‡ è¡Œçš„æŒ‡ä»¤åº”å½“å›ºå®šä¸‹æ¥,ä¸å»ºè®®é¢‘ç¹æ›´æ”¹,æœ‰æ•ˆåˆ©ç”¨ç¼“å­˜.&lt;/li&gt;
&lt;li&gt;å¤šæ¡RUNå‘½ä»¤ä½¿ç”¨&amp;rsquo;&#39;è¿æ¥,æœ‰åˆ©äºç†è§£ä¸”æ–¹ä¾¿ç»´æŠ¤.&lt;/li&gt;
&lt;li&gt;COPYä¸ADDä¼˜å…ˆä½¿ç”¨å‰è€…&lt;/li&gt;
&lt;li&gt;é€šè¿‡-tæ ‡è®°æ„å»ºé•œåƒ,æœ‰åˆ©äºç®¡ç†æ–°åˆ›å»ºçš„é•œåƒ.&lt;/li&gt;
&lt;li&gt;ä¸åœ¨Dockerfileä¸­æ˜ å°„å…¬æœ‰ç«¯å£.&lt;/li&gt;
&lt;li&gt;Pushå‰å…ˆåœ¨æœ¬åœ°è¿è¡Œ,ç¡®ä¿æ„å»ºçš„é•œåƒæ— è¯¯.&lt;/li&gt;
&lt;/ul&gt;
</description>
      
    </item>
    
  </channel>
</rss>
